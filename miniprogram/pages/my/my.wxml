<!-- pages/my/my.wxml -->
<wxs module="tools">
  module.exports.firstChar = function(str) {
    if (!str || str.length === 0) return 'å¿«';
    return str.substring(0, 1);
  }
</wxs>

<view class="container {{hasModalOpen ? 'modal-open' : ''}}">

  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <view class="header">
    <view class="back-icon" catchtap="goBack">
      <text class="back-arrow">â€¹</text>
    </view>
    <view class="admin-toggle-wrapper" wx:if="{{isAuthorized}}">
      <view class="admin-toggle-btn {{isAdmin ? 'on' : ''}}" catchtap="toggleAdminMode">
        {{isAdmin ? 'ADMIN' : 'EDIT'}}
      </view>
    </view>
  </view>

  <!-- 2. ç”¨æˆ·ä¸ªäººä¿¡æ¯ - ã€ç®¡ç†å‘˜æ¨¡å¼ä¸‹éšè—ã€‘ -->
  <view class="profile-header" wx:if="{{!isAdmin}}">
    <view class="header-content">
      <view class="user-identity">
        <text class="rank-tag">PLATINUM MEMBER</text>
        <text class="user-name" style="font-size: {{userNameFontSize}}rpx;">{{userName}}</text>
      </view>
      <view class="header-stats">
        <view class="stat-item">
          <text class="label">æ‹¥æœ‰äº§å“æ•°é‡</text>
          <text class="value">{{deviceList.length}} ä»¶</text>
        </view>
        <view class="divider-v"></view>
        <view class="stat-item">
          <text class="label">ä¼šå‘˜ç­‰çº§</text>
          <text class="value platinum">é“‚é‡‘å°Šäº«ä¼šå‘˜</text>
        </view>
      </view>
    </view>
  </view>

  <!-- === ã€æ ¸å¿ƒä¿®æ”¹åŒºåŸŸï¼šç®¡ç†å‘˜ç•Œé¢ã€‘ === -->
  <block wx:if="{{isAdmin}}">
    
    <!-- 1. æ ‡é¢˜æ  + åˆ‡æ¢æŒ‰é’® -->
    <view class="admin-header-row">
      <view class="admin-page-title">
        å¾…å¤„ç†è®¢å•
      </view>
      
      <view class="admin-header-right">
        <!-- éœ€å¯„å›è®¢å•ç¡®è®¤æŒ‰é’® -->
        <view class="return-required-btn" bindtap="openReturnRequiredModal">
          éœ€å¯„å›è®¢å•ç¡®è®¤
        </view>
        <!-- æµ‹è¯•æŒ‰é’® -->
        <view class="test-btn" bindtap="openTestPasswordModal">
          æµ‹è¯•æŒ‰é’®
        </view>
      </view>
    </view>

    <!-- 2. å¾…ç‰©æ–™å‘å‡º (æ¨ªå‘ Swiper) -->
    <swiper 
      class="order-swiper" 
      bindchange="onOrderChange" 
      circular 
      previous-margin="60rpx" 
      next-margin="60rpx"
      style="height: {{swiperHeight}}px; transition: height 0.3s ease;"
    >
      <!-- å¦‚æœæ²¡æœ‰å¾…ç‰©æ–™å‘å‡ºè®¢å• -->
      <swiper-item wx:if="{{pendingList.length === 0}}">
        <view class="empty-card">ğŸ‰ å¤ªæ£’äº†ï¼Œæ‰€æœ‰è®¢å•éƒ½å·²ç‰©æ–™å‘å‡ºï¼</view>
      </swiper-item>

      <!-- å¾ªç¯ pendingList -->
      <swiper-item wx:for="{{pendingList}}" wx:key="id" wx:for-index="idx">
        <view class="order-card detail-mode" id="card-{{idx}}">
          
          <!-- 1. å¤´éƒ¨ï¼šä¿®å¤ä½ç½®ä¸å¯¹çš„é—®é¢˜ -->
          <view class="card-header">
            <view class="order-id-group">
              <text class="order-label">è®¢å•å·</text>
              <text class="order-val">{{item.orderId}}</text>
            </view>
            <view class="status-tag {{item.realStatus}}">{{item.statusText}}</view>
          </view>

          <!-- ã€å…³é”®ã€‘ä¹°å®¶ä¿¡æ¯æ ï¼šæ˜¾ç¤ºæ˜µç§°ã€ç”µè¯ã€åœ°å€ -->
          <view class="buyer-info-box">
            <view class="b-row">
              <text class="b-name" style="font-size: {{item.userNameFontSize || 30}}rpx;">{{item.userName || 'åŒ¿åç”¨æˆ·'}}</text>
              <text class="b-phone">{{item.userPhone}}</text>
            </view>
            <!-- ğŸ”´ æ˜¾ç¤ºç”¨æˆ·æ˜µç§°ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰ -->
            <view class="b-nickname-row" wx:if="{{isAdmin && item.userNickname}}">
              <text class="b-nickname-label">ç”¨æˆ·æ˜µç§°ï¼š</text>
              <text class="b-nickname">{{item.userNickname}}</text>
            </view>
            <view class="b-addr-row">
              <text class="b-addr">{{item.userAddr}}</text>
              <view class="b-copy-btn" wx:if="{{isAdmin}}" bindtap="copyOrderAddress" data-index="{{idx}}" data-address="{{item.userAddr}}" data-name="{{item.userName}}" data-phone="{{item.userPhone}}">
                <text class="b-copy-text">å¤åˆ¶</text>
              </view>
            </view>
          </view>

          <!-- 2. ä¸­é—´å•†å“åˆ—è¡¨ -->
          <view class="goods-detail-list">
            <view class="mini-tag">è´­ç‰©æ¸…å•</view>
            <block wx:for="{{item.goodsList}}" wx:for-item="g" wx:key="index">
              <view class="g-item">
                <view class="g-info">
                  <text class="g-n">{{g.name}}</text>
                  <text class="g-s">{{g.spec}}</text>
                </view>
                <view class="g-count">x{{g.quantity}}</view>
                <view class="g-p">Â¥{{g.total}}</view>
              </view>
            </block>
          </view>

          <!-- 3. åº•éƒ¨ï¼šåˆè®¡ + æ“ä½œæŒ‰é’® -->
          <view class="card-footer-new">
            <view class="total-row">
              <text class="time-text">{{item.createTime}}</text>
              <view class="price-box">
                <text>å®ä»˜</text> 
                <!-- ã€ä¿®æ”¹ã€‘ç»™é‡‘é¢åŠ ä¸Šç‚¹å‡»äº‹ä»¶ï¼ˆç®¡ç†å‘˜å¾…ç‰©æ–™å‘å‡ºä¹Ÿå¯ä»¥æ”¹ä»·ï¼‰ -->
                <text 
                  class="price-num {{isAdmin && item.realStatus === 'PAID' ? 'editable-price' : ''}}" 
                  catchtap="adminModifyPrice" 
                  data-id="{{item.id}}" 
                  data-price="{{item.amount}}"
                  data-status="{{item.realStatus}}">
                  Â¥{{item.amount}}
                </text>
              </view>
            </view>
            <view 
              class="admin-ship-btn" 
              catchtap="adminShipOrder" 
              data-id="{{item.id}}" 
              data-orderid="{{item.orderId}}" 
              data-express="{{item.shippingMethod}}">
              å½•å…¥è¿å•å·å¹¶ç‰©æ–™å‘å‡º
            </view>
          </view>
        </view>
      </swiper-item>
    </swiper>

    <!-- [æ–°å¢] ç»´ä¿®å·¥å•å¤„ç†åŒº -->
    <view class="section-label repair-section-label" wx:if="{{repairList.length > 0}}">PENDING REPAIRS / å¾…å¤„ç†æŠ¥ä¿®</view>
    
    <view class="repair-list-admin">
      <block wx:for="{{repairList}}" wx:key="_id">
        <view class="repair-admin-card">
          <!-- è§†é¢‘é¢„è§ˆ -->
          <video src="{{item.videoFileID}}" class="repair-video" controls></video>
          
          <!-- ä¿¡æ¯ -->
          <view class="repair-info">
            <view class="r-title">{{item.model}} - {{item.contact.name}}</view>
            <view class="r-desc">"{{item.description}}"</view>
            <view class="r-addr">{{item.contact.address}}</view>
            <!-- ğŸ”´ æ–°å¢ï¼šè´¨ä¿çŠ¶æ€æ˜¾ç¤ºï¼Œæ— è´¨ä¿æ—¶æ˜¾ç¤ºã€Œç”¨æˆ·è´¨ä¿å·²è¿‡æœŸã€ -->
            <view class="r-warranty-status" wx:if="{{item.warrantyExpired || item.remainingDays === 0}}">
              <text class="warranty-expired-tag">ç”¨æˆ·è´¨ä¿å·²è¿‡æœŸ</text>
              <text class="warranty-expired-info" wx:if="{{item.expiryDate}}">åˆ°æœŸæ—¥ï¼š{{item.expiryDate}}</text>
            </view>
            <view class="r-warranty-status" wx:elif="{{item.remainingDays !== undefined && item.remainingDays > 0}}">
              <text class="warranty-normal-tag">å‰©ä½™è´¨ä¿ï¼š{{item.remainingDays}}å¤©</text>
            </view>
          </view>
          
          <!-- éœ€è¦å¯„å›å¼€å…³ -->
          <view class="repair-return-switch">
            <text class="switch-label">éœ€è¦å¯„å›</text>
            <switch 
              checked="{{item.needReturn}}" 
              bindchange="toggleReturnRequired" 
              data-id="{{item._id}}"
              color="#007AFF"
            />
          </view>
          
          <!-- çŠ¶æ€æ˜¾ç¤º -->
          <view class="repair-status-info" wx:if="{{item.returnStatus === 'USER_SENT' || item.status === 'USER_SENT'}}">
            <text class="repair-status-text">ç”¨æˆ·å·²å¯„å‡ºå¿«é€’</text>
            <text class="repair-tracking-id" wx:if="{{item.returnTrackingId}}">è¿å•å·ï¼š{{item.returnTrackingId}}</text>
          </view>
          
          <!-- æ“ä½œæŒ‰é’® -->
          <view class="repair-actions">
            <!-- å¦‚æœç”¨æˆ·å·²å¯„å‡ºï¼Œæ˜¾ç¤ºç»´ä¿®å®ŒæˆæŒ‰é’® -->
            <view class="r-btn complete" wx:if="{{item.returnStatus === 'USER_SENT' || item.status === 'USER_SENT'}}" bindtap="adminCompleteRepair" data-id="{{item._id}}">ç»´ä¿®å®Œæˆ</view>
            <!-- å¦‚æœç»´ä¿®å®Œæˆå·²å¯„å‡ºï¼Œæ˜¾ç¤ºçŠ¶æ€ -->
            <view class="repair-status-info" wx:if="{{item.status === 'REPAIR_COMPLETED_SENT'}}">
              <text class="repair-status-text">ç»´ä¿®å®Œæˆå·²å¯„å‡º</text>
              <text class="repair-tracking-id" wx:if="{{item.trackingId}}">è¿å•å·ï¼š{{item.trackingId}}</text>
            </view>
            <!-- å…¶ä»–çŠ¶æ€ï¼šä¸»æŒ‰é’® + æ¬¡è¦æ“ä½œï¼ˆç«–å‘æ’åˆ—ï¼Œä¾¿äºç‚¹å‡»ï¼‰ -->
            <block wx:if="{{item.returnStatus !== 'USER_SENT' && item.status !== 'USER_SENT' && item.status !== 'REPAIR_COMPLETED_SENT'}}">
              <view class="repair-actions-primary">
                <view class="r-btn return" bindtap="requestUserReturn" data-id="{{item._id}}">éœ€è¦ç”¨æˆ·å¯„å›</view>
              </view>
              <view class="repair-actions-secondary">
                <view class="r-btn purchase" bindtap="openPurchasePartsModal" data-item="{{item}}">è¯·è´­ä¹°é…ä»¶</view>
                <view class="r-btn tutorial" bindtap="resolveRepair" data-id="{{item._id}}" data-type="tutorial">çœ‹æ•™ç¨‹å¯ä¿®</view>
                <view class="r-btn ship" bindtap="resolveRepair" data-id="{{item._id}}" data-type="ship">å½•å•å¤‡ä»¶å¯„å‡º</view>
              </view>
            </block>
          </view>
        </view>
      </block>
    </view>


  </block>

  <!-- æ™®é€šç”¨æˆ·è§†å›¾ (ä¿æŒä¸å˜ï¼Œè¿˜æ˜¯ç”¨åŸæ¥çš„ swiper orders) -->
  <block wx:if="{{!isAdmin}}">
    <!-- æƒ…å†µ A: æœ‰è®¢å•ï¼Œæ˜¾ç¤ºæ»‘åŠ¨åˆ—è¡¨ -->
    <swiper 
      wx:if="{{orders.length > 0}}"
      class="order-swiper" 
      bindchange="onOrderChange" 
      circular 
      previous-margin="60rpx" 
      next-margin="60rpx"
      style="height: {{swiperHeight}}px; transition: height 0.3s ease;"
    >
      <swiper-item wx:for="{{orders}}" wx:key="id" wx:for-index="idx">
        <view class="order-card detail-mode" id="card-{{idx}}">
          
          <!-- 1. å¤´éƒ¨ -->
          <view class="card-header">
            <view class="order-id-group">
              <text class="order-label">è®¢å•å·</text>
              <text class="order-val">{{item.orderId}}</text>
            </view>
            <view class="status-tag {{item.realStatus}}">{{item.statusText}}</view>
          </view>

          <!-- ä¹°å®¶ä¿¡æ¯æ  -->
          <view class="buyer-info-box">
            <view class="b-row">
              <text class="b-name" style="font-size: {{item.userNameFontSize || 30}}rpx;">{{item.userName || 'åŒ¿åç”¨æˆ·'}}</text>
              <text class="b-phone">{{item.userPhone}}</text>
            </view>
            <!-- ğŸ”´ æ˜¾ç¤ºç”¨æˆ·æ˜µç§°ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰ -->
            <view class="b-nickname-row" wx:if="{{isAdmin && item.userNickname}}">
              <text class="b-nickname-label">ç”¨æˆ·æ˜µç§°ï¼š</text>
              <text class="b-nickname">{{item.userNickname}}</text>
            </view>
            <view class="b-addr-row">
              <text class="b-addr">{{item.userAddr}}</text>
              <view class="b-copy-btn" wx:if="{{isAdmin}}" bindtap="copyOrderAddress" data-index="{{idx}}" data-address="{{item.userAddr}}" data-name="{{item.userName}}" data-phone="{{item.userPhone}}">
                <text class="b-copy-text">å¤åˆ¶</text>
              </view>
            </view>
          </view>

          <!-- å•†å“åˆ—è¡¨ -->
          <view class="goods-detail-list">
            <view class="mini-tag">è´­ç‰©æ¸…å•</view>
            <block wx:for="{{item.goodsList}}" wx:for-item="g" wx:key="index">
              <view class="g-item">
                <view class="g-info">
                  <text class="g-n">{{g.name}}</text>
                  <text class="g-s">{{g.spec}}</text>
                </view>
                <view class="g-count">x{{g.quantity}}</view>
                <view class="g-p">Â¥{{g.total}}</view>
              </view>
            </block>
          </view>

          <!-- åº•éƒ¨ -->
          <view class="card-footer-new">
            <view class="total-row">
              <text class="time-text">{{item.createTime}}</text>
              <view class="price-box">
                <text>å®ä»˜</text> 
                <!-- ã€ä¿®æ”¹ã€‘ç»™é‡‘é¢åŠ ä¸Šç‚¹å‡»äº‹ä»¶ -->
                <!-- å¢åŠ ä¸€ä¸ª editable-price ç±»åï¼Œå¦‚æœæ˜¯ç®¡ç†å‘˜ä¸”æœªæ”¯ä»˜ï¼Œæ˜¾ç¤ºè™šçº¿æç¤ºå¯ç‚¹ -->
                <text 
                  class="price-num {{isAdmin && item.realStatus === 'UNPAID' ? 'editable-price' : ''}}" 
                  catchtap="adminModifyPrice" 
                  data-id="{{item.id}}" 
                  data-price="{{item.amount}}"
                  data-status="{{item.realStatus}}">
                  Â¥{{item.amount}}
                </text>
              </view>
            </view>

            <!-- 1. å¾…ä»˜æ¬¾ï¼šæ˜¾ç¤ºæ“ä½œæŒ‰é’® -->
            <view wx:if="{{item.realStatus === 'UNPAID'}}" class="action-row-right">
              
              <!-- ã€æ–°å¢ã€‘å·¦ä¾§çš„å–æ¶ˆè®¢å•æŒ‰é’® -->
              <view class="btn-mini outline-red" catchtap="userCancelOrder" data-id="{{item.id}}">
                å–æ¶ˆè®¢å•
              </view>

              <!-- å³ä¾§çš„æ”¯ä»˜æŒ‰é’® -->
              <view class="btn-mini black" catchtap="repayOrder" data-item="{{item}}">
                ç«‹å³æ”¯ä»˜
              </view>
              
            </view>

            <!-- 3. è¿è¾“ä¸­ï¼šæŸ¥çœ‹ç‰©æµ + æŸ¥çœ‹å”®åæ•™ç¨‹ï¼ˆå…ˆç¡®è®¤æ”¶è´§å†è·³å”®åé¡µå¹¶è‡ªåŠ¨è§£é”ï¼‰ -->
            <view wx:if="{{item.realStatus === 'SHIPPED'}}" class="action-row-right">
              <!-- å·¦ä¾§ï¼šæŸ¥çœ‹ç‰©æµ -->
              <view 
                class="btn-mini outline" 
                catchtap="viewLogisticsDetail" 
                data-sn="{{item.trackingId}}"
                data-phone="{{item.userPhone || ''}}">
                æŸ¥çœ‹ç‰©æµ
              </view>
              <!-- å³ä¾§ï¼šæŸ¥çœ‹å”®åæ•™ç¨‹ï¼ˆå¼¹å‡ºå®˜æ–¹ç¡®è®¤æ”¶è´§ï¼Œç¡®è®¤åè·³å”®åé¡µå¯¹åº”å‹å·å¹¶è‡ªåŠ¨è¾“å…¥å¯†ç  123456 è§£é”ï¼‰ -->
              <view 
                class="btn-mini black" 
                catchtap="viewTutorialAndSign" 
                data-id="{{item.id}}" 
                data-model="{{item.goodsList && item.goodsList[0] ? (item.goodsList[0].spec || item.goodsList[0].name) : ''}}"
                data-dest="shouhou">
                æŸ¥çœ‹å”®åæ•™ç¨‹
              </view>
            </view>

            <!-- 4. å·²å®Œæˆï¼šå®‰è£…æ•™ç¨‹æŸ¥çœ‹ç  + å›é¡¾æ•™ç¨‹ -->
            <view wx:if="{{item.realStatus === 'SIGNED'}}" class="action-row-right">
              <!-- å®‰è£…æ•™ç¨‹æŸ¥çœ‹ç æŒ‰é’®ï¼ˆå·¦ä¾§ï¼Œè¾¹æ¡†æ ·å¼ï¼‰ -->
              <view 
                class="btn-mini outline" 
                catchtap="generateShareCode" 
                data-id="{{item.id}}"
                data-orderid="{{item.orderId}}">
                å®‰è£…æ•™ç¨‹æŸ¥çœ‹ç 
              </view>
              <!-- å›é¡¾æ•™ç¨‹æŒ‰é’®ï¼ˆå³ä¾§ï¼Œé»‘åº•ç™½å­—ï¼‰ -->
              <view 
                class="btn-mini black" 
                catchtap="viewTutorialOnly">
                å›é¡¾æ•™ç¨‹
              </view>
            </view>

          </view>
        </view>
      </swiper-item>
    </swiper>

    <!-- æƒ…å†µ B: æ²¡è®¢å•ï¼Œæ˜¾ç¤ºè¯±å¯¼å¡ç‰‡æˆ–ç»´ä¿®å•å¡ç‰‡ -->
    <view wx:else>
      <!-- ğŸ”´ ä¼˜å…ˆæ˜¾ç¤ºç»´ä¿®å•å¡ç‰‡ï¼ˆå¦‚æœæœ‰éœ€è¦æ”¯ä»˜çš„ç»´ä¿®å•ï¼‰ -->
      <view 
        wx:if="{{myReturnRequiredRepair && myReturnRequiredRepair.repairItems && myReturnRequiredRepair.repairItems.length > 0 && myReturnRequiredRepair.repairPaid === false}}"
        class="return-required-card"
      >
        <!-- å¤´éƒ¨ï¼šæ ‡é¢˜å’ŒçŠ¶æ€æ ‡ç­¾ -->
        <view class="rr-card-header">
          <view class="rr-card-title">{{myReturnRequiredRepair.returnStatus === 'PENDING_RETURN' ? 'éœ€å¯„å›é…ä»¶ç»´ä¿®' : 'éœ€å¯„å›æ•…éšœé…ä»¶'}}</view>
          <view class="rr-card-tag pending">å¾…å¤„ç†</view>
        </view>
        
        <!-- ä¸»ä½“å†…å®¹ -->
        <view class="rr-card-body">
          <!-- åŸºæœ¬ä¿¡æ¯ -->
          <view class="rr-info-row">
            <text class="rr-label">äº§å“å‹å·</text>
            <text class="rr-value">{{myReturnRequiredRepair.model}}</text>
          </view>
          <view class="rr-info-row">
            <text class="rr-label">æŠ¥ä¿®æ—¶é—´</text>
            <text class="rr-value">{{myReturnRequiredRepair.createTime}}</text>
          </view>
          
          <!-- å¤‡æ³¨ä¿¡æ¯ -->
          <view class="rr-card-note" wx:if="{{myReturnRequiredRepair.returnNote}}">
            <view class="rr-card-note-label">å¤‡æ³¨ï¼š</view>
            <view class="rr-card-note-text">{{myReturnRequiredRepair.returnNote}}</view>
          </view>
          
          <!-- ç»´ä¿®è¯¦æƒ…è¡¨æ ¼ -->
          <view class="rr-repair-details" wx:if="{{myReturnRequiredRepair.repairItems && myReturnRequiredRepair.repairItems.length > 0}}">
            <view class="rr-repair-details-title">ç»´ä¿®è¯¦æƒ…</view>
            <view class="rr-repair-table">
              <view class="rr-table-header">
                <view class="rr-table-col-name">ç»´ä¿®é¡¹ç›®</view>
                <view class="rr-table-col-price">ä»·æ ¼</view>
              </view>
              <block wx:for="{{myReturnRequiredRepair.repairItems}}" wx:key="index">
                <view class="rr-table-row">
                  <view class="rr-table-col-name">{{item.name}}</view>
                  <view class="rr-table-col-price">Â¥{{item.price}}</view>
                </view>
              </block>
              <view class="rr-table-footer">
                <view class="rr-table-col-name">æ€»è®¡</view>
                <view class="rr-table-col-price total">Â¥{{myReturnRequiredRepair.repairTotalPrice || 0}}</view>
              </view>
            </view>
          </view>
          
          <!-- æ”¯ä»˜çŠ¶æ€å’ŒæŒ‰é’® -->
          <view class="rr-payment-section" wx:if="{{myReturnRequiredRepair.warrantyExpired === true || (myReturnRequiredRepair.repairItems && myReturnRequiredRepair.repairItems.length > 0 && myReturnRequiredRepair.repairTotalPrice > 0)}}">
            <view class="rr-payment-status-text" wx:if="{{myReturnRequiredRepair.repairPaid === true}}">
              <text class="rr-payment-paid">âœ“ å·²æ”¯ä»˜</text>
            </view>
            <view class="rr-payment-status-text" wx:else>
              <text class="rr-payment-unpaid">å¾…æ”¯ä»˜ï¼šÂ¥{{myReturnRequiredRepair.repairTotalPrice || 0}}</text>
              <view class="rr-payment-btn" bindtap="payRepairFee" data-id="{{myReturnRequiredRepair._id}}">ç«‹å³æ”¯ä»˜</view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- ğŸ”´ å¦‚æœæ²¡æœ‰ç»´ä¿®å•ï¼Œæ˜¾ç¤º"å»é€‰è´­å•†å“"å¡ç‰‡ -->
      <view 
        wx:else
        class="empty-order-card" 
        bindtap="goToShop"
      >
        <view class="empty-content">
          <view class="empty-icon">ğŸ“¦</view>
          <view class="empty-title">å¼€å¯æ‚¨çš„æ”¹è£…ä¹‹æ—…</view>
          <view class="empty-desc">ä¸‹å•åï¼Œæ­¤å¤„å°†å®æ—¶è¿½è¸ªæ‚¨çš„ç‰©æ–™è¿›åº¦</view>
          
          <view class="go-shop-btn">å»é€‰è´­å•†å“ â”</view>
        </view>
      </view>
    </view>
  </block>

  <!-- === æ”¹åŠ¨1ï¼šç®¡ç†å‘˜å®¡æ ¸åŒº (Swiperç‰ˆ) === -->
  <block wx:if="{{isAdmin && auditList.length > 0}}">
    <view class="section-label">PENDING AUDITS / å¾…å®¡æ ¸ç”³è¯·</view>
    
    <swiper 
      class="audit-swiper" 
      circular 
      previous-margin="60rpx" 
      next-margin="60rpx"
    >
      <swiper-item wx:for="{{auditList}}" wx:key="_id">
        <view class="audit-card">
          <view class="audit-row">
            <text class="audit-model">{{item.productModel}}</text>
            <text class="audit-sn">SN: {{item.sn}}</text>
          </view>
          <view class="audit-row">
            <!-- è¿™é‡Œåªåšå±•ç¤ºï¼Œä¿®æ”¹åœ¨å¼¹çª—é‡Œ -->
            <text class="audit-date">ç”¨æˆ·å¡«: {{item.buyDate}}</text>
            <text class="audit-type">{{item.bindType == 'new' ? 'å…¨æ–°' : 'äºŒæ‰‹'}}</text>
          </view>
          
          <view class="audit-imgs">
            <image src="{{item.imgReceipt}}" mode="aspectFill" class="audit-thumb" bindtap="previewImage" data-url="{{item.imgReceipt}}"></image>
            <image wx:if="{{item.imgChat}}" src="{{item.imgChat}}" mode="aspectFill" class="audit-thumb" bindtap="previewImage" data-url="{{item.imgChat}}"></image>
          </view>

          <view class="audit-actions">
            <!-- æ‹’ç»ç›´æ¥è°ƒç”¨ -->
            <view class="audit-btn reject" catchtap="handleReject" data-id="{{item._id}}">æ‹’ç»</view>
            <!-- é€šè¿‡æ‰“å¼€å¼¹çª— -->
            <view class="audit-btn approve" catchtap="openAuditModal" data-item="{{item}}">å®¡æ ¸è®¾ç½®</view>
          </view>
        </view>
      </swiper-item>
    </swiper>
  </block>

  <!-- 5. è®¾å¤‡åˆ—è¡¨ - ã€ç®¡ç†å‘˜æ¨¡å¼ä¸‹éšè—ã€‘ -->
  <block wx:if="{{!isAdmin}}">
    <view class="section-label">MY DEVICES / äº§å“è®¾å¤‡</view>
    <view class="device-card" wx:for="{{deviceList}}" wx:key="sn">
      <view class="remove-icon" bindtap="removeDevice" data-index="{{index}}">âœ•</view>
      <view class="device-name">{{item.name}}</view>
      <view class="spec-list">
        <view class="spec-row">
          <text class="label">S/N åºåˆ—å·</text>
          <text class="value mono">{{item.sn}}</text>
        </view>
        <view class="spec-row">
          <text class="label">æ€»å‰©ä½™è´¨ä¿</text>
          <view class="warranty-val">
            <!-- å‰©ä½™å¤©æ•°æˆ–å·²è¿‡æœŸ -->
            <text class="days-num {{item.days < 30 ? 'warning' : ''}} {{item.isExpired ? 'expired' : ''}}" wx:if="{{!item.isExpired}}">{{item.days}}å¤©</text>
            <text class="days-num expired" wx:if="{{item.isExpired}}">å·²è¿‡è´¨ä¿</text>
            
            <!-- ğŸ‘‡ğŸ‘‡ğŸ‘‡ [æ–°å¢] èµ é€è´¨ä¿æ ‡è®° ğŸ‘‡ğŸ‘‡ğŸ‘‡ -->
            <view class="reward-tag" wx:if="{{item.hasReward}}">
               <text>ğŸ å·²è·èµ 30å¤©</text>
            </view>
            <!-- ğŸ‘†ğŸ‘†ğŸ‘† åªæœ‰ hasReward ä¸º true æ—¶æ‰æ˜¾ç¤º ğŸ‘†ğŸ‘†ğŸ‘† -->
            
            <!-- åŸæœ‰çš„å»¶ä¿æ ‡è®° (å¦‚æœæœ‰) -->
            <text class="ext-tag" wx:if="{{item.hasExtra && !item.hasReward}}">å«å»¶ä¿</text>
          </view>
        </view>
        <view class="spec-row">
          <text class="label">è´¨ä¿åˆ°æœŸæ—¥æœŸ</text>
          <text class="value">{{item.expiryDate}}</text>
        </view>
        <view class="spec-row">
          <text class="label">æ¿€æ´»æ¬¡æ•°</text>
          <text class="value">{{item.activations}} æ¬¡</text>
        </view>
        <view class="spec-row">
          <text class="label">å›ºä»¶ç‰ˆæœ¬</text>
          <text class="value">{{item.firmware}}</text>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨æ·»åŠ è®¾å¤‡å¤§æŒ‰é’® -->
    <view class="device-card add-mode" bindtap="openBindModal">
      <view class="add-content">
        <text class="big-plus">+</text>
        <text class="add-tips">ç»‘å®šæ–°äº§å“</text>
      </view>
    </view>

    <!-- ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€æ ¸å¿ƒè¡¥å…¨ã€‘åœ¨è¿™é‡Œæ’å…¥ç”³è¯·è®°å½•åˆ—è¡¨ ğŸ‘‡ğŸ‘‡ğŸ‘‡ -->
    <!-- å¼•å…¥ WXS æ¨¡å—ç”¨äºåœ¨è§†å›¾å±‚å¤„ç†æ•°ç»„è½¬å­—ç¬¦ä¸² -->
    <wxs module="tools">
      var joinArr = function(arr) {
        if (arr && arr.length > 0) {
          return arr.join('ã€');
        }
        return '';
      }
      module.exports = {
        joinArr: joinArr
      };
    </wxs>

    <!-- ä»…éœ€è´­ä¹°é…ä»¶å¡ç‰‡ï¼ˆå¾…è´­ä¹°æ—¶æ˜¾ç¤ºï¼Œå®Œæˆåéšè—ï¼‰ -->
    <view class="pp-card-container" wx:if="{{myPurchasePartsRepair && !isAdmin && myPurchasePartsRepair.purchasePartsStatus !== 'completed'}}">
      <view class="pp-card">
        
        <!-- å¤´éƒ¨ï¼šæ ‡é¢˜ä¸çŠ¶æ€ -->
        <view class="pp-header">
          <view class="pp-title-group">
            <!-- çº¢è‰²åœ†åœˆå›¾æ ‡ -->
            <view class="pp-icon-box">!</view>
            <text class="pp-title-text">å¾…è´­é…ä»¶</text>
          </view>
          <!-- çŠ¶æ€æ ‡ç­¾ï¼šæ ¹æ®çŠ¶æ€å˜è‰²ï¼Œå®Œæˆæ€å˜ç»¿ï¼Œå¾…è´­ä¹°ä¿æŒé»„è‰² -->
          <view class="pp-status-tag {{myPurchasePartsRepair.purchasePartsStatus === 'completed' ? 'status-green' : ''}}">
            {{myPurchasePartsRepair.purchasePartsStatus === 'completed' ? 'å·²å®Œæˆ' : 'å¾…è´­ä¹°'}}
          </view>
        </view>

        <!-- ä¸­é—´å†…å®¹åŒºåŸŸ -->
        <view class="pp-content">
          <!-- å¾ªç¯åˆ—è¡¨ -->
          <block wx:for="{{myPurchasePartsRepair.purchasePartsList}}" wx:key="model">
            <view class="pp-item-group">
              <view class="pp-main-info">{{item.model}}</view>
              <view class="pp-parts-tags" wx:if="{{item.parts && item.parts.length}}">
                <view class="pp-part-tag" wx:for="{{item.parts}}" wx:for-item="part" wx:key="*this">{{part}}</view>
              </view>
            </view>
          </block>

          <!-- å¤‡æ³¨ä¿¡æ¯ -->
          <view class="pp-note-info" wx:if="{{myPurchasePartsRepair.purchasePartsNote}}">
            <text class="pp-note-label">å¤‡æ³¨ï¼š</text>
            <text class="pp-note-text">{{myPurchasePartsRepair.purchasePartsNote}}</text>
          </view>
        </view>

        <!-- åº•éƒ¨ Grid ä¿¡æ¯ (å¸¦åˆ†å‰²çº¿) -->
        <view class="pp-meta-grid">
          <view class="pp-meta-item">
            <text class="pp-label">äº§å“å‹å·</text>
            <text class="pp-meta-val">{{myPurchasePartsRepair.model}}</text>
          </view>
          <view class="pp-meta-item pp-align-right">
            <text class="pp-label">æŠ¥ä¿®æ—¶é—´</text>
            <text class="pp-meta-val time-font">{{myPurchasePartsRepair.createTime}}</text>
          </view>
        </view>

        <!-- åº•éƒ¨æŒ‰é’® -->
        <view class="pp-btn-buy" 
              wx:if="{{myPurchasePartsRepair.purchasePartsStatus !== 'completed'}}" 
              bindtap="goToShouhouForParts" 
              hover-class="pp-btn-hover">
          å»è´­ä¹°é…ä»¶
        </view>

        <!-- å®Œæˆåçš„æç¤º -->
        <view class="pp-done-tip" wx:if="{{myPurchasePartsRepair.purchasePartsStatus === 'completed'}}">
          <text class="success-icon">âœ“</text> è®¢å•å·²å®Œæˆï¼Œé…ä»¶åˆ°è´§åè¯·æŸ¥çœ‹ç»´ä¿®æ•™ç¨‹
        </view>
      </view>
    </view>

    <!-- ğŸ”´ å·²ç§»é™¤ï¼šç»´ä¿®å•å¡ç‰‡å·²ç§»åˆ°"å»é€‰è´­å•†å“"ä½ç½® -->

    <view class="section-label" wx:if="{{myActivityList.length > 0}}">MY ACTIVITIES / ç”³è¯·è¿›åº¦</view>
    
    <view class="activity-list" wx:if="{{myActivityList.length > 0}}">
      <block wx:for="{{myActivityList}}" wx:key="_id">
        <!-- ç‚¹å‡»é©³å›çš„å¡ç‰‡å¯ä»¥é‡æ–°ä¸Šä¼  -->
        <view class="act-card" bindtap="{{item.status == -1 ? 'reUpload' : ''}}" data-item="{{item}}">
          
          <!-- ğŸ”´ ä¸»è¦å†…å®¹åŒºåŸŸï¼šä¿æŒæ¨ªå‘å¸ƒå±€ -->
          <view class="act-main-row">
            <view class="act-left">
              <!-- æ ‡é¢˜ï¼šæ˜¾ç¤ºæ˜¯è§†é¢‘è¿˜æ˜¯è®¾å¤‡ -->
              <view class="act-title">
                <text class="act-tag {{item.type}}">{{item.type === 'video' ? 'è§†é¢‘' : (item.type === 'repair' ? 'æ•…éšœ' : 'è®¾å¤‡')}}</text>
                <text class="act-name">{{item.title}}</text>
              </view>
              <view class="act-time">{{item.createTime}}</view>
            </view>
            
            <!-- å³ä¾§çŠ¶æ€ -->
            <view class="act-right">
              <!-- å®¡æ ¸ä¸­ (0 æˆ– PENDING) -->
              <view class="status-pill processing" wx:if="{{(item.type !== 'repair') && (item.status === 0 || item.status === 'PENDING')}}">
                <view class="dot-p"></view>å®¡æ ¸ä¸­
              </view>
              
              <!-- å·²é€šè¿‡ (1 æˆ– APPROVED) -->
              <view class="status-pill success" wx:if="{{(item.type !== 'repair') && (item.status === 1 || item.status === 'APPROVED')}}">
                <view class="dot-s"></view>å·²é€šè¿‡
              </view>
              
              <!-- å·²é©³å› (-1 æˆ– REJECTED) -->
              <view class="status-pill fail" wx:if="{{item.status === -1 || item.status === 'REJECTED'}}">å·²é©³å›</view>
              
              <!-- [æ–°å¢] ç»´ä¿®å•ç‰¹æ®ŠçŠ¶æ€ -->
              
              <!-- å·²ç»´ä¿®å®Œæˆï¼ˆéœ€è¦ç”¨æˆ·å¯„å›çš„æµç¨‹ï¼Œç®¡ç†å‘˜å¯„å‡ºå¿«é€’åï¼Œç»¿è‰²ï¼‰ -->
              <view class="status-pill success" wx:if="{{item.type === 'repair' && item.status === 'REPAIR_COMPLETED_SENT' && item.needReturn}}">
                <view class="dot-s"></view>å·²ç»´ä¿®å®Œæˆ
              </view>
              
              <!-- ğŸ”´ åœºæ™¯Aï¼šæ•…éšœéœ€å¯„å›ï¼ˆçº¢è‰²ï¼‰ -->
              <view class="status-pill fail" wx:if="{{item.type === 'repair' && (item.status === 1 || item.status === 'SHIPPED') && item.needReturn && item.returnStatus !== 'PENDING_RETURN' && item.status !== 'REPAIR_COMPLETED_SENT'}}">
                <view class="dot-f"></view>æ•…éšœéœ€å¯„å›
              </view>
              
              <!-- å·²å¤‡ä»¶å¯„å‡ºï¼ˆä¸æ˜¾ç¤ºè¿å•å·ï¼Œè¿å•å·åœ¨æŸ¥çœ‹ç‰©æµæŒ‰é’®ä¸­ï¼‰ -->
              <view class="status-pill success" wx:if="{{item.type === 'repair' && (item.status === 1 || item.status === 'SHIPPED') && item.trackingId && item.status !== 'REPAIR_COMPLETED_SENT' && !(item.needReturn && item.returnStatus !== 'PENDING_RETURN')}}">
                <view class="dot-s"></view>å·²å¯„å‡º
              </view>
              
              <!-- çœ‹æ•™ç¨‹ (è“è‰²) -->
              <view class="status-pill info" wx:if="{{item.type === 'repair' && (item.status === 1 || item.status === 'TUTORIAL') && !item.trackingId && item.status !== 'REPAIR_COMPLETED_SENT'}}">
                æ•™ç¨‹å¯ä¿®å¤
              </view>
              
              <!-- ğŸ”´ åœºæ™¯Bï¼šå·²æ”¯ä»˜Â·å¾…ç»´ä¿® - ç»¿è‰² -->
              <view class="status-pill success" wx:if="{{item.type === 'repair' && item.needReturn && !item.returnCompleted && item.status !== 'REPAIR_COMPLETED_SENT' && item.status !== 'USER_SENT' && item.returnStatus !== 'USER_SENT' && item.returnStatus === 'PENDING_RETURN' && item.status !== 'SHIPPED' && (item.warrantyExpired === true || item.remainingDays === 0) && item.repairItems && item.repairItems.length > 0 && item.repairTotalPrice > 0 && item.repairPaid === true}}">
                <view class="dot-s"></view>å·²æ”¯ä»˜Â·å¾…ç»´ä¿®
              </view>
              
              <!-- ğŸ”´ åœºæ™¯Bï¼šå¾…æ”¯ä»˜Â·éœ€å¯„å› - çº¢è‰² -->
              <view class="status-pill fail" wx:if="{{item.type === 'repair' && item.needReturn && !item.returnCompleted && item.status !== 'REPAIR_COMPLETED_SENT' && item.status !== 'USER_SENT' && item.returnStatus !== 'USER_SENT' && item.returnStatus === 'PENDING_RETURN' && item.status !== 'SHIPPED' && ((item.warrantyExpired === true || item.remainingDays === 0) && item.repairItems && item.repairItems.length > 0 && item.repairTotalPrice > 0 && item.repairPaid === false) || (!((item.warrantyExpired === true || item.remainingDays === 0) && item.repairItems && item.repairItems.length > 0 && item.repairTotalPrice > 0))}}">
                <view class="dot-f"></view>
                <text wx:if="{{(item.warrantyExpired === true || item.remainingDays === 0) && item.repairItems && item.repairItems.length > 0 && item.repairTotalPrice > 0}}">å¾…æ”¯ä»˜Â·éœ€å¯„å›</text>
                <text wx:else>éœ€å¯„å›ç»´ä¿®</text>
              </view>
              
              <!-- ğŸ”´ å¾…å¯„å›ç»´ä¿®ï¼ˆå…¶ä»–æƒ…å†µï¼Œé»„è‰²ï¼‰- æ’é™¤åœºæ™¯Aå’Œåœºæ™¯B -->
              <view class="status-pill processing" wx:if="{{item.type === 'repair' && item.needReturn && !item.returnCompleted && item.status !== 'REPAIR_COMPLETED_SENT' && item.status !== 'USER_SENT' && item.returnStatus !== 'USER_SENT' && item.returnStatus !== 'PENDING_RETURN' && item.status !== 'SHIPPED'}}">
                <view class="dot-p"></view>å¾…å¯„å›ç»´ä¿®
              </view>
              
              <!-- ğŸ”´ å¾…è´­é…ä»¶ï¼ˆä¼˜å…ˆæ˜¾ç¤ºï¼‰ -->
              <view class="status-pill fail" wx:if="{{item.type === 'repair' && (item.needPurchaseParts === true || item.needPurchaseParts === 'true' || (item.purchasePartsList && item.purchasePartsList.length > 0)) && item.purchasePartsStatus !== 'completed'}}">
                <view class="dot-f"></view>å¾…è´­é…ä»¶
              </view>
              
              <!-- å·²è´­é…ä»¶ -->
              <view class="status-pill success" wx:if="{{item.type === 'repair' && item.purchasePartsStatus === 'completed'}}">
                <view class="dot-s"></view>å·²è´­é…ä»¶
              </view>
              
              <!-- å®¡æ ¸ä¸­ï¼ˆééœ€å¯„å›çŠ¶æ€ï¼Œä¸”ä¸éœ€è¦è´­ä¹°é…ä»¶ï¼‰ -->
              <view class="status-pill processing" wx:if="{{item.type === 'repair' && (item.status === 0 || item.status === 'PENDING') && item.status !== 'USER_SENT' && item.returnStatus !== 'USER_SENT' && item.status !== 'REPAIR_COMPLETED_SENT' && !item.needReturn && !item.needPurchaseParts && (!item.purchasePartsList || item.purchasePartsList.length === 0)}}">
                <view class="dot-p"></view>å®¡æ ¸ä¸­
              </view>
              
              <!-- å¾…ç¡®è®¤æ”¶è´§ï¼ˆåœºæ™¯Aï¼šç”¨æˆ·å·²å¯„å‡ºå¿«é€’åï¼‰ -->
              <view class="status-pill processing" wx:if="{{item.type === 'repair' && (item.status === 'USER_SENT' || item.returnStatus === 'USER_SENT') && item.returnStatus !== 'PENDING_RETURN' && item.status !== 'REPAIR_COMPLETED_SENT' && !item.warrantyDeducted && !item.isWarrantyDeducted && item.status !== 'RETURN_RECEIVED' && item.status !== 'COMPLETED'}}">
                <view class="dot-p"></view>å¾…ç¡®è®¤æ”¶è´§
              </view>
              
              <!-- å·²æ”¯ä»˜Â·å¾…ç»´ä¿® - åœºæ™¯Bï¼šç”¨æˆ·å·²å¯„å‡ºå¿«é€’åä¸”å·²æ”¯ä»˜ï¼ˆç»¿è‰²ï¼‰ -->
              <view class="status-pill success" wx:if="{{item.type === 'repair' && (item.status === 'USER_SENT' || item.returnStatus === 'USER_SENT') && item.returnStatus === 'PENDING_RETURN' && item.status !== 'REPAIR_COMPLETED_SENT' && (item.warrantyExpired === true || item.remainingDays === 0) && item.repairItems && item.repairItems.length > 0 && item.repairTotalPrice > 0 && item.repairPaid === true}}">
                <view class="dot-s"></view>å·²æ”¯ä»˜Â·å¾…ç»´ä¿®
              </view>
              
              <!-- æ­£åœ¨ç»´ä¿®ä¸­ï¼ˆåœºæ™¯Bï¼šç”¨æˆ·å·²å¯„å‡ºå¿«é€’åï¼Œæœªæ”¯ä»˜æˆ–å…¶ä»–æƒ…å†µï¼‰ -->
              <view class="status-pill processing" wx:if="{{item.type === 'repair' && (item.status === 'USER_SENT' || item.returnStatus === 'USER_SENT') && item.returnStatus === 'PENDING_RETURN' && item.status !== 'REPAIR_COMPLETED_SENT' && !((item.warrantyExpired === true || item.remainingDays === 0) && item.repairItems && item.repairItems.length > 0 && item.repairTotalPrice > 0 && item.repairPaid === true)}}">
                <view class="dot-p"></view>æ­£åœ¨ç»´ä¿®ä¸­
              </view>
              
              <!-- å”®åå®Œç»“ï¼ˆåœºæ™¯Aï¼šç®¡ç†å‘˜ç¡®è®¤æ”¶è´§åï¼‰ -->
              <view class="status-pill success" wx:if="{{item.type === 'repair' && (item.status === 'RETURN_RECEIVED' || item.status === 'COMPLETED') && item.returnStatus !== 'PENDING_RETURN'}}">
                <view class="dot-s"></view>å”®åå®Œç»“
              </view>
              
              <!-- å·²ç»´ä¿®å®Œæˆï¼ˆåœºæ™¯Bï¼šç®¡ç†å‘˜ç¡®è®¤æ”¶è´§åï¼‰ -->
              <view class="status-pill success" wx:if="{{item.type === 'repair' && (item.status === 'RETURN_RECEIVED' || item.status === 'COMPLETED') && item.returnStatus === 'PENDING_RETURN'}}">
                <view class="dot-s"></view>å·²ç»´ä¿®å®Œæˆ
              </view>
              
              <!-- æ‰£é™¤è´¨ä¿çŠ¶æ€ -->
              <view class="status-pill fail" wx:if="{{item.type === 'repair' && (item.warrantyDeducted || item.isWarrantyDeducted)}}">
                <view class="dot-f"></view>
                <text wx:if="{{item.deductionReason === 'é…ä»¶é”™è¯¯' || item.deductionReason === 'wrong_part'}}">é…ä»¶é”™è¯¯Â·æ‰£30å¤©</text>
                <text wx:elif="{{item.deductionReason === 'è¶…æ—¶' || item.deductionReason === 'timeout'}}">è¶…æ—¶æœªå¯„Â·æ‰£30å¤©</text>
                <text wx:else>æ‰£30å¤©è´¨ä¿</text>
              </view>
            </view>
          </view>
          
          <!-- ğŸ”´ æŸ¥çœ‹ç‰©æµæŒ‰é’®ï¼ˆæ˜¾ç¤ºåœ¨å·²å¤‡ä»¶å¯„å‡ºæˆ–å·²ç»´ä¿®å®ŒæˆçŠ¶æ€ï¼‰ -->
          <view class="logistics-btn-wrapper" wx:if="{{item.type === 'repair' && ((item.status === 1 || item.status === 'SHIPPED' || item.status === 'REPAIR_COMPLETED_SENT') && item.trackingId)}}">
            <view class="btn-logistics-action" catchtap="viewLogisticsDetail" data-sn="{{item.trackingId}}" data-phone="{{item.contact && item.contact.phone ? item.contact.phone : ''}}">
              æŸ¥çœ‹ç‰©æµ
            </view>
          </view>
          
          <!-- ğŸ”´ æ‹’ç»ç†ç”±ç‹¬ç«‹æ˜¾ç¤ºåœ¨ä¸‹æ–¹ï¼Œå®Œå…¨ä¸å½±å“ä¸Šé¢çš„å¸ƒå±€ -->
          <view class="reject-reason-wrapper" wx:if="{{(item.status === -1 || item.status === 'REJECTED') && item.rejectReason}}">
            <view class="reject-reason">
              <text class="reason-label">æ‹’ç»ç†ç”±ï¼š</text>
              <text class="reason-text">{{item.rejectReason}}</text>
            </view>
          </view>

        </view>
      </block>
    </view>
    <!-- ğŸ‘†ğŸ‘†ğŸ‘†ã€æ ¸å¿ƒè¡¥å…¨ã€‘ç»“æŸ ğŸ‘†ğŸ‘†ğŸ‘† -->

    <!-- 4. åº•éƒ¨æœåŠ¡æŒ‰é’® -->
    <view class="footer-bar">
      <view class="f-btn" bindtap="goToRepairService">é¢„çº¦ç»´ä¿®æœåŠ¡</view>
      <view class="f-btn dark" bindtap="goToCustomerService">è”ç³»åœ¨çº¿å®¢æœ</view>
    </view>
  </block>

  <!-- 5. ç»‘å®šæ¨¡æ€æ¡† -->
  <view class="modal {{showModal ? 'show' : ''}}" catchtouchmove="noop">
    <view class="modal-content" catchtouchmove="noop">
      
      <!-- 1. æ–‡æ¡ˆä¿®æ”¹ï¼šç»‘å®šè®¾å¤‡ -->
      <view class="modal-header">
        <text>ç»‘å®šè®¾å¤‡</text>
        <view class="close-modal" bindtap="closeBindModal">âœ•</view>
      </view>

      <scroll-view scroll-y="true" class="modal-scroll-area">
        
        <!-- === 2. è“ç‰™æ‰«ææŒ‰é’® (é›·è¾¾) === -->
        <!-- åªæœ‰æœªè¿æ¥æ—¶æ˜¾ç¤º -->
        <view class="bt-scan-container" wx:if="{{!bluetoothReady}}">
          <view class="radar-circle" bindtap="startConnect">
            <view class="radar-core">
              <!-- ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ¢æˆå›¾ç‰‡ ğŸ‘‡ğŸ‘‡ğŸ‘‡ -->
              <image class="bt-icon-img" src="data:image/svg+xml;base64,PHN2ZyB0PSIxNzEwNDg4ODg4ODg4IiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjQ3NTciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCI+PHBhdGggZD0iTTIyMy41NTIgNzI0LjQ4TDQ2NS45MiA1MTIgMjIzLjU1MiAyOTkuNTJsNTguOTA4LTY3LjI4TDQ5OC41MiA0MjEuNjg4VjM1Ljg0aDg5LjY4bDIzMC40IDIyNC42NC0yNDIuNTI4IDIxMi40OCAyNDIuNTI4IDIxMi40OC0yMzAuNCAyMjQuNjRINDk4LjUyVjYwMi4zMTJsLTIxNi4wNjQgMTg5LjQ0LTU4LjkwOC02Ny4yN3pNNTgyLjM1MiA1MTJMNjg4IDE5NC43NTIgNTg4LjE2IDk3LjQ0VjUxMnpNNTg4LjE2IDkyNi41Nkw2ODggODI5LjI0OCA1ODIuMzUyIDUxMnY0MTQuNTZ6IiBmaWxsPSIjRkZGRkZGIiBwLWlkPSI0NzU4Ij48L3BhdGg+PC9zdmc+" mode="aspectFit"></image>
            </view>
            
            <!-- æ³¢çº¹åŠ¨ç”» (ä¿æŒç»“æ„ï¼Œæ ·å¼ä¸‹é¢é‡å†™) -->
            <view class="radar-ring r1 {{isScanning?'anim':''}}"></view>
            <view class="radar-ring r2 {{isScanning?'anim':''}}"></view>
            <view class="radar-ring r3 {{isScanning?'anim':''}}"></view>
          </view>
          <text class="radar-tip">{{connectStatusText}}</text>
        </view>

        <!-- === 3. è¿æ¥æˆåŠŸåçš„çŠ¶æ€æ¡ === -->
        <view class="bt-connected-bar" wx:if="{{bluetoothReady}}">
          <view class="bt-c-icon">âœ…</view>
          <view class="bt-c-info">
            <text class="bt-c-name">å·²è¿æ¥è®¾å¤‡</text>
            <text class="bt-c-sn">{{connectedDeviceName}}</text>
          </view>
          <view class="bt-disconnect-btn" bindtap="resetBluetoothState">æ–­å¼€</view>
        </view>

        <!-- === 4. Tab åˆ‡æ¢ (é€»è¾‘ä¿®æ”¹ï¼šè¿ä¸Šè“ç‰™åæ‰æ˜¾ç¤ºï¼) === -->
        <view class="type-tabs" wx:if="{{bluetoothReady && !isDeviceLocked}}">
          <view class="tab-item {{bindType == 'new' ? 'active' : ''}}" bindtap="changeBindType" data-type="new">å…¨æ–°è®¾å¤‡</view>
          <view class="tab-item {{bindType == 'used' ? 'active' : ''}}" bindtap="changeBindType" data-type="used">äºŒæ‰‹/æ—§è®¾å¤‡</view>
        </view>

        <!-- === 5. è¢«é”çŠ¶æ€ === -->
        <view class="locked-view" wx:if="{{bluetoothReady && isDeviceLocked}}">
          <view class="locked-icon">ğŸš«</view>
          <text class="locked-title">æ— æ³•ç»‘å®š</text>
          <text class="locked-desc">{{lockedReason}}</text>
        </view>

        <!-- === 6. æ­£å¸¸å¡«è¡¨åŒºåŸŸ (è¿ä¸Šä¸”æ²¡é”æ‰æ˜¾ç¤º) === -->
        <view class="bind-form-area" wx:if="{{bluetoothReady && !isDeviceLocked}}">
          
          <view class="form-item">
            <text class="form-label">é€‰æ‹©äº§å“å‹å·</text>
            <picker bindchange="onModelChange" range="{{modelOptions}}" value="{{modelIndex}}">
              <view class="picker-val">{{modelOptions[modelIndex] || 'è¯·é€‰æ‹©å‹å·'}}</view>
            </picker>
          </view>

          <view class="form-item">
            <text class="form-label">{{bindType == 'new' ? 'è®¢å•æˆªå›¾' : 'ä¸Šä¼ å‡­è¯ (è´­ä¹°æˆªå›¾ + èŠå¤©è®°å½•)'}}</text>
            <view class="upload-group">
              <view class="upload-box" bindtap="chooseProofImage" data-type="receipt">
                <image wx:if="{{imgReceipt}}" src="{{imgReceipt}}" mode="aspectFill" class="uploaded-img" />
                <block wx:else><text class="plus-icon">+</text><text>è´­ä¹°æˆªå›¾</text></block>
              </view>
              <view class="upload-box" wx:if="{{bindType == 'used'}}" bindtap="chooseProofImage" data-type="chat">
                <image wx:if="{{imgChat}}" src="{{imgChat}}" mode="aspectFill" class="uploaded-img" />
                <block wx:else><text class="plus-icon">+</text><text>èŠå¤©è®°å½•</text></block>
              </view>
            </view>
          </view>

          <view class="form-item">
            <text class="form-label">è´­ä¹°æ—¥æœŸ</text>
            <picker mode="date" bindchange="onDateChange">
              <view class="picker-val">{{buyDate || 'è¯·é€‰æ‹©æ—¥æœŸ'}}</view>
            </picker>
          </view>
        </view>
        
        <view style="height: 40rpx;"></view>
      </scroll-view>

      <!-- åº•éƒ¨æäº¤æŒ‰é’® -->
      <view class="modal-footer" wx:if="{{bluetoothReady && !isDeviceLocked}}">
        <button class="submit-btn" bindtap="submitAudit">æäº¤ä¸Šä¼ å®¡æ ¸</button>
      </view>

    </view>
  </view>

  <!-- === æ”¹åŠ¨2ï¼šç®¡ç†å‘˜å®¡æ ¸å¼¹çª— (æ”¾åœ¨æœ€åº•éƒ¨) === -->
  <view class="modal {{showAuditModal ? 'show' : ''}}" style="z-index: 2000;" catchtouchmove="noop">
    <view class="modal-content" catchtouchmove="noop">
      <view class="modal-header">
        <text>å®¡æ‰¹è®¾ç½®</text>
        <view class="close-modal" bindtap="closeAuditModal">âœ•</view>
      </view>

      <view class="modal-scroll-area">
        <view class="form-item">
          <text class="form-label">ä¿®æ”¹è´­ä¹°æ—¥æœŸ (å½±å“å›ºä»¶ç‰ˆæœ¬)</text>
          <picker mode="date" value="{{adminSetDate}}" bindchange="onAdminDateChange">
            <view class="picker-val">{{adminSetDate || 'è¯·é€‰æ‹©æ—¥æœŸ'}}</view>
          </picker>
        </view>

        <view class="form-item">
          <text class="form-label">è®¾ç½®æ€»è´¨ä¿æ—¶é—´</text>
          <picker range="{{warrantyOptions}}" value="{{adminSetDaysIndex}}" bindchange="onAdminDaysChange">
            <view class="picker-val">{{warrantyOptions[adminSetDaysIndex]}}</view>
          </picker>
        </view>
      </view>

      <view class="modal-footer">
        <button class="submit-btn" bindtap="confirmApprove">ç¡®è®¤é€šè¿‡å¹¶åŒæ­¥</button>
      </view>
    </view>
  </view>

  <!-- ================= å…¨å±€è‡ªå®šä¹‰å¼¹çª— (æ›¿ä»£åŸç”Ÿï¼Œå¸¦æ”¶ç¼©é€€å‡ºåŠ¨ç”») ================= -->
  <view class="custom-dialog-mask {{dialogClosing ? 'closing' : ''}}" wx:if="{{dialog.show}}" catchtouchmove="noop" catchtap="noop">
    <view class="custom-dialog-box" catchtouchmove="noop" catchtap="noop">
      <view class="cd-title">{{dialog.title}}</view>
      <view class="cd-content">{{dialog.content}}</view>
      
      <view class="cd-btn-row">
        <!-- å–æ¶ˆæŒ‰é’® (å¯é€‰) -->
        <view class="cd-btn cancel" wx:if="{{dialog.showCancel}}" bindtap="closeCustomDialog">{{dialog.cancelText || 'å–æ¶ˆ'}}</view>
        <!-- ç¡®è®¤æŒ‰é’® -->
        <view class="cd-btn confirm" bindtap="onDialogConfirm">{{dialog.confirmText || 'ç¡®å®š'}}</view>
      </view>
    </view>
  </view>

  <!-- ================= è‡ªåŠ¨æ¶ˆå¤±æç¤ºï¼ˆæ— æŒ‰é’®ï¼Œ2ç§’åè‡ªåŠ¨æ¶ˆå¤±ï¼Œå¸¦æ”¶ç¼©é€€å‡ºåŠ¨ç”»ï¼‰ ================= -->
  <view class="auto-toast-mask {{autoToastClosing ? 'closing' : ''}}" wx:if="{{autoToast.show}}" catchtouchmove="noop" catchtap="noop">
    <view class="auto-toast-box" catchtouchmove="noop" catchtap="noop">
      <view class="at-title">{{autoToast.title}}</view>
      <view class="at-content">{{autoToast.content}}</view>
    </view>
  </view>

  <!-- ================= å…¨å±€è‡ªå®šä¹‰ Loading (ç™½è‰²èƒŒæ™¯è¿›åº¦æ¡) ================= -->
  <view class="loading-mask" wx:if="{{showLoadingAnimation}}" catchtouchmove="noop">
    <view class="loader" catchtouchmove="noop">
      <text class="loader-label">{{loadingText}}</text>
      <view class="loading-bar"></view>
    </view>
  </view>

  <!-- ================= è¾“å…¥å¼¹çª— (æ›¿ä»£ editable modalï¼Œå¸¦æ”¶ç¼©é€€å‡ºåŠ¨ç”») ================= -->
  <view class="custom-dialog-mask {{inputDialogClosing ? 'closing' : ''}}" wx:if="{{inputDialog.show}}" catchtouchmove="noop" catchtap="noop">
    <view class="custom-dialog-box" catchtouchmove="noop" catchtap="noop">
      <view class="cd-title">{{inputDialog.title}}</view>
      <input 
        class="cd-input" 
        type="text" 
        placeholder="{{inputDialog.placeholder}}"
        value="{{inputDialog.value}}"
        bindinput="onInputDialogInput"
        confirm-type="done"
        bindconfirm="onInputDialogConfirm"
      />
      <view class="cd-btn-row">
        <view class="cd-btn cancel" bindtap="closeInputDialog">å–æ¶ˆ</view>
        <view class="cd-btn confirm" bindtap="onInputDialogConfirm">ç¡®å®š</view>
      </view>
    </view>
  </view>

  <!-- ç»Ÿä¸€çš„"å†…å®¹å·²å¤åˆ¶"å¼¹çª—ï¼ˆæ ·å¼å’Œé¦–é¡µä¸€è‡´ï¼‰ -->
  <view class="custom-modal-mask" wx:if="{{showCopySuccessModal}}" catchtouchmove="noop" catchtap="noop">
    <view class="custom-modal-box copy-success-modal" catchtouchmove="noop" catchtap="noop">
      <view class="modal-icon-new success-icon">âœ“</view>
      <view class="modal-title-new">å†…å®¹å·²å¤åˆ¶</view>
    </view>
  </view>

  <!-- åˆ†äº«ç ç”Ÿæˆå¼¹çª—ï¼ˆç™½åº•é»‘å­—ï¼Œæ¸…æ™°æ’ç‰ˆï¼‰ -->
  <view class="custom-modal-mask {{showShareCodeGenerateModal ? 'active' : ''}}" wx:if="{{showShareCodeGenerateModal}}" catchtouchmove="noop" catchtap="noop">
    <view class="custom-modal-box share-code-generate-modal" catchtouchmove="noop" catchtap="noop">
      <view class="mt-icon-card">MT</view>
      <view class="modal-title-new">åˆ†äº«ç å·²ç”Ÿæˆ</view>
      
      <view class="share-code-content">
        <view class="share-code-item">
          <text class="label">åˆ†äº«ç </text>
          <text class="value code-value">{{shareCodeValue}}</text>
        </view>
        <view class="share-code-item">
          <text class="label">æœ‰æ•ˆæœŸ</text>
          <text class="value">10 å¤©</text>
        </view>
        <view class="share-code-item">
          <text class="label">æŸ¥çœ‹æ¬¡æ•°</text>
          <text class="value">3 æ¬¡</text>
        </view>
      </view>

      <view class="modal-btn-new btn-black" bindtap="copyShareCodeFromModal">
        å¤åˆ¶åˆ†äº«ç 
      </view>
    </view>
  </view>

  <!-- ================= éœ€å¯„å›è®¢å•ç¡®è®¤å¼¹çª— ================= -->
  <view class="return-required-mask" wx:if="{{showReturnRequiredModal}}" bindtap="closeReturnRequiredModal" catchtouchmove="noop" catchtap="noop">
    <view class="return-required-modal" catchtap="noop" catchtouchmove="noop">
      <view class="rr-header">
        <text class="rr-title">éœ€å¯„å›è®¢å•ç¡®è®¤</text>
        <text class="rr-close" bindtap="closeReturnRequiredModal">âœ•</text>
      </view>
      
      <scroll-view scroll-y class="rr-content" catchtouchmove="noop">
        <block wx:for="{{returnRequiredList}}" wx:key="_id">
          <view class="rr-item {{item.returnTrackingId && (item.status === 'USER_SENT' || item.returnStatus === 'USER_SENT') ? 'user-sent' : (item.returnTrackingId ? 'returned' : 'pending')}}">
            <view class="rr-item-header">
              <text class="rr-model">{{item.model}}</text>
              <text class="rr-status-badge {{item.returnTrackingId && (item.status === 'USER_SENT' || item.returnStatus === 'USER_SENT') ? 'user-sent' : (item.returnTrackingId ? 'returned' : 'pending')}}">
                {{item.returnTrackingId && (item.status === 'USER_SENT' || item.returnStatus === 'USER_SENT') && item.returnStatus !== 'PENDING_RETURN' ? 'ç”¨æˆ·å¯„å›æ•…éšœé…ä»¶' : (item.returnTrackingId && (item.status === 'USER_SENT' || item.returnStatus === 'USER_SENT') ? 'ç”¨æˆ·å¯„å›ç»´ä¿®' : (item.returnTrackingId ? 'å·²å¯„å›' : 'å¾…å¯„å›'))}}
              </text>
            </view>
            
            <view class="rr-item-info">
              <!-- åŸºç¡€ä¿¡æ¯åŒºåŸŸ -->
              <view class="rr-info-section">
                <view class="rr-info-row">
                  <text class="rr-info-label">ç”¨æˆ·æ˜µç§°</text>
                  <text class="rr-info-value">{{item.userNickname || 'åŒ¿åç”¨æˆ·'}}</text>
                </view>
                <view class="rr-info-row">
                  <text class="rr-info-label">è´¨ä¿çŠ¶æ€</text>
                  <text class="rr-info-value {{(item.warrantyExpired === true || item.remainingDays === 0) ? 'rr-warranty-expired-text' : 'rr-warranty-normal-text'}}">
                    {{(item.warrantyExpired === true || item.remainingDays === 0) ? 'å·²è¿‡æœŸ' : (item.remainingDays !== undefined && item.remainingDays > 0 ? 'å‰©ä½™' + item.remainingDays + 'å¤©' : 'æ­£å¸¸')}}
                  </text>
                </view>
                <view class="rr-info-row" wx:if="{{item.repairItems && item.repairItems.length > 0 && item.repairTotalPrice > 0}}">
                  <text class="rr-info-label">æ”¯ä»˜çŠ¶æ€</text>
                  <text class="rr-info-value {{item.repairPaid === true ? 'rr-payment-paid-text' : 'rr-payment-unpaid-text'}}">
                    {{item.repairPaid === true ? 'âœ“ å·²æ”¯ä»˜' : 'å¾…æ”¯ä»˜ï¼šÂ¥' + (item.repairTotalPrice || 0)}}
                  </text>
                </view>
              </view>

              <!-- åœ°å€ä¿¡æ¯åŒºåŸŸï¼ˆä»…åœºæ™¯Bæ˜¾ç¤ºï¼‰ -->
              <view class="rr-info-section" wx:if="{{item.returnStatus === 'PENDING_RETURN'}}">
                <view class="rr-info-row rr-address-row">
                  <text class="rr-info-label">æ”¶è´§åœ°å€</text>
                  <view class="rr-info-value-wrapper">
                    <text class="rr-info-value">
                      {{item.returnAddress ? (item.returnAddress.name + ' ' + item.returnAddress.phone + ' ' + item.returnAddress.address) : (item.contact.name + ' ' + item.contact.phone + ' ' + item.contact.address)}}
                    </text>
                    <view class="rr-copy-user-address-btn" bindtap="copyUserAddress" data-index="{{index}}">
                      <text class="rr-copy-text">å¤åˆ¶</text>
                    </view>
                  </view>
                </view>
              </view>

              <!-- è¯¦ç»†ä¿¡æ¯åŒºåŸŸ -->
              <view class="rr-info-section">
                <view class="rr-info-row" wx:if="{{item.returnNote}}">
                  <text class="rr-info-label">å¤‡æ³¨</text>
                  <text class="rr-info-value">{{item.returnNote}}</text>
                </view>
                <view class="rr-info-row">
                  <text class="rr-info-label">æ•…éšœæè¿°</text>
                  <text class="rr-info-value">{{item.description}}</text>
                </view>
                <view class="rr-info-row">
                  <text class="rr-info-label">å•†å“å‘å‡ºæ—¶é—´</text>
                  <text class="rr-info-value">{{item.shipTime}}</text>
                </view>
                <view class="rr-info-row" wx:if="{{item.returnTrackingId}}">
                  <text class="rr-info-label">å¯„å›è¿å•å·</text>
                  <text class="rr-info-value">{{item.returnTrackingId}}</text>
                </view>
              </view>
            </view>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <view class="rr-actions">
              <!-- ğŸ”´ åœºæ™¯Bï¼šç®¡ç†å‘˜æ‰‹åŠ¨æ ‡è®°çš„éœ€å¯„å›ï¼Œç”¨æˆ·å·²å¯„å‡ºï¼ˆéœ€å¯„å›ç»´ä¿®ï¼‰ -->
              <block wx:if="{{item.returnTrackingId && (item.status === 'USER_SENT' || item.returnStatus === 'USER_SENT') && item.returnStatus === 'PENDING_RETURN'}}">
                <!-- ğŸ”´ å¦‚æœç”¨æˆ·å·²æ”¯ä»˜ï¼Œæ˜¾ç¤ºé•¿æ¨ªæ¡çš„"å½•å…¥å•å·"æŒ‰é’® -->
                <block wx:if="{{item.repairItems && item.repairItems.length > 0 && item.repairPaid === true}}">
                  <view class="rr-btn-enter-tracking" bindtap="openEnterTrackingModal" data-item="{{item}}" data-index="{{index}}">å½•å…¥å•å·</view>
                </block>
                <!-- ğŸ”´ å¦‚æœç”¨æˆ·æœªæ”¯ä»˜ï¼Œæ˜¾ç¤ºæŸ¥çœ‹ç‰©æµå’Œå¡«å†™å”®åå•/å¯„å‡ºå¿«é€’ -->
                <block wx:else>
                  <view class="rr-btn logistics" bindtap="viewLogisticsDetail" data-sn="{{item.returnTrackingId}}" data-phone="{{item.contact.phone}}">æŸ¥çœ‹ç‰©æµ</view>
                  <!-- ğŸ”´ ä¿®æ”¹ï¼šå¦‚æœå·²å¡«å†™å”®åå•ä¸”å·²æ”¯ä»˜ï¼ˆè¿‡è´¨ä¿ï¼‰æˆ–æœªè¿‡è´¨ä¿å·²å¡«å†™å•å·ï¼Œæ˜¾ç¤ºå¯„å‡ºå¿«é€’ï¼›å¦åˆ™æ˜¾ç¤ºå¡«å†™å”®åå• -->
                  <view class="rr-btn ship-out" wx:if="{{item.repairItems && item.repairItems.length > 0 && ((item.warrantyExpired && item.repairPaid) || (!item.warrantyExpired && item.trackingId))}}" bindtap="adminShipOutAfterRepair" data-id="{{item._id}}">å¯„å‡ºå¿«é€’</view>
                  <view class="rr-btn fill-repair" wx:else bindtap="openFillRepairModal" data-item="{{item}}" data-index="{{index}}">å¡«å†™å”®åå•</view>
                </block>
              </block>
              <!-- åœºæ™¯Aï¼šç”¨æˆ·å¯„å›æ•…éšœé…ä»¶ï¼Œæ˜¾ç¤ºæ‰£é™¤ä¸€ä¸ªæœˆè´¨ä¿ã€æŸ¥çœ‹ç‰©æµå’Œç¡®è®¤æ”¶è´§ -->
              <block wx:elif="{{item.returnTrackingId && (item.status === 'USER_SENT' || item.returnStatus === 'USER_SENT') && item.returnStatus !== 'PENDING_RETURN'}}">
                <view class="rr-btn deduct" bindtap="deductWarrantyForRepair" data-id="{{item._id}}">æ‰£é™¤è´¨ä¿</view>
                <view class="rr-btn logistics" bindtap="viewLogisticsDetail" data-sn="{{item.returnTrackingId}}" data-phone="{{item.contact.phone}}">æŸ¥çœ‹ç‰©æµ</view>
                <view class="rr-btn confirm" bindtap="confirmReturnReceived" data-id="{{item._id}}">ç¡®è®¤æ”¶è´§</view>
              </block>
              <!-- å…¶ä»–çŠ¶æ€ï¼šæ˜¾ç¤ºå–æ¶ˆå’Œå·²å®Œæˆ -->
              <block wx:else>
                <view class="rr-btn cancel" bindtap="cancelReturnRequired" data-id="{{item._id}}">å–æ¶ˆ</view>
                <view class="rr-btn logistics" wx:if="{{item.returnTrackingId}}" bindtap="viewLogisticsDetail" data-sn="{{item.returnTrackingId}}" data-phone="{{item.contact.phone}}">æŸ¥çœ‹ç‰©æµ</view>
                <view class="rr-btn complete" bindtap="completeReturnRequired" data-id="{{item._id}}">å·²å®Œæˆ</view>
              </block>
            </view>
          </view>
        </block>
        
        <view class="rr-empty" wx:if="{{returnRequiredList.length === 0}}">
          <text>æš‚æ— éœ€å¯„å›çš„è®¢å•</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- ================= åœ°å€ä¿¡æ¯å¡«å†™å¼¹çª—ï¼ˆç®¡ç†å‘˜å¡«å†™ç”¨æˆ·åœ°å€ï¼Œå¸¦æ”¶ç¼©é€€å‡ºåŠ¨ç”»ï¼‰ ================= -->
  <view class="custom-dialog-mask {{returnAddressDialogClosing ? 'closing' : ''}}" wx:if="{{showReturnAddressDialog}}" bindtap="closeReturnAddressDialog" catchtouchmove="noop" catchtap="noop">
    <view class="custom-dialog-box" catchtap="noop" catchtouchmove="noop" style="max-width: 680rpx; padding: 50rpx 40rpx;">
      <view class="cd-title">å¡«å†™ç”¨æˆ·åœ°å€ä¿¡æ¯</view>
      <view class="cd-content" style="font-size: 26rpx; color: #999; margin-bottom: 30rpx; text-align: left;">
        ä¿®å¥½åå°†æŒ‰æ­¤åœ°å€å¯„å›ç»™ç”¨æˆ·
      </view>
      
      <view class="return-address-form">
        <view class="ra-form-item">
          <text class="ra-label">æ”¶ä»¶äººå§“å</text>
          <input 
            class="ra-input" 
            type="text" 
            placeholder="è¯·è¾“å…¥æ”¶ä»¶äººå§“å"
            value="{{tempReturnAddress.name}}"
            data-key="name"
            bindinput="onReturnAddressInput"
          />
        </view>
        
        <view class="ra-form-item">
          <text class="ra-label">æ”¶ä»¶äººæ‰‹æœºå·</text>
          <input 
            class="ra-input" 
            type="number" 
            placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·"
            value="{{tempReturnAddress.phone}}"
            data-key="phone"
            bindinput="onReturnAddressInput"
            maxlength="11"
          />
        </view>
        
        <view class="ra-form-item">
          <text class="ra-label">è¯¦ç»†åœ°å€</text>
          <textarea 
            class="ra-textarea" 
            placeholder="è¯·è¾“å…¥è¯¦ç»†åœ°å€ï¼ŒåŒ…å«çœå¸‚åŒºä¿¡æ¯ï¼Œå¦‚ï¼šå¹¿ä¸œçœ ä½›å±±å¸‚ å—æµ·åŒº æŸæŸè¡—é“101å·"
            value="{{tempReturnAddress.address}}"
            data-key="address"
            bindinput="onReturnAddressInput"
            auto-height
            maxlength="200"
          />
        </view>
      </view>
      
      <view class="cd-btn-row">
        <view class="cd-btn cancel" bindtap="closeReturnAddressDialog">å–æ¶ˆ</view>
        <view class="cd-btn confirm" bindtap="confirmReturnAddress">ç¡®å®š</view>
      </view>
    </view>
  </view>

  <!-- ================= åº•éƒ¨åŠå±å¼¹çª—ï¼šå½•å…¥å•å·å’Œå¡«å†™åœ°å€ ================= -->
  <view class="bottom-modal-mask {{showReturnAddressModal ? 'show' : ''}}" wx:if="{{showReturnAddressModal}}" bindtap="closeReturnAddressModal" catchtouchmove="noop">
    <view class="bottom-modal-content" catchtap="noop" catchtouchmove="noop">
      <!-- å¼¹çª—å¤´éƒ¨ -->
      <view class="bottom-modal-header">
        <!-- ğŸ”´ åœºæ™¯Aï¼šç®¡ç†å‘˜å½•å•å¤‡ä»¶å¯„å‡ºï¼Œæ˜¾ç¤º"å½•å…¥å¯„å›è¿å•å·"ï¼›åœºæ™¯Bï¼šç®¡ç†å‘˜æ‰‹åŠ¨æ ‡è®°ï¼Œæ˜¾ç¤º"å¡«å†™ä¿®å¥½åå¯„å›åœ°å€" -->
        <view class="bottom-modal-title">{{myReturnRequiredRepair && myReturnRequiredRepair.returnStatus === 'PENDING_RETURN' ? 'å¡«å†™ä¿®å¥½åå¯„å›åœ°å€' : 'å½•å…¥å¯„å›è¿å•å·'}}</view>
        <view class="bottom-modal-close" bindtap="closeReturnAddressModal">âœ•</view>
      </view>
      
      <!-- å¼¹çª—å†…å®¹åŒº -->
      <scroll-view class="bottom-modal-body" scroll-y catchtouchmove="noop">
        <view class="bottom-modal-form">
          <!-- ğŸ”´ åœºæ™¯Bï¼šç®¡ç†å‘˜æ‰‹åŠ¨æ ‡è®°ï¼Œæ˜¾ç¤ºåœ°å€è¾“å…¥ -->
          <block wx:if="{{myReturnRequiredRepair && myReturnRequiredRepair.returnStatus === 'PENDING_RETURN'}}">
            <!-- å¦‚æœæœªå¡«å†™åœ°å€ï¼Œæ˜¾ç¤ºåœ°å€å¡«å†™è¡¨å• -->
            <view wx:if="{{!myReturnRequiredRepair.returnAddress}}">
              <view class="ra-form-smart-paste-wrapper">
                <view class="ra-form-smart-paste" bindtap="openSmartAnalyzeModal">
                  <text class="ra-smart-paste-icon">ğŸ“‹</text>
                  <text class="ra-smart-paste-text">æ™ºèƒ½åˆ†æ</text>
                </view>
              </view>
              
              <view class="ra-form-item">
                <view class="ra-label">æ”¶ä»¶äººå§“å</view>
                <input 
                  class="ra-input" 
                  type="text" 
                  placeholder="è¯·è¾“å…¥æ”¶ä»¶äººå§“å"
                  placeholder-class="ph-style"
                  value="{{userReturnAddress.name}}"
                  data-key="name"
                  bindinput="onUserReturnAddressInput"
                />
              </view>
              
              <view class="ra-form-item">
                <view class="ra-label">æ”¶ä»¶äººæ‰‹æœºå·</view>
                <input 
                  class="ra-input" 
                  type="number" 
                  placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·"
                  placeholder-class="ph-style"
                  value="{{userReturnAddress.phone}}"
                  data-key="phone"
                  bindinput="onUserReturnAddressInput"
                  maxlength="11"
                />
              </view>
              
              <!-- ğŸ”´ æ–°å¢ï¼šçœå¸‚åŒºé€‰æ‹©ï¼ˆå¤åˆ¶è‡ª shouhou é¡µé¢ï¼‰ -->
              <view class="ra-form-item">
                <view class="ra-label">çœå¸‚åŒº</view>
                <view class="address-picker-row">
                  <picker mode="selector" range="{{provinceList}}" range-key="name" value="{{provinceIndex}}" bindchange="onProvinceChange" class="address-picker-btn">
                    <view class="address-picker-btn-inner {{!selectedProvince ? 'placeholder' : ''}}">
                      <text class="address-picker-text">{{selectedProvince || 'è¯·é€‰æ‹©çœä»½'}}</text>
                    </view>
                  </picker>
                  <picker mode="selector" range="{{cityList}}" range-key="name" value="{{cityIndex}}" bindchange="onCityChange" class="address-picker-btn" disabled="{{!selectedProvince}}">
                    <view class="address-picker-btn-inner {{!selectedCity ? 'placeholder' : ''}} {{!selectedProvince ? 'disabled' : ''}}">
                      <text class="address-picker-text">{{selectedCity || 'è¯·é€‰æ‹©åŸå¸‚'}}</text>
                    </view>
                  </picker>
                  <picker mode="selector" range="{{districtList}}" range-key="name" value="{{districtIndex}}" bindchange="onDistrictChange" class="address-picker-btn" disabled="{{!selectedCity}}">
                    <view class="address-picker-btn-inner {{!selectedDistrict ? 'placeholder' : ''}} {{!selectedCity ? 'disabled' : ''}}">
                      <text class="address-picker-text">{{selectedDistrict || 'è¯·é€‰æ‹©åŒºå¿'}}</text>
                    </view>
                  </picker>
                </view>
              </view>
              
              <view class="ra-form-item">
                <view class="ra-label">è¯¦ç»†åœ°å€</view>
                <input 
                  class="ra-input" 
                  placeholder="å¦‚ï¼šæŸæŸè¡—é“101å·"
                  placeholder-class="ph-style"
                  value="{{userReturnAddress.address}}"
                  data-key="address"
                  bindinput="onUserReturnAddressInput"
                  maxlength="200"
                />
              </view>
            </view>
            
            <!-- å¦‚æœå·²å¡«å†™åœ°å€ï¼Œæ˜¾ç¤ºåœ°å€ä¿¡æ¯ -->
            <view wx:else>
              <view class="ra-info-section">
                <view class="ra-info-title">å·²å¡«å†™åœ°å€ä¿¡æ¯ï¼š</view>
                <view class="ra-info-content">
                  <text class="ra-info-text">{{myReturnRequiredRepair.returnAddress.name}} {{myReturnRequiredRepair.returnAddress.phone}}</text>
                  <text class="ra-info-text">{{myReturnRequiredRepair.returnAddress.address}}</text>
                </view>
              </view>
            </view>
          </block>
          
          <!-- è¿å•å·è¾“å…¥ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼Œæ— è®ºæ˜¯å¦å¡«å†™åœ°å€ï¼‰ -->
          <view class="ra-form-item ra-tracking-item" wx:if="{{!myReturnRequiredRepair.returnTrackingId}}">
            <text class="ra-label">å½•å…¥å¯„å›è¿å•å·</text>
            <input 
              class="ra-input" 
              type="text" 
              placeholder="è¯·è¾“å…¥å¯„å›è¿å•å·"
              value="{{returnTrackingIdInput}}"
              bindinput="onReturnTrackingIdInput"
            />
          </view>
          
          <!-- å¦‚æœå·²å½•å…¥è¿å•å·ï¼Œæ˜¾ç¤ºè¿å•å·ä¿¡æ¯ -->
          <view class="ra-info-section" style="margin-top: 40rpx;" wx:if="{{myReturnRequiredRepair.returnTrackingId}}">
            <view class="ra-info-title">å·²å½•å…¥è¿å•å·ï¼š</view>
            <view class="ra-info-content">
              <text class="ra-info-text">{{myReturnRequiredRepair.returnTrackingId}}</text>
            </view>
          </view>
          
          <!-- ç»Ÿä¸€çš„æäº¤æŒ‰é’®ï¼ˆæäº¤åœ°å€å’Œè¿å•å·ï¼‰ -->
          <view class="ra-form-btn" bindtap="submitAddressAndTrackingId" wx:if="{{!myReturnRequiredRepair.returnTrackingId}}">
            æäº¤å•å·
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

</view>

<!-- å…¨å±€è‡ªå®šä¹‰å¼¹çª—ç»„ä»¶ -->
<custom-toast id="custom-toast" />

  <!-- ================= å¡«å†™å”®åå•å¼¹çª— ================= -->
  <view class="custom-dialog-mask fill-repair-mask {{showFillRepairModal ? 'show' : ''}}" wx:if="{{showFillRepairModal}}" bindtap="closeFillRepairModal" catchtouchmove="noop" catchtap="noop">
    <view class="custom-dialog-box fill-repair-dialog" catchtap="noop" catchtouchmove="noop">
      <view class="cd-header">
        <view class="cd-title">å¡«å†™å”®åå•</view>
      </view>
      
      <view class="fill-repair-content">
        <!-- å‹å·æ˜¾ç¤º -->
        <view class="fr-model-section">
          <view class="fr-label">å‹å·</view>
          <view class="fr-model-value">{{currentFillRepairItem ? currentFillRepairItem.model : ''}}</view>
        </view>
        
        <!-- ç»´ä¿®é¡¹ç›®åˆ—è¡¨ -->
        <view class="fr-items-section">
          <view class="fr-section-header">
            <view class="fr-label">ç»´ä¿®é¡¹ç›®</view>
            <view class="fr-add-btn" bindtap="addRepairItem">+ æ·»åŠ é¡¹ç›®</view>
          </view>
          
          <!-- ğŸ”´ ç»´ä¿®é¡¹ç›®åˆ—è¡¨å¯æ»šåŠ¨åŒºåŸŸ -->
          <scroll-view scroll-y class="fr-items-list" style="max-height: 400rpx;">
            <block wx:for="{{fillRepairItems}}" wx:key="index">
              <view class="fr-item-row">
                <view class="fr-item-input-wrapper">
                  <input 
                    class="fr-item-name" 
                    placeholder="ç»´ä¿®é¡¹åç§°" 
                    value="{{item.name}}"
                    data-index="{{index}}"
                    data-field="name"
                    bindinput="onRepairItemInput"
                  />
                  <input 
                    class="fr-item-price" 
                    type="digit" 
                    placeholder="Â¥0" 
                    value="{{item.price === 0 ? '' : item.price}}"
                    data-index="{{index}}"
                    data-field="price"
                    bindinput="onRepairItemInput"
                  />
                </view>
                <view class="fr-item-delete" bindtap="deleteRepairItem" data-index="{{index}}">åˆ é™¤</view>
              </view>
            </block>
            
            <view class="fr-empty-items" wx:if="{{fillRepairItems.length === 0}}">
              <text>æš‚æ— ç»´ä¿®é¡¹ç›®</text>
              <text style="display: block; margin-top: 8rpx; font-size: 24rpx; color: #C7C7CC;">ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ é¡¹ç›®"å¼€å§‹</text>
            </view>
          </scroll-view>
        </view>
        
        <!-- æ€»ä»·æ˜¾ç¤º -->
        <view class="fr-total-section">
          <view class="fr-total-row">
            <text class="fr-total-label">æ€»ä»·ï¼š</text>
            <text class="fr-total-price">Â¥{{fillRepairTotalPriceFormatted}}</text>
          </view>
        </view>
        
        <!-- ğŸ”´ è¿å•å·è¾“å…¥ï¼šä»…æœªè¿‡è´¨ä¿ç”¨æˆ·æ˜¾ç¤ºï¼ˆè¿‡è´¨ä¿ç”¨æˆ·éœ€å…ˆæ”¯ä»˜ï¼Œæ”¯ä»˜åæŒ‰é’®å˜ä¸º"å¯„å‡ºå¿«é€’"æ‰èƒ½å¡«å†™å•å·ï¼‰ -->
        <!-- æ¡ä»¶ï¼šcurrentFillRepairItem å­˜åœ¨ ä¸” warrantyExpired ä¸º false æˆ– undefined/nullï¼ˆå³æœªè¿‡è´¨ä¿ï¼‰ -->
        <view class="fr-tracking-section" wx:if="{{currentFillRepairItem && !currentFillRepairItem.warrantyExpired}}">
          <view class="fr-label">å¯„å›è¿å•å·</view>
          <input 
            class="fr-tracking-input" 
            placeholder="è¯·è¾“å…¥å¯„å›ç»™ç”¨æˆ·çš„è¿å•å·"
            value="{{fillRepairTrackingId}}"
            bindinput="onFillRepairTrackingIdInput"
          />
        </view>
        
        <!-- ğŸ”´ æ”¯ä»˜æç¤ºï¼šä»…è¿‡è´¨ä¿ç”¨æˆ·æ˜¾ç¤ºï¼ˆè¿‡è´¨ä¿ç”¨æˆ·ä¸æ˜¾ç¤ºè¿å•å·è¾“å…¥æ¡†ï¼Œéœ€å…ˆæ”¯ä»˜ï¼‰ -->
        <!-- æ¡ä»¶ï¼šcurrentFillRepairItem å­˜åœ¨ ä¸” warrantyExpired æ˜ç¡®ä¸º true -->
        <view class="fr-payment-tip" wx:if="{{currentFillRepairItem && currentFillRepairItem.warrantyExpired === true}}">
          <text class="fr-tip-text">ç”¨æˆ·è´¨ä¿å·²è¿‡æœŸï¼Œç”¨æˆ·éœ€è¦æ”¯ä»˜ç»´ä¿®è´¹ç”¨</text>
        </view>
      </view>
      
      <!-- åº•éƒ¨æŒ‰é’® -->
      <view class="cd-btn-row fill-repair-btns">
        <view class="cd-btn cancel" bindtap="closeFillRepairModal">å–æ¶ˆ</view>
        <!-- ğŸ”´ æŒ‰é’®é€»è¾‘ï¼š
             - è¿‡è´¨ä¿ç”¨æˆ·ï¼šæ˜¾ç¤º"æäº¤"ï¼ˆæäº¤åæ•°æ®ä¿å­˜ï¼Œç”¨æˆ·åœ¨ç•Œé¢æŸ¥çœ‹å¹¶æ”¯ä»˜ï¼Œæ”¯ä»˜æˆåŠŸåï¼Œåœ¨éœ€å¯„å›è®¢å•ç¡®è®¤å¼¹çª—ä¸­æŒ‰é’®ä¼šå˜ä¸º"å¯„å‡ºå¿«é€’"ï¼Œæ­¤æ—¶æ‰èƒ½å¡«å†™è¿å•å·ï¼‰
             - æœªè¿‡è´¨ä¿ç”¨æˆ·ï¼šæ˜¾ç¤º"æäº¤"ï¼ˆå¯ç›´æ¥å¡«å†™è¿å•å·å¹¶æäº¤ï¼‰ -->
        <view class="cd-btn confirm" wx:if="{{currentFillRepairItem && currentFillRepairItem.warrantyExpired === true}}" bindtap="submitFillRepairWithPayment">æäº¤</view>
        <view class="cd-btn confirm" wx:else bindtap="submitFillRepair">æäº¤</view>
      </view>
    </view>
  </view>

  <!-- ================= è´­ä¹°é…ä»¶å¼¹çª— ================= -->
<view class="custom-dialog-mask purchase-parts-mask" wx:if="{{showPurchasePartsModal}}" bindtap="closePurchasePartsModal" catchtouchmove="noop">
  <view class="custom-dialog-box purchase-parts-dialog" catchtap="noop" catchtouchmove="noop">
    <view class="cd-content purchase-parts-content">
      <scroll-view class="parts-scroll" scroll-y>
        <block wx:for="{{purchasePartsList}}" wx:key="model">
          <view class="parts-group">
            <view class="parts-group-title">{{item.model}}</view>
            <view class="parts-list">
              <view 
                class="parts-item {{part.selected ? 'selected' : ''}}" 
                wx:for="{{item.parts}}" 
                wx:key="name"
                wx:for-item="part"
                data-model="{{item.model}}"
                data-part-name="{{part.name}}"
                bindtap="togglePartSelection"
              >
                <text class="parts-checkbox">{{part.selected ? 'âœ“' : ''}}</text>
                <text class="parts-name">{{part.name}}</text>
              </view>
            </view>
          </view>
        </block>
      </scroll-view>
      
      <view class="parts-note-section">
        <text class="parts-note-label">å¤‡æ³¨è¯´æ˜ï¼š</text>
        <textarea 
          class="parts-note-input" 
          placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆé€‰å¡«ï¼‰"
          value="{{purchasePartsNote}}"
          bindinput="onPurchasePartsNoteInput"
          maxlength="200"
        />
      </view>
    </view>
    <view class="cd-btn-row">
      <view class="cd-btn cancel" bindtap="closePurchasePartsModal">å–æ¶ˆ</view>
      <view class="cd-btn confirm" bindtap="submitPurchaseParts">ç¡®å®š</view>
    </view>
  </view>
</view>

<!-- ================= ä»˜è´¹ç»´ä¿®ç¡®è®¤å¼¹çª— ================= -->
<view class="custom-dialog-mask" wx:if="{{showPaidRepairConfirmModal}}" bindtap="rejectPaidRepair" catchtouchmove="noop">
  <view class="custom-dialog-box" catchtap="noop" catchtouchmove="noop">
    <view class="cd-title">ç»´ä¿®è´¹ç”¨ç¡®è®¤</view>
    <view class="cd-content">
      <text>ç»´ä¿®å®Œæˆåéœ€è¦æ”¯ä»˜ç»´ä¿®è´¹ç”¨30å…ƒ+é…ä»¶è´¹ç”¨ï¼Œæ˜¯å¦åŒæ„ï¼Ÿ</text>
    </view>
    <view class="cd-btn-row">
      <view class="cd-btn cancel" bindtap="rejectPaidRepair">å–æ¶ˆ</view>
      <view class="cd-btn confirm" bindtap="confirmPaidRepair">åŒæ„</view>
    </view>
  </view>
</view>

<!-- ================= æµ‹è¯•å¯†ç è¾“å…¥å¼¹çª—ï¼ˆå¸¦æ”¶ç¼©é€€å‡ºåŠ¨ç”»ï¼‰ ================= -->
<view class="custom-dialog-mask {{testPasswordModalClosing ? 'closing' : ''}}" wx:if="{{showTestPasswordModal}}" bindtap="closeTestPasswordModal" catchtouchmove="noop" catchtap="noop">
  <view class="custom-dialog-box" catchtap="noop" catchtouchmove="noop" style="max-width: 600rpx;">
    <view class="cd-title">è¯·è¾“å…¥æµ‹è¯•å¯†ç </view>
    <view class="cd-content" style="font-size: 26rpx; color: #999; margin-bottom: 30rpx; text-align: left;">
      æ­¤æ“ä½œå°†æ¸…ç©ºé™¤ app_configã€guanliyuanã€shouhou ä»¥å¤–çš„æ‰€æœ‰é›†åˆæ•°æ®
    </view>
    
    <input 
      class="cd-input" 
      type="text" 
      password
      placeholder="è¯·è¾“å…¥å¯†ç "
      value="{{testPasswordInput}}"
      bindinput="onTestPasswordInput"
      confirm-type="done"
      bindconfirm="confirmTestPassword"
      maxlength="20"
    />
    
    <view class="cd-btn-row">
      <view class="cd-btn cancel" bindtap="closeTestPasswordModal">å–æ¶ˆ</view>
      <view class="cd-btn confirm" bindtap="confirmTestPassword">ç¡®å®š</view>
    </view>
  </view>
</view>

<!-- ================= æ¸…ç©ºæ•°æ®è¿›åº¦æç¤º ================= -->
<view class="loading-mask" wx:if="{{isClearingData}}" catchtouchmove="noop">
  <view class="loader" catchtouchmove="noop">
    <text class="loader-label">æ­£åœ¨æ¸…ç©ºæ•°æ®...</text>
    <view class="loading-bar"></view>
    <view style="margin-top: 20rpx; font-size: 24rpx; color: #666;">
      <text wx:if="{{clearProgress.currentCollection}}">
        æ­£åœ¨å¤„ç†ï¼š{{clearProgress.currentCollection}} 
        ({{clearProgress.current}}/{{clearProgress.total}})
      </text>
    </view>
  </view>
</view>

<!-- ================= å®šä½æƒé™æç¤ºé®ç½© ================= -->
<view class="location-permission-mask" wx:if="{{showLocationPermissionModal}}" catchtouchmove="noop">
  <view class="location-permission-content" catchtouchmove="noop">
    <view class="location-permission-icon">ğŸ“</view>
    <text class="location-permission-title">éœ€è¦è·å–æ‚¨çš„ä½ç½®ä¿¡æ¯</text>
    <text class="location-permission-desc">ç”¨äºå±•ç¤ºé™„è¿‘ç»´ä¿®é—¨åº—å’Œè®¡ç®—é…é€è·ç¦»</text>
    <view class="location-permission-buttons">
      <view class="location-permission-btn cancel" bindtap="closeLocationPermissionModal">æ‹’ç»</view>
      <view class="location-permission-btn confirm" bindtap="_openLocationSetting">å»è®¾ç½®</view>
    </view>
    <text class="location-permission-tip" wx:if="{{locationPermissionChecking}}">ç­‰å¾…æˆæƒä¸­...</text>
  </view>
</view>

<!-- ================= æ™ºèƒ½åˆ†æå¼¹çª— ================= -->
<view class="smart-paste-mask" wx:if="{{showSmartAnalyzeModal}}" catchtouchmove="noop">
  <view class="smart-paste-box" catchtouchmove="noop">
    <view class="sp-title">æ™ºèƒ½åˆ†æ</view>
    <view class="sp-desc">è¯·å°†å§“åã€ç”µè¯ã€åœ°å€ç²˜è´´åˆ°ä¸‹æ–¹æ¡†ä¸­</view>
    <textarea 
      class="sp-textarea" 
      placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰ 13800138000 å¹¿ä¸œçœæ·±åœ³å¸‚å—å±±åŒº..." 
      value="{{smartAnalyzeVal}}" 
      bindinput="onSmartAnalyzeInput"
      adjust-position="{{true}}"
      fixed="{{true}}"
    ></textarea>
    <view class="sp-btn-row">
      <view class="sp-btn cancel" bindtap="closeSmartAnalyzeModal">å–æ¶ˆ</view>
      <view class="sp-btn confirm" bindtap="confirmSmartAnalyze">æ™ºèƒ½åˆ†æ</view>
    </view>
  </view>
</view>

<!-- ================= ç‰©æµæŸ¥è¯¢å¼¹çª— ================= -->
<view class="logistics-modal-mask" wx:if="{{showLogisticsModal}}" bindtap="closeLogisticsModal" catchtouchmove="noop">
  <!-- ğŸ”´ ç§»é™¤äº† catchtouchmove="noop"ï¼Œå…è®¸å†…éƒ¨ scroll-view æ»šåŠ¨ -->
  <view class="logistics-modal-box" catchtap="noop">
    
    <!-- 1. å“ç‰Œå¤´éƒ¨ -->
    <view class="logistics-header">
      <view class="brand-tag">MT-æ‘©æ”¹ç¤¾ä¿éšœä½ çš„ç‰©æµ</view>
      <view class="close-btn" bindtap="closeLogisticsModal">âœ•</view>
    </view>

    <view class="logistics-modal-content">
      
      <!-- 2. æ ¸å¿ƒä¿¡æ¯åŒº (æ–°ç‰ˆå¡ç‰‡æ ·å¼) -->
      <view class="logistics-card-container">
      <view class="logistics-info-card">
          <view class="card-header-row">
            <view class="company-info">
              <view class="company-icon-placeholder">MT</view>
              <text class="company-name">{{logisticsData.express_company_name || 'æŸ¥è¯¢ä¸­...'}}</text>
            </view>
            <view class="status-badge {{logisticsData.status === '3' ? 'success' : ''}}" wx:if="{{logisticsData.status_text}}">
              {{logisticsData.status_text}}
            </view>
          </view>
          <view class="card-body-row">
          <text class="tracking-number">{{currentTrackingId}}</text>
          <view class="copy-btn" bindtap="copyTrackingId" data-sn="{{currentTrackingId}}">å¤åˆ¶</view>
        </view>
        </view>
      </view>
      
      <!-- 3. åŠ è½½çŠ¶æ€ -->
      <view class="logistics-loading" wx:if="{{logisticsLoading}}">
        <view class="mt-loader"></view>
      </view>
      
      <!-- 4. é”™è¯¯æç¤º -->
      <view class="logistics-error" wx:if="{{logisticsError && !logisticsLoading}}">
        <text class="error-icon">âš ï¸</text>
        <text class="error-text">{{logisticsError}}</text>
      </view>
      
      <!-- 5. ç‰©æµè½¨è¿¹ (ä¼˜åŒ–ç‰ˆï¼šè½´çº¿å·¦ç½®ï¼Œå†…å®¹å…¨å®½) -->
      <!-- ğŸ”´ å…³é”®ä¿®å¤ï¼šç¡®ä¿ scroll-view å¯ä»¥æ»šåŠ¨ï¼Œæ·»åŠ  enhanced å±æ€§ -->
      <scroll-view 
        scroll-y 
        class="logistics-scroll" 
        enable-back-to-top="{{true}}" 
        enhanced="{{true}}"
        show-scrollbar="{{false}}"
        wx:if="{{logisticsData && !logisticsLoading}}">
        <view class="timeline-container">
          <view class="timeline-item" wx:for="{{logisticsData.path_list}}" wx:key="index">
            
            <!-- å·¦ä¾§ï¼šè½´çº¿ -->
            <view class="timeline-axis">
              <view class="dot {{index === 0 ? 'active' : ''}}"></view>
              <view class="line" wx:if="{{index < logisticsData.path_list.length - 1}}"></view>
            </view>
            
            <!-- å³ä¾§ï¼šæ—¶é—´ + å†…å®¹ -->
            <view class="timeline-content-wrapper {{index === 0 ? 'active' : ''}}">
              <!-- æ—¶é—´è¡Œ -->
              <view class="timeline-header">
                <text class="time-full" wx:if="{{item._dateStr}}">{{item._dateStr}} {{item.time}}</text>
                <text class="time-full" wx:else>{{item.time}}</text>
              </view>
              <!-- å†…å®¹è¡Œ -->
              <view class="timeline-body">
                <text class="desc-text" selectable="true">{{item.desc}}</text>
              </view>
            </view>

          </view>
        </view>
        
        <!-- æ— è½¨è¿¹ä¿¡æ¯ -->
        <view class="logistics-empty" wx:if="{{!logisticsData.path_list || logisticsData.path_list.length === 0}}">
          <text>æš‚æ— ç‰©æµè½¨è¿¹ä¿¡æ¯</text>
        </view>
      </scroll-view>
      
    </view>
  </view>
</view>
