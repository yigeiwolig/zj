<!-- pages/my/my.wxml -->

<view class="container">

  <!-- 1. é¡¶éƒ¨è¿”å›æŒ‰é’® (ä¸€ç›´å­˜åœ¨) -->
  <view class="nav-back-fixed" bindtap="goBack">
    <text class="back-arrow">â†</text>
  </view>

  <!-- 2. ç”¨æˆ·ä¸ªäººä¿¡æ¯ - ã€ç®¡ç†å‘˜æ¨¡å¼ä¸‹éšè—ã€‘ -->
  <view class="profile-header" wx:if="{{!isAdmin}}">
    <view class="header-content">
      <view class="user-identity">
        <text class="rank-tag">PLATINUM MEMBER</text>
        <text class="user-name">Alexander</text>
      </view>
      <view class="header-stats">
        <view class="stat-item">
          <text class="label">æ‹¥æœ‰äº§å“æ•°é‡</text>
          <text class="value">{{deviceList.length}} ä»¶</text>
        </view>
        <view class="divider-v"></view>
        <view class="stat-item">
          <text class="label">ä¼šå‘˜ç­‰çº§</text>
          <text class="value platinum">é“‚é‡‘å°Šäº«ä¼šå‘˜</text>
        </view>
      </view>
    </view>
  </view>

  <!-- === ã€æ ¸å¿ƒä¿®æ”¹åŒºåŸŸï¼šç®¡ç†å‘˜ç•Œé¢ã€‘ === -->
  <block wx:if="{{isAdmin}}">
    
    <!-- 1. æ ‡é¢˜æ  + åˆ‡æ¢æŒ‰é’® -->
    <view class="admin-header-row">
      <view class="admin-page-title">
        {{showShippedMode ? 'å‘è´§è®°å½•' : 'å¾…å¤„ç†è®¢å•'}}
      </view>
      
      <!-- å³ä¾§åˆ‡æ¢æŒ‰é’® -->
      <view class="switch-view-btn {{showShippedMode ? 'active' : ''}}" bindtap="toggleViewMode">
        {{showShippedMode ? 'â† è¿”å›å¾…å¤„ç†' : 'æŸ¥çœ‹å·²å‘è´§ â”'}}
      </view>
    </view>

    <!-- 2. æ¨¡å¼Aï¼šå¾…å‘è´§ (æ¨ªå‘ Swiper) -->
    <swiper 
      wx:if="{{!showShippedMode}}"
      class="order-swiper" 
      bindchange="onOrderChange" 
      circular 
      previous-margin="60rpx" 
      next-margin="60rpx"
      style="height: {{swiperHeight}}px; transition: height 0.3s ease;"
    >
      <!-- å¦‚æœæ²¡æœ‰å¾…å‘è´§è®¢å• -->
      <swiper-item wx:if="{{pendingList.length === 0}}">
        <view class="empty-card">ğŸ‰ å¤ªæ£’äº†ï¼Œæ‰€æœ‰è®¢å•éƒ½å·²å‘è´§ï¼</view>
      </swiper-item>

      <!-- å¾ªç¯ pendingList -->
      <swiper-item wx:for="{{pendingList}}" wx:key="id" wx:for-index="idx">
        <view class="order-card detail-mode" id="card-{{idx}}">
          
          <!-- 1. å¤´éƒ¨ï¼šä¿®å¤ä½ç½®ä¸å¯¹çš„é—®é¢˜ -->
          <view class="card-header">
            <view class="order-id-group">
              <text class="order-label">è®¢å•å·</text>
              <text class="order-val">{{item.orderId}}</text>
            </view>
            <view class="status-tag {{item.realStatus}}">{{item.statusText}}</view>
          </view>

          <!-- ã€å…³é”®ã€‘ä¹°å®¶ä¿¡æ¯æ ï¼šæ˜¾ç¤ºæ˜µç§°ã€ç”µè¯ã€åœ°å€ -->
          <view class="buyer-info-box">
            <view class="b-row">
              <text class="b-name">{{item.userName || 'åŒ¿åç”¨æˆ·'}}</text>
              <text class="b-phone">{{item.userPhone}}</text>
            </view>
            <view class="b-addr">{{item.userAddr}}</view>
          </view>

          <!-- 2. ä¸­é—´å•†å“åˆ—è¡¨ -->
          <view class="goods-detail-list">
            <view class="mini-tag">è´­ç‰©æ¸…å•</view>
            <block wx:for="{{item.goodsList}}" wx:for-item="g" wx:key="index">
              <view class="g-item">
                <view class="g-info">
                  <text class="g-n">{{g.name}}</text>
                  <text class="g-s">{{g.spec}}</text>
                </view>
                <view class="g-count">x{{g.quantity}}</view>
                <view class="g-p">Â¥{{g.total}}</view>
              </view>
            </block>
          </view>

          <!-- 3. åº•éƒ¨ï¼šåˆè®¡ + æ“ä½œæŒ‰é’® -->
          <view class="card-footer-new">
            <view class="total-row">
              <text class="time-text">{{item.createTime}}</text>
              <view class="price-box">
                <text>å®ä»˜</text> 
                <!-- ã€ä¿®æ”¹ã€‘ç»™é‡‘é¢åŠ ä¸Šç‚¹å‡»äº‹ä»¶ï¼ˆç®¡ç†å‘˜å¾…å‘è´§ä¹Ÿå¯ä»¥æ”¹ä»·ï¼‰ -->
                <text 
                  class="price-num {{isAdmin && item.realStatus === 'PAID' ? 'editable-price' : ''}}" 
                  catchtap="adminModifyPrice" 
                  data-id="{{item.id}}" 
                  data-price="{{item.amount}}"
                  data-status="{{item.realStatus}}">
                  Â¥{{item.amount}}
                </text>
              </view>
            </view>
            <view class="admin-ship-btn" catchtap="adminShipOrder" data-id="{{item.id}}">å½•å…¥å•å·å¹¶å‘è´§</view>
          </view>
        </view>
      </swiper-item>
    </swiper>

    <!-- 3. æ¨¡å¼Bï¼šå·²å‘è´§ (çºµå‘ ScrollView) -->
    <scroll-view 
      wx:if="{{showShippedMode}}" 
      scroll-y 
      class="history-scroll-view"
    >
      <view class="history-list-container">
        <block wx:for="{{shippedList}}" wx:key="id">
          <!-- å†å²è®¢å•å¡ç‰‡ (ç¨å¾®ç®€åŒ–ä¸€ç‚¹ï¼Œä¸éœ€è¦å¤§æŒ‰é’®) -->
          <view class="order-card detail-mode history-item">
             <!-- å¤´éƒ¨ -->
             <view class="card-header">
                <text class="order-val">{{item.orderId}}</text>
                <view class="status-tag {{item.realStatus}}">{{item.statusText}}</view>
             </view>
             <!-- ä¹°å®¶ (ç²¾ç®€æ˜¾ç¤º) -->
             <view class="buyer-info-box small">
                <text class="b-name">{{item.userName}}</text>
                <text style="margin:0 10rpx; color:#ddd;">|</text>
                <text class="b-addr">{{item.userAddr}}</text>
             </view>
             <!-- åº•éƒ¨ -->
             <view class="card-footer-new">
                <text class="time-text">{{item.createTime}}</text>
                <!-- æŸ¥çœ‹ç‰©æµæŒ‰é’® -->
                <view class="btn-logistics-action small" catchtap="viewLogisticsDetail" data-sn="{{item.trackingId}}">
                  æŸ¥çœ‹ç‰©æµ
                </view>
             </view>
          </view>
        </block>
        <view class="end-tip">- ä»…æ˜¾ç¤ºæœ€è¿‘å†å²è®°å½• -</view>
      </view>
    </scroll-view>

  </block>

  <!-- æ™®é€šç”¨æˆ·è§†å›¾ (ä¿æŒä¸å˜ï¼Œè¿˜æ˜¯ç”¨åŸæ¥çš„ swiper orders) -->
  <block wx:if="{{!isAdmin}}">
    <swiper 
      class="order-swiper" 
      bindchange="onOrderChange" 
      circular 
      previous-margin="60rpx" 
      next-margin="60rpx"
      style="height: {{swiperHeight}}px; transition: height 0.3s ease;"
    >
      <swiper-item wx:for="{{orders}}" wx:key="id" wx:for-index="idx">
        <view class="order-card detail-mode" id="card-{{idx}}">
          
          <!-- 1. å¤´éƒ¨ -->
          <view class="card-header">
            <view class="order-id-group">
              <text class="order-label">è®¢å•å·</text>
              <text class="order-val">{{item.orderId}}</text>
            </view>
            <view class="status-tag {{item.realStatus}}">{{item.statusText}}</view>
          </view>

          <!-- ä¹°å®¶ä¿¡æ¯æ  -->
          <view class="buyer-info-box">
            <view class="b-row">
              <text class="b-name">{{item.userName || 'åŒ¿åç”¨æˆ·'}}</text>
              <text class="b-phone">{{item.userPhone}}</text>
            </view>
            <view class="b-addr">{{item.userAddr}}</view>
          </view>

          <!-- å•†å“åˆ—è¡¨ -->
          <view class="goods-detail-list">
            <view class="mini-tag">è´­ç‰©æ¸…å•</view>
            <block wx:for="{{item.goodsList}}" wx:for-item="g" wx:key="index">
              <view class="g-item">
                <view class="g-info">
                  <text class="g-n">{{g.name}}</text>
                  <text class="g-s">{{g.spec}}</text>
                </view>
                <view class="g-count">x{{g.quantity}}</view>
                <view class="g-p">Â¥{{g.total}}</view>
              </view>
            </block>
          </view>

          <!-- åº•éƒ¨ -->
          <view class="card-footer-new">
            <view class="total-row">
              <text class="time-text">{{item.createTime}}</text>
              <view class="price-box">
                <text>å®ä»˜</text> 
                <!-- ã€ä¿®æ”¹ã€‘ç»™é‡‘é¢åŠ ä¸Šç‚¹å‡»äº‹ä»¶ -->
                <!-- å¢åŠ ä¸€ä¸ª editable-price ç±»åï¼Œå¦‚æœæ˜¯ç®¡ç†å‘˜ä¸”æœªæ”¯ä»˜ï¼Œæ˜¾ç¤ºè™šçº¿æç¤ºå¯ç‚¹ -->
                <text 
                  class="price-num {{isAdmin && item.realStatus === 'UNPAID' ? 'editable-price' : ''}}" 
                  catchtap="adminModifyPrice" 
                  data-id="{{item.id}}" 
                  data-price="{{item.amount}}"
                  data-status="{{item.realStatus}}">
                  Â¥{{item.amount}}
                </text>
              </view>
            </view>

            <!-- 1. å¾…ä»˜æ¬¾ï¼šæ˜¾ç¤ºæ“ä½œæŒ‰é’® -->
            <view wx:if="{{item.realStatus === 'UNPAID'}}" class="action-row-right">
              
              <!-- ã€æ–°å¢ã€‘å·¦ä¾§çš„å–æ¶ˆè®¢å•æŒ‰é’® -->
              <view class="btn-mini outline-red" catchtap="userCancelOrder" data-id="{{item.id}}">
                å–æ¶ˆè®¢å•
              </view>

              <!-- ä¸­é—´çš„å ä½ï¼ˆå¦‚æœæœ‰æ¨¡æ‹Ÿæ”¯ä»˜ï¼‰ -->
              <view class="btn-mini gray" catchtap="debugSimulatePay" data-id="{{item.id}}">
                âš¡ï¸ æ¨¡æ‹Ÿ
              </view>

              <!-- å³ä¾§çš„æ”¯ä»˜æŒ‰é’® -->
              <view class="btn-mini black" catchtap="repayOrder" data-item="{{item}}">
                ç«‹å³æ”¯ä»˜
              </view>
              
            </view>

            <!-- 3. è¿è¾“ä¸­ï¼šæ‰€æœ‰äººéƒ½èƒ½çœ‹ç‰©æµ -->
            <view 
              wx:if="{{item.realStatus === 'SHIPPED'}}" 
              class="logistics-btn" 
              catchtap="viewLogisticsDetail" 
              data-sn="{{item.trackingId}}">
              æŸ¥çœ‹ç‰©æµ ({{item.trackingId}})
            </view>

          </view>
        </view>
      </swiper-item>
    </swiper>
  </block>

  <!-- 5. è®¾å¤‡åˆ—è¡¨ - ã€ç®¡ç†å‘˜æ¨¡å¼ä¸‹éšè—ã€‘ -->
  <block wx:if="{{!isAdmin}}">
    <view class="section-label">MY DEVICES / äº§å“è®¾å¤‡</view>
    <view class="device-card" wx:for="{{deviceList}}" wx:key="sn">
      <view class="remove-icon" bindtap="removeDevice" data-index="{{index}}">âœ•</view>
      <view class="device-name">{{item.name}}</view>
      <view class="spec-list">
        <view class="spec-row">
          <text class="label">S/N åºåˆ—å·</text>
          <text class="value mono">{{item.sn}}</text>
        </view>
        <view class="spec-row">
          <text class="label">æ€»å‰©ä½™è´¨ä¿</text>
          <view class="warranty-val">
            <text class="days-num {{item.days < 30 ? 'warning' : ''}}">{{item.days}} Days</text>
            <text class="ext-tag" wx:if="{{item.hasExtra}}">å«å»¶ä¿</text>
          </view>
        </view>
        <view class="spec-row">
          <text class="label">è´¨ä¿åˆ°æœŸæ—¥æœŸ</text>
          <text class="value">{{item.expiryDate}}</text>
        </view>
        <view class="spec-row">
          <text class="label">æ¿€æ´»æ¬¡æ•°</text>
          <text class="value">{{item.activations}} æ¬¡</text>
        </view>
        <view class="spec-row">
          <text class="label">å›ºä»¶ç‰ˆæœ¬</text>
          <text class="value">{{item.firmware}}</text>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨æ·»åŠ è®¾å¤‡å¤§æŒ‰é’® -->
    <view class="device-card add-mode" bindtap="openBindModal">
      <view class="add-content">
        <text class="big-plus">+</text>
        <text class="add-tips">ç»‘å®šæ–°äº§å“</text>
      </view>
    </view>

    <!-- 4. åº•éƒ¨æœåŠ¡æŒ‰é’® -->
    <view class="footer-bar">
      <view class="f-btn">é¢„çº¦ç»´ä¿®æœåŠ¡</view>
      <view class="f-btn dark">è”ç³»åœ¨çº¿å®¢æœ</view>
    </view>
  </block>

  <!-- 5. ç»‘å®šæ¨¡æ€æ¡† -->
  <view class="modal {{showModal ? 'show' : ''}}">
    <view class="modal-content">
      
      <view class="modal-header">
        <text>ç»‘å®šèµ„äº§</text>
        <view class="close-modal" bindtap="closeBindModal">âœ•</view>
      </view>

      <scroll-view scroll-y="true" class="modal-scroll-area">
        
        <!-- Tab åˆ‡æ¢ -->
        <view class="type-tabs">
          <view class="tab-item {{bindType == 'new' ? 'active' : ''}}" bindtap="changeBindType" data-type="new">å…¨æ–°è®¾å¤‡</view>
          <view class="tab-item {{bindType == 'used' ? 'active' : ''}}" bindtap="changeBindType" data-type="used">äºŒæ‰‹/æ—§è®¾å¤‡</view>
        </view>

        <view class="bt-btn {{bluetoothReady ? 'ready' : ''}}" bindtap="startConnect">
          
          <!-- æ‰«ææ—¶çš„åŠ¨ç”»æ•ˆæœ -->
          <view class="scan-radar" wx:if="{{isScanning}}">
            <view class="ripple r1"></view>
            <view class="ripple r2"></view>
            <view class="ripple r3"></view>
          </view>

          <text>{{connectStatusText}}</text>
        </view>

        <view class="form-item">
          <text class="form-label">é€‰æ‹©äº§å“å‹å·</text>
          <picker bindchange="onModelChange" range="{{modelOptions}}">
            <view class="picker-val">{{modelOptions[modelIndex] || 'è¯·é€‰æ‹©å‹å·'}}</view>
          </picker>
        </view>

        <!-- åŠ¨æ€ä¸Šä¼ åŒºåŸŸï¼šæ ¹æ® bindType å˜åŒ– -->
        <view class="form-item">
          <!-- æ ‡é¢˜ä¹Ÿä¼šè·Ÿç€å˜ -->
          <text class="form-label">{{bindType == 'new' ? 'ä¸Šä¼ å‡­è¯ (è´­ä¹°æˆªå›¾)' : 'ä¸Šä¼ å‡­è¯ (è´­ä¹°æˆªå›¾ + èŠå¤©è®°å½•)'}}</text>
          
          <view class="upload-group">
            <!-- æ¡†1ï¼šè´­ä¹°æˆªå›¾ -->
            <view class="upload-box" bindtap="chooseProofImage" data-type="receipt">
              <!-- å¦‚æœæœ‰å›¾ï¼Œæ˜¾ç¤ºå›¾ -->
              <image wx:if="{{imgReceipt}}" src="{{imgReceipt}}" mode="aspectFill" class="uploaded-img" />
              <!-- æ²¡å›¾ï¼Œæ˜¾ç¤ºåŠ å· -->
              <block wx:else>
                <text class="plus-icon">+</text>
                <text>è´­ä¹°æˆªå›¾</text>
              </block>
            </view>

            <!-- æ¡†2ï¼šèŠå¤©è®°å½• -->
            <view class="upload-box" wx:if="{{bindType == 'used'}}" bindtap="chooseProofImage" data-type="chat">
              <image wx:if="{{imgChat}}" src="{{imgChat}}" mode="aspectFill" class="uploaded-img" />
              <block wx:else>
                <text class="plus-icon">+</text>
                <text>èŠå¤©è®°å½•</text>
              </block>
            </view>
          </view>
        </view>

        <view class="form-item">
          <text class="form-label">è´­ä¹°æ—¥æœŸ</text>
          <picker mode="date" bindchange="onDateChange">
            <view class="picker-val">{{buyDate || 'è¯·é€‰æ‹©æ—¥æœŸ'}}</view>
          </picker>
        </view>
        
        <view style="height: 40rpx;"></view>
      </scroll-view>

      <view class="modal-footer">
        <!-- ç»‘å®š submitAudit -->
        <button class="submit-btn" bindtap="submitAudit">æäº¤ä¸Šä¼ å®¡æ ¸</button>
      </view>

    </view>
  </view>

</view>
