<!-- pages/my/my.wxml -->

<view class="container">

  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <view class="header">
    <view class="back-icon" catchtap="goBack">
      <text style="font-size: 48rpx; font-weight: 300; color: #000; line-height: 1;">â€¹</text>
    </view>
  </view>

  <!-- 2. ç”¨æˆ·ä¸ªäººä¿¡æ¯ - ã€ç®¡ç†å‘˜æ¨¡å¼ä¸‹éšè—ã€‘ -->
  <view class="profile-header" wx:if="{{!isAdmin}}">
    <view class="header-content">
      <view class="user-identity">
        <text class="rank-tag">PLATINUM MEMBER</text>
        <text class="user-name">{{userName}}</text>
      </view>
      <view class="header-stats">
        <view class="stat-item">
          <text class="label">æ‹¥æœ‰äº§å“æ•°é‡</text>
          <text class="value">{{deviceList.length}} ä»¶</text>
        </view>
        <view class="divider-v"></view>
        <view class="stat-item">
          <text class="label">ä¼šå‘˜ç­‰çº§</text>
          <text class="value platinum">é“‚é‡‘å°Šäº«ä¼šå‘˜</text>
        </view>
      </view>
    </view>
  </view>

  <!-- === ã€æ ¸å¿ƒä¿®æ”¹åŒºåŸŸï¼šç®¡ç†å‘˜ç•Œé¢ã€‘ === -->
  <block wx:if="{{isAdmin}}">
    
    <!-- 1. æ ‡é¢˜æ  + åˆ‡æ¢æŒ‰é’® -->
    <view class="admin-header-row">
      <view class="admin-page-title">
        {{showShippedMode ? 'å‘è´§è®°å½•' : 'å¾…å¤„ç†è®¢å•'}}
      </view>
      
      <!-- å³ä¾§åˆ‡æ¢æŒ‰é’® -->
      <view class="switch-view-btn {{showShippedMode ? 'active' : ''}}" bindtap="toggleViewMode">
        {{showShippedMode ? 'â† è¿”å›å¾…å¤„ç†' : 'æŸ¥çœ‹å·²å‘è´§ â”'}}
      </view>
    </view>

    <!-- 2. æ¨¡å¼Aï¼šå¾…å‘è´§ (æ¨ªå‘ Swiper) -->
    <swiper 
      wx:if="{{!showShippedMode}}"
      class="order-swiper" 
      bindchange="onOrderChange" 
      circular 
      previous-margin="60rpx" 
      next-margin="60rpx"
      style="height: {{swiperHeight}}px; transition: height 0.3s ease;"
    >
      <!-- å¦‚æœæ²¡æœ‰å¾…å‘è´§è®¢å• -->
      <swiper-item wx:if="{{pendingList.length === 0}}">
        <view class="empty-card">ğŸ‰ å¤ªæ£’äº†ï¼Œæ‰€æœ‰è®¢å•éƒ½å·²å‘è´§ï¼</view>
      </swiper-item>

      <!-- å¾ªç¯ pendingList -->
      <swiper-item wx:for="{{pendingList}}" wx:key="id" wx:for-index="idx">
        <view class="order-card detail-mode" id="card-{{idx}}">
          
          <!-- 1. å¤´éƒ¨ï¼šä¿®å¤ä½ç½®ä¸å¯¹çš„é—®é¢˜ -->
          <view class="card-header">
            <view class="order-id-group">
              <text class="order-label">è®¢å•å·</text>
              <text class="order-val">{{item.orderId}}</text>
            </view>
            <view class="status-tag {{item.realStatus}}">{{item.statusText}}</view>
          </view>

          <!-- ã€å…³é”®ã€‘ä¹°å®¶ä¿¡æ¯æ ï¼šæ˜¾ç¤ºæ˜µç§°ã€ç”µè¯ã€åœ°å€ -->
          <view class="buyer-info-box">
            <view class="b-row">
              <text class="b-name">{{item.userName || 'åŒ¿åç”¨æˆ·'}}</text>
              <text class="b-phone">{{item.userPhone}}</text>
            </view>
            <view class="b-addr">{{item.userAddr}}</view>
          </view>

          <!-- 2. ä¸­é—´å•†å“åˆ—è¡¨ -->
          <view class="goods-detail-list">
            <view class="mini-tag">è´­ç‰©æ¸…å•</view>
            <block wx:for="{{item.goodsList}}" wx:for-item="g" wx:key="index">
              <view class="g-item">
                <view class="g-info">
                  <text class="g-n">{{g.name}}</text>
                  <text class="g-s">{{g.spec}}</text>
                </view>
                <view class="g-count">x{{g.quantity}}</view>
                <view class="g-p">Â¥{{g.total}}</view>
              </view>
            </block>
          </view>

          <!-- 3. åº•éƒ¨ï¼šåˆè®¡ + æ“ä½œæŒ‰é’® -->
          <view class="card-footer-new">
            <view class="total-row">
              <text class="time-text">{{item.createTime}}</text>
              <view class="price-box">
                <text>å®ä»˜</text> 
                <!-- ã€ä¿®æ”¹ã€‘ç»™é‡‘é¢åŠ ä¸Šç‚¹å‡»äº‹ä»¶ï¼ˆç®¡ç†å‘˜å¾…å‘è´§ä¹Ÿå¯ä»¥æ”¹ä»·ï¼‰ -->
                <text 
                  class="price-num {{isAdmin && item.realStatus === 'PAID' ? 'editable-price' : ''}}" 
                  catchtap="adminModifyPrice" 
                  data-id="{{item.id}}" 
                  data-price="{{item.amount}}"
                  data-status="{{item.realStatus}}">
                  Â¥{{item.amount}}
                </text>
              </view>
            </view>
            <view class="admin-ship-btn" catchtap="adminShipOrder" data-id="{{item.id}}">å½•å…¥å•å·å¹¶å‘è´§</view>
          </view>
        </view>
      </swiper-item>
    </swiper>

    <!-- [æ–°å¢] ç»´ä¿®å·¥å•å¤„ç†åŒº -->
    <view class="section-label" wx:if="{{repairList.length > 0}}">PENDING REPAIRS / å¾…å¤„ç†æŠ¥ä¿®</view>
    
    <view class="repair-list-admin">
      <block wx:for="{{repairList}}" wx:key="_id">
        <view class="repair-admin-card">
          <!-- è§†é¢‘é¢„è§ˆ -->
          <video src="{{item.videoFileID}}" class="repair-video" controls></video>
          
          <!-- ä¿¡æ¯ -->
          <view class="repair-info">
            <view class="r-title">{{item.model}} - {{item.contact.name}}</view>
            <view class="r-desc">"{{item.description}}"</view>
            <view class="r-addr">{{item.contact.address}}</view>
          </view>
          
          <!-- ä¸¤ä¸ªæŒ‰é’® -->
          <view class="repair-actions">
            <view class="r-btn tutorial" bindtap="resolveRepair" data-id="{{item._id}}" data-type="tutorial">çœ‹æ•™ç¨‹å¯ä¿®</view>
            <view class="r-btn ship" bindtap="resolveRepair" data-id="{{item._id}}" data-type="ship">å½•å•å‘è´§</view>
          </view>
        </view>
      </block>
    </view>

    <!-- 3. æ¨¡å¼Bï¼šå·²å‘è´§ (çºµå‘ ScrollView) -->
    <scroll-view 
      wx:if="{{showShippedMode}}" 
      scroll-y 
      class="history-scroll-view"
    >
      <view class="history-list-container">
        <block wx:for="{{shippedList}}" wx:key="id">
          <!-- å†å²è®¢å•å¡ç‰‡ (ç¨å¾®ç®€åŒ–ä¸€ç‚¹ï¼Œä¸éœ€è¦å¤§æŒ‰é’®) -->
          <view class="order-card detail-mode history-item">
             <!-- å¤´éƒ¨ -->
             <view class="card-header">
                <text class="order-val">{{item.orderId}}</text>
                <view class="status-tag {{item.realStatus}}">{{item.statusText}}</view>
             </view>
             <!-- ä¹°å®¶ (ç²¾ç®€æ˜¾ç¤º) -->
             <view class="buyer-info-box small">
                <text class="b-name">{{item.userName}}</text>
                <text style="margin:0 10rpx; color:#ddd;">|</text>
                <text class="b-addr">{{item.userAddr}}</text>
             </view>
             <!-- åº•éƒ¨ -->
             <view class="card-footer-new">
                <text class="time-text">{{item.createTime}}</text>
                <!-- æŸ¥çœ‹ç‰©æµæŒ‰é’® -->
                <view class="btn-logistics-action small" catchtap="viewLogisticsDetail" data-sn="{{item.trackingId}}">
                  æŸ¥çœ‹ç‰©æµ
                </view>
             </view>
          </view>
        </block>
        <view class="end-tip">- ä»…æ˜¾ç¤ºæœ€è¿‘å†å²è®°å½• -</view>
      </view>
    </scroll-view>

  </block>

  <!-- æ™®é€šç”¨æˆ·è§†å›¾ (ä¿æŒä¸å˜ï¼Œè¿˜æ˜¯ç”¨åŸæ¥çš„ swiper orders) -->
  <block wx:if="{{!isAdmin}}">
    <!-- æƒ…å†µ A: æœ‰è®¢å•ï¼Œæ˜¾ç¤ºæ»‘åŠ¨åˆ—è¡¨ -->
    <swiper 
      wx:if="{{orders.length > 0}}"
      class="order-swiper" 
      bindchange="onOrderChange" 
      circular 
      previous-margin="60rpx" 
      next-margin="60rpx"
      style="height: {{swiperHeight}}px; transition: height 0.3s ease;"
    >
      <swiper-item wx:for="{{orders}}" wx:key="id" wx:for-index="idx">
        <view class="order-card detail-mode" id="card-{{idx}}">
          
          <!-- 1. å¤´éƒ¨ -->
          <view class="card-header">
            <view class="order-id-group">
              <text class="order-label">è®¢å•å·</text>
              <text class="order-val">{{item.orderId}}</text>
            </view>
            <view class="status-tag {{item.realStatus}}">{{item.statusText}}</view>
          </view>

          <!-- ä¹°å®¶ä¿¡æ¯æ  -->
          <view class="buyer-info-box">
            <view class="b-row">
              <text class="b-name">{{item.userName || 'åŒ¿åç”¨æˆ·'}}</text>
              <text class="b-phone">{{item.userPhone}}</text>
            </view>
            <view class="b-addr">{{item.userAddr}}</view>
          </view>

          <!-- å•†å“åˆ—è¡¨ -->
          <view class="goods-detail-list">
            <view class="mini-tag">è´­ç‰©æ¸…å•</view>
            <block wx:for="{{item.goodsList}}" wx:for-item="g" wx:key="index">
              <view class="g-item">
                <view class="g-info">
                  <text class="g-n">{{g.name}}</text>
                  <text class="g-s">{{g.spec}}</text>
                </view>
                <view class="g-count">x{{g.quantity}}</view>
                <view class="g-p">Â¥{{g.total}}</view>
              </view>
            </block>
          </view>

          <!-- åº•éƒ¨ -->
          <view class="card-footer-new">
            <view class="total-row">
              <text class="time-text">{{item.createTime}}</text>
              <view class="price-box">
                <text>å®ä»˜</text> 
                <!-- ã€ä¿®æ”¹ã€‘ç»™é‡‘é¢åŠ ä¸Šç‚¹å‡»äº‹ä»¶ -->
                <!-- å¢åŠ ä¸€ä¸ª editable-price ç±»åï¼Œå¦‚æœæ˜¯ç®¡ç†å‘˜ä¸”æœªæ”¯ä»˜ï¼Œæ˜¾ç¤ºè™šçº¿æç¤ºå¯ç‚¹ -->
                <text 
                  class="price-num {{isAdmin && item.realStatus === 'UNPAID' ? 'editable-price' : ''}}" 
                  catchtap="adminModifyPrice" 
                  data-id="{{item.id}}" 
                  data-price="{{item.amount}}"
                  data-status="{{item.realStatus}}">
                  Â¥{{item.amount}}
                </text>
              </view>
            </view>

            <!-- 1. å¾…ä»˜æ¬¾ï¼šæ˜¾ç¤ºæ“ä½œæŒ‰é’® -->
            <view wx:if="{{item.realStatus === 'UNPAID'}}" class="action-row-right">
              
              <!-- ã€æ–°å¢ã€‘å·¦ä¾§çš„å–æ¶ˆè®¢å•æŒ‰é’® -->
              <view class="btn-mini outline-red" catchtap="userCancelOrder" data-id="{{item.id}}">
                å–æ¶ˆè®¢å•
              </view>

              <!-- ä¸­é—´çš„å ä½ï¼ˆå¦‚æœæœ‰æ¨¡æ‹Ÿæ”¯ä»˜ï¼‰ -->
              <view class="btn-mini gray" catchtap="debugSimulatePay" data-id="{{item.id}}">
                âš¡ï¸ æ¨¡æ‹Ÿ
              </view>

              <!-- å³ä¾§çš„æ”¯ä»˜æŒ‰é’® -->
              <view class="btn-mini black" catchtap="repayOrder" data-item="{{item}}">
                ç«‹å³æ”¯ä»˜
              </view>
              
            </view>

            <!-- 3. è¿è¾“ä¸­ï¼šæ‰€æœ‰äººéƒ½èƒ½çœ‹ç‰©æµ -->
            <view 
              wx:if="{{item.realStatus === 'SHIPPED'}}" 
              class="logistics-btn" 
              catchtap="viewLogisticsDetail" 
              data-sn="{{item.trackingId}}">
              æŸ¥çœ‹ç‰©æµ ({{item.trackingId}})
            </view>

          </view>
        </view>
      </swiper-item>
    </swiper>

    <!-- æƒ…å†µ B: æ²¡è®¢å•ï¼Œæ˜¾ç¤ºè¯±å¯¼å¡ç‰‡ -->
    <view 
      wx:else 
      class="empty-order-card" 
      bindtap="goToShop"
    >
      <view class="empty-content">
        <view class="empty-icon">ğŸ“¦</view>
        <view class="empty-title">å¼€å¯æ‚¨çš„æ”¹è£…ä¹‹æ—…</view>
        <view class="empty-desc">ä¸‹å•åï¼Œæ­¤å¤„å°†å®æ—¶è¿½è¸ªæ‚¨çš„ç‰©æµè¿›åº¦</view>
        
        <view class="go-shop-btn">å»é€‰è´­é…ä»¶ â”</view>
      </view>
    </view>
  </block>

  <!-- === æ”¹åŠ¨1ï¼šç®¡ç†å‘˜å®¡æ ¸åŒº (Swiperç‰ˆ) === -->
  <block wx:if="{{isAdmin && auditList.length > 0}}">
    <view class="section-label">PENDING AUDITS / å¾…å®¡æ ¸ç”³è¯·</view>
    
    <swiper 
      class="audit-swiper" 
      circular 
      previous-margin="60rpx" 
      next-margin="60rpx"
    >
      <swiper-item wx:for="{{auditList}}" wx:key="_id">
        <view class="audit-card">
          <view class="audit-row">
            <text class="audit-model">{{item.productModel}}</text>
            <text class="audit-sn">SN: {{item.sn}}</text>
          </view>
          <view class="audit-row">
            <!-- è¿™é‡Œåªåšå±•ç¤ºï¼Œä¿®æ”¹åœ¨å¼¹çª—é‡Œ -->
            <text class="audit-date">ç”¨æˆ·å¡«: {{item.buyDate}}</text>
            <text class="audit-type">{{item.bindType == 'new' ? 'å…¨æ–°' : 'äºŒæ‰‹'}}</text>
          </view>
          
          <view class="audit-imgs">
            <image src="{{item.imgReceipt}}" mode="aspectFill" class="audit-thumb" bindtap="previewImage" data-url="{{item.imgReceipt}}"></image>
            <image wx:if="{{item.imgChat}}" src="{{item.imgChat}}" mode="aspectFill" class="audit-thumb" bindtap="previewImage" data-url="{{item.imgChat}}"></image>
          </view>

          <view class="audit-actions">
            <!-- æ‹’ç»ç›´æ¥è°ƒç”¨ -->
            <view class="audit-btn reject" catchtap="handleReject" data-id="{{item._id}}">æ‹’ç»</view>
            <!-- é€šè¿‡æ‰“å¼€å¼¹çª— -->
            <view class="audit-btn approve" catchtap="openAuditModal" data-item="{{item}}">å®¡æ ¸è®¾ç½®</view>
          </view>
        </view>
      </swiper-item>
    </swiper>
  </block>

  <!-- 5. è®¾å¤‡åˆ—è¡¨ - ã€ç®¡ç†å‘˜æ¨¡å¼ä¸‹éšè—ã€‘ -->
  <block wx:if="{{!isAdmin}}">
    <view class="section-label">MY DEVICES / äº§å“è®¾å¤‡</view>
    <view class="device-card" wx:for="{{deviceList}}" wx:key="sn">
      <view class="remove-icon" bindtap="removeDevice" data-index="{{index}}">âœ•</view>
      <view class="device-name">{{item.name}}</view>
      <view class="spec-list">
        <view class="spec-row">
          <text class="label">S/N åºåˆ—å·</text>
          <text class="value mono">{{item.sn}}</text>
        </view>
        <view class="spec-row">
          <text class="label">æ€»å‰©ä½™è´¨ä¿</text>
          <view class="warranty-val">
            <!-- å‰©ä½™å¤©æ•° -->
            <text class="days-num {{item.days < 30 ? 'warning' : ''}}">{{item.days}} Days</text>
            
            <!-- ğŸ‘‡ğŸ‘‡ğŸ‘‡ [æ–°å¢] èµ é€è´¨ä¿æ ‡è®° ğŸ‘‡ğŸ‘‡ğŸ‘‡ -->
            <view class="reward-tag" wx:if="{{item.hasReward}}">
               <text>ğŸ å·²è·èµ 30å¤©</text>
            </view>
            <!-- ğŸ‘†ğŸ‘†ğŸ‘† åªæœ‰ hasReward ä¸º true æ—¶æ‰æ˜¾ç¤º ğŸ‘†ğŸ‘†ğŸ‘† -->
            
            <!-- åŸæœ‰çš„å»¶ä¿æ ‡è®° (å¦‚æœæœ‰) -->
            <text class="ext-tag" wx:if="{{item.hasExtra && !item.hasReward}}">å«å»¶ä¿</text>
          </view>
        </view>
        <view class="spec-row">
          <text class="label">è´¨ä¿åˆ°æœŸæ—¥æœŸ</text>
          <text class="value">{{item.expiryDate}}</text>
        </view>
        <view class="spec-row">
          <text class="label">æ¿€æ´»æ¬¡æ•°</text>
          <text class="value">{{item.activations}} æ¬¡</text>
        </view>
        <view class="spec-row">
          <text class="label">å›ºä»¶ç‰ˆæœ¬</text>
          <text class="value">{{item.firmware}}</text>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨æ·»åŠ è®¾å¤‡å¤§æŒ‰é’® -->
    <view class="device-card add-mode" bindtap="openBindModal">
      <view class="add-content">
        <text class="big-plus">+</text>
        <text class="add-tips">ç»‘å®šæ–°äº§å“</text>
      </view>
    </view>

    <!-- ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€æ ¸å¿ƒè¡¥å…¨ã€‘åœ¨è¿™é‡Œæ’å…¥ç”³è¯·è®°å½•åˆ—è¡¨ ğŸ‘‡ğŸ‘‡ğŸ‘‡ -->
    <view class="section-label" wx:if="{{myActivityList.length > 0}}">MY ACTIVITIES / ç”³è¯·è¿›åº¦</view>
    
    <view class="activity-list" wx:if="{{myActivityList.length > 0}}">
      <block wx:for="{{myActivityList}}" wx:key="_id">
        <!-- ç‚¹å‡»é©³å›çš„å¡ç‰‡å¯ä»¥é‡æ–°ä¸Šä¼  -->
        <view class="act-card" bindtap="{{item.status == -1 ? 'reUpload' : ''}}" data-item="{{item}}">
          
          <!-- ğŸ”´ ä¸»è¦å†…å®¹åŒºåŸŸï¼šä¿æŒæ¨ªå‘å¸ƒå±€ -->
          <view class="act-main-row">
            <view class="act-left">
              <!-- æ ‡é¢˜ï¼šæ˜¾ç¤ºæ˜¯è§†é¢‘è¿˜æ˜¯è®¾å¤‡ -->
              <view class="act-title">
                <text class="act-tag {{item.type}}">{{item.type === 'video' ? 'è§†é¢‘' : (item.type === 'repair' ? 'æ•…éšœ' : 'è®¾å¤‡')}}</text>
                <text class="act-name">{{item.title}}</text>
              </view>
              <view class="act-time">{{item.createTime}}</view>
            </view>
            
            <!-- å³ä¾§çŠ¶æ€ -->
            <view class="act-right">
              <!-- å®¡æ ¸ä¸­ (0 æˆ– PENDING) -->
              <view class="status-pill processing" wx:if="{{(item.type !== 'repair') && (item.status === 0 || item.status === 'PENDING')}}">
                <view class="dot-p"></view>å®¡æ ¸ä¸­
              </view>
              
              <!-- å·²é€šè¿‡ (1 æˆ– APPROVED) -->
              <view class="status-pill success" wx:if="{{(item.type !== 'repair') && (item.status === 1 || item.status === 'APPROVED')}}">
                <view class="dot-s"></view>å·²é€šè¿‡
              </view>
              
              <!-- å·²é©³å› (-1 æˆ– REJECTED) -->
              <view class="status-pill fail" wx:if="{{item.status === -1 || item.status === 'REJECTED'}}">å·²é©³å›</view>
              
              <!-- [æ–°å¢] ç»´ä¿®å•ç‰¹æ®ŠçŠ¶æ€ -->
              
              <!-- å·²å‘è´§ï¼ˆä½¿ç”¨ statusNum åˆ¤æ–­ï¼‰ -->
              <view class="status-pill success" wx:if="{{item.type === 'repair' && (item.status === 1 || item.status === 'SHIPPED') && item.trackingId}}">
                å·²å‘è´§ {{item.trackingId}}
              </view>
              
              <!-- çœ‹æ•™ç¨‹ (è“è‰²) -->
              <view class="status-pill info" wx:if="{{item.type === 'repair' && (item.status === 1 || item.status === 'TUTORIAL') && !item.trackingId}}">
                æŸ¥çœ‹æ•™ç¨‹å¯ä¿®å¤
              </view>
              
              <!-- ç»´ä¿®å•å®¡æ ¸ä¸­ -->
              <view class="status-pill processing" wx:if="{{item.type === 'repair' && (item.status === 0 || item.status === 'PENDING')}}">
                <view class="dot-p"></view>å®¡æ ¸ä¸­
              </view>
            </view>
          </view>
          
          <!-- ğŸ”´ æ‹’ç»ç†ç”±ç‹¬ç«‹æ˜¾ç¤ºåœ¨ä¸‹æ–¹ï¼Œå®Œå…¨ä¸å½±å“ä¸Šé¢çš„å¸ƒå±€ -->
          <view class="reject-reason-wrapper" wx:if="{{(item.status === -1 || item.status === 'REJECTED') && item.rejectReason}}">
            <view class="reject-reason">
              <text class="reason-label">æ‹’ç»ç†ç”±ï¼š</text>
              <text class="reason-text">{{item.rejectReason}}</text>
            </view>
          </view>

        </view>
      </block>
    </view>
    <!-- ğŸ‘†ğŸ‘†ğŸ‘†ã€æ ¸å¿ƒè¡¥å…¨ã€‘ç»“æŸ ğŸ‘†ğŸ‘†ğŸ‘† -->

    <!-- 4. åº•éƒ¨æœåŠ¡æŒ‰é’® -->
    <view class="footer-bar">
      <view class="f-btn">é¢„çº¦ç»´ä¿®æœåŠ¡</view>
      <view class="f-btn dark">è”ç³»åœ¨çº¿å®¢æœ</view>
    </view>
  </block>

  <!-- 5. ç»‘å®šæ¨¡æ€æ¡† -->
  <view class="modal {{showModal ? 'show' : ''}}">
    <view class="modal-content">
      
      <!-- 1. æ–‡æ¡ˆä¿®æ”¹ï¼šç»‘å®šè®¾å¤‡ -->
      <view class="modal-header">
        <text>ç»‘å®šè®¾å¤‡</text>
        <view class="close-modal" bindtap="closeBindModal">âœ•</view>
      </view>

      <scroll-view scroll-y="true" class="modal-scroll-area">
        
        <!-- === 2. è“ç‰™æ‰«ææŒ‰é’® (é›·è¾¾) === -->
        <!-- åªæœ‰æœªè¿æ¥æ—¶æ˜¾ç¤º -->
        <view class="bt-scan-container" wx:if="{{!bluetoothReady}}">
          <view class="radar-circle" bindtap="startConnect">
            <view class="radar-core">
              <!-- ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ¢æˆå›¾ç‰‡ ğŸ‘‡ğŸ‘‡ğŸ‘‡ -->
              <image class="bt-icon-img" src="data:image/svg+xml;base64,PHN2ZyB0PSIxNzEwNDg4ODg4ODg4IiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjQ3NTciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCI+PHBhdGggZD0iTTIyMy41NTIgNzI0LjQ4TDQ2NS45MiA1MTIgMjIzLjU1MiAyOTkuNTJsNTguOTA4LTY3LjI4TDQ5OC41MiA0MjEuNjg4VjM1Ljg0aDg5LjY4bDIzMC40IDIyNC42NC0yNDIuNTI4IDIxMi40OCAyNDIuNTI4IDIxMi40OC0yMzAuNCAyMjQuNjRINDk4LjUyVjYwMi4zMTJsLTIxNi4wNjQgMTg5LjQ0LTU4LjkwOC02Ny4yN3pNNTgyLjM1MiA1MTJMNjg4IDE5NC43NTIgNTg4LjE2IDk3LjQ0VjUxMnpNNTg4LjE2IDkyNi41Nkw2ODggODI5LjI0OCA1ODIuMzUyIDUxMnY0MTQuNTZ6IiBmaWxsPSIjRkZGRkZGIiBwLWlkPSI0NzU4Ij48L3BhdGg+PC9zdmc+" mode="aspectFit"></image>
            </view>
            
            <!-- æ³¢çº¹åŠ¨ç”» (ä¿æŒç»“æ„ï¼Œæ ·å¼ä¸‹é¢é‡å†™) -->
            <view class="radar-ring r1 {{isScanning?'anim':''}}"></view>
            <view class="radar-ring r2 {{isScanning?'anim':''}}"></view>
            <view class="radar-ring r3 {{isScanning?'anim':''}}"></view>
          </view>
          <text class="radar-tip">{{connectStatusText}}</text>
        </view>

        <!-- === 3. è¿æ¥æˆåŠŸåçš„çŠ¶æ€æ¡ === -->
        <view class="bt-connected-bar" wx:if="{{bluetoothReady}}">
          <view class="bt-c-icon">âœ…</view>
          <view class="bt-c-info">
            <text class="bt-c-name">å·²è¿æ¥è®¾å¤‡</text>
            <text class="bt-c-sn">{{connectedDeviceName}}</text>
          </view>
          <view class="bt-disconnect-btn" bindtap="resetBluetoothState">æ–­å¼€</view>
        </view>

        <!-- === 4. Tab åˆ‡æ¢ (é€»è¾‘ä¿®æ”¹ï¼šè¿ä¸Šè“ç‰™åæ‰æ˜¾ç¤ºï¼) === -->
        <view class="type-tabs" wx:if="{{bluetoothReady && !isDeviceLocked}}">
          <view class="tab-item {{bindType == 'new' ? 'active' : ''}}" bindtap="changeBindType" data-type="new">å…¨æ–°è®¾å¤‡</view>
          <view class="tab-item {{bindType == 'used' ? 'active' : ''}}" bindtap="changeBindType" data-type="used">äºŒæ‰‹/æ—§è®¾å¤‡</view>
        </view>

        <!-- === 5. è¢«é”çŠ¶æ€ === -->
        <view class="locked-view" wx:if="{{bluetoothReady && isDeviceLocked}}">
          <view class="locked-icon">ğŸš«</view>
          <text class="locked-title">æ— æ³•ç»‘å®š</text>
          <text class="locked-desc">{{lockedReason}}</text>
        </view>

        <!-- === 6. æ­£å¸¸å¡«è¡¨åŒºåŸŸ (è¿ä¸Šä¸”æ²¡é”æ‰æ˜¾ç¤º) === -->
        <view class="bind-form-area" wx:if="{{bluetoothReady && !isDeviceLocked}}">
          
          <view class="form-item">
            <text class="form-label">é€‰æ‹©äº§å“å‹å·</text>
            <picker bindchange="onModelChange" range="{{modelOptions}}">
              <view class="picker-val">{{modelOptions[modelIndex] || 'è¯·é€‰æ‹©å‹å·'}}</view>
            </picker>
          </view>

          <view class="form-item">
            <text class="form-label">{{bindType == 'new' ? 'ä¸Šä¼ å‡­è¯ (è´­ä¹°æˆªå›¾)' : 'ä¸Šä¼ å‡­è¯ (è´­ä¹°æˆªå›¾ + èŠå¤©è®°å½•)'}}</text>
            <view class="upload-group">
              <view class="upload-box" bindtap="chooseProofImage" data-type="receipt">
                <image wx:if="{{imgReceipt}}" src="{{imgReceipt}}" mode="aspectFill" class="uploaded-img" />
                <block wx:else><text class="plus-icon">+</text><text>è´­ä¹°æˆªå›¾</text></block>
              </view>
              <view class="upload-box" wx:if="{{bindType == 'used'}}" bindtap="chooseProofImage" data-type="chat">
                <image wx:if="{{imgChat}}" src="{{imgChat}}" mode="aspectFill" class="uploaded-img" />
                <block wx:else><text class="plus-icon">+</text><text>èŠå¤©è®°å½•</text></block>
              </view>
            </view>
          </view>

          <view class="form-item">
            <text class="form-label">è´­ä¹°æ—¥æœŸ</text>
            <picker mode="date" bindchange="onDateChange">
              <view class="picker-val">{{buyDate || 'è¯·é€‰æ‹©æ—¥æœŸ'}}</view>
            </picker>
          </view>
        </view>
        
        <view style="height: 40rpx;"></view>
      </scroll-view>

      <!-- åº•éƒ¨æäº¤æŒ‰é’® -->
      <view class="modal-footer" wx:if="{{bluetoothReady && !isDeviceLocked}}">
        <button class="submit-btn" bindtap="submitAudit">æäº¤ä¸Šä¼ å®¡æ ¸</button>
      </view>

    </view>
  </view>

  <!-- === æ”¹åŠ¨2ï¼šç®¡ç†å‘˜å®¡æ ¸å¼¹çª— (æ”¾åœ¨æœ€åº•éƒ¨) === -->
  <view class="modal {{showAuditModal ? 'show' : ''}}" style="z-index: 2000;">
    <view class="modal-content">
      <view class="modal-header">
        <text>å®¡æ‰¹è®¾ç½®</text>
        <view class="close-modal" bindtap="closeAuditModal">âœ•</view>
      </view>

      <view class="modal-scroll-area">
        <view class="form-item">
          <text class="form-label">ä¿®æ”¹è´­ä¹°æ—¥æœŸ (å½±å“å›ºä»¶ç‰ˆæœ¬)</text>
          <picker mode="date" value="{{adminSetDate}}" bindchange="onAdminDateChange">
            <view class="picker-val">{{adminSetDate || 'è¯·é€‰æ‹©æ—¥æœŸ'}}</view>
          </picker>
        </view>

        <view class="form-item">
          <text class="form-label">è®¾ç½®æ€»è´¨ä¿æ—¶é—´</text>
          <picker range="{{warrantyOptions}}" value="{{adminSetDaysIndex}}" bindchange="onAdminDaysChange">
            <view class="picker-val">{{warrantyOptions[adminSetDaysIndex]}}</view>
          </picker>
        </view>
      </view>

      <view class="modal-footer">
        <button class="submit-btn" bindtap="confirmApprove">ç¡®è®¤é€šè¿‡å¹¶åŒæ­¥</button>
      </view>
    </view>
  </view>

  <!-- ================= å…¨å±€è‡ªå®šä¹‰å¼¹çª— (æ›¿ä»£åŸç”Ÿ) ================= -->
  <view class="custom-dialog-mask" wx:if="{{dialog.show}}">
    <view class="custom-dialog-box">
      <view class="cd-title">{{dialog.title}}</view>
      <view class="cd-content">{{dialog.content}}</view>
      
      <view class="cd-btn-row">
        <!-- å–æ¶ˆæŒ‰é’® (å¯é€‰) -->
        <view class="cd-btn cancel" wx:if="{{dialog.showCancel}}" bindtap="closeCustomDialog">{{dialog.cancelText || 'å–æ¶ˆ'}}</view>
        <!-- ç¡®è®¤æŒ‰é’® -->
        <view class="cd-btn confirm" bindtap="onDialogConfirm">{{dialog.confirmText || 'ç¡®å®š'}}</view>
      </view>
    </view>
  </view>

  <!-- ================= å…¨å±€è‡ªå®šä¹‰ Loading (æç®€é»‘) ================= -->
  <view class="custom-loading-mask" wx:if="{{isLoading}}">
    <view class="loading-box">
      <!-- çº¯CSSç”»çš„é«˜æ¸…é»‘è‰²Loadingåœˆ -->
      <view class="spinner"></view>
      <text class="loading-text">{{loadingText}}</text>
    </view>
  </view>

  <!-- ================= è¾“å…¥å¼¹çª— (æ›¿ä»£ editable modal) ================= -->
  <view class="custom-dialog-mask" wx:if="{{inputDialog.show}}">
    <view class="custom-dialog-box">
      <view class="cd-title">{{inputDialog.title}}</view>
      <input 
        class="cd-input" 
        type="text" 
        placeholder="{{inputDialog.placeholder}}"
        value="{{inputDialog.value}}"
        bindinput="onInputDialogInput"
        confirm-type="done"
        bindconfirm="onInputDialogConfirm"
      />
      <view class="cd-btn-row">
        <view class="cd-btn cancel" bindtap="closeInputDialog">å–æ¶ˆ</view>
        <view class="cd-btn confirm" bindtap="onInputDialogConfirm">ç¡®å®š</view>
      </view>
    </view>
  </view>

</view>
