<!-- pages/my/my.wxml -->

<view class="container">

  <!-- 1. é¡¶éƒ¨è¿”å›æŒ‰é’® (ä¸€ç›´å­˜åœ¨) -->
  <view class="nav-back-fixed" bindtap="goBack">
    <text class="back-arrow">â†</text>
  </view>

  <!-- 2. ç”¨æˆ·ä¸ªäººä¿¡æ¯ - ã€ç®¡ç†å‘˜æ¨¡å¼ä¸‹éšè—ã€‘ -->
  <view class="profile-header" wx:if="{{!isAdmin}}">
    <view class="header-content">
      <view class="user-identity">
        <text class="rank-tag">PLATINUM MEMBER</text>
        <text class="user-name">Alexander</text>
      </view>
      <view class="header-stats">
        <view class="stat-item">
          <text class="label">æ‹¥æœ‰äº§å“æ•°é‡</text>
          <text class="value">{{deviceList.length}} ä»¶</text>
        </view>
        <view class="divider-v"></view>
        <view class="stat-item">
          <text class="label">ä¼šå‘˜ç­‰çº§</text>
          <text class="value platinum">é“‚é‡‘å°Šäº«ä¼šå‘˜</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 3. ç®¡ç†å‘˜ä¸“å±æ ‡é¢˜ -->
  <view class="admin-page-title" wx:if="{{isAdmin}}">è®¢å•ç®¡ç†åå°</view>

  <!-- 4. è®¢å•åŒºåŸŸ -->
  <view class="section-label">
    {{isAdmin ? 'ALL ORDERS / å…¨éƒ¨è®¢å•' : 'LIVE ORDERS / å®æ—¶è®¢å•'}}
  </view>

  <swiper class="order-swiper" bindchange="onOrderChange" circular style="height: 900rpx;">
    <swiper-item wx:for="{{orders}}" wx:key="id">
      <view class="order-card detail-mode">
        
        <!-- 1. å¤´éƒ¨ï¼šä¿®å¤ä½ç½®ä¸å¯¹çš„é—®é¢˜ -->
        <!-- ä½¿ç”¨ flex å¸ƒå±€ï¼Œè®©å•å·åœ¨å·¦ï¼ŒçŠ¶æ€åœ¨å³ -->
        <view class="card-header">
          <view class="order-id-group">
            <text class="order-label">è®¢å•å·</text>
            <text class="order-val">{{item.orderId}}</text>
          </view>
          <!-- çŠ¶æ€æ ‡ç­¾ -->
          <text class="status-tag {{item.realStatus}}">
            {{item.statusText}}
          </text>
        </view>

        <!-- ã€å…³é”®ã€‘ä¹°å®¶ä¿¡æ¯æ ï¼šæ˜¾ç¤ºæ˜µç§°ã€ç”µè¯ã€åœ°å€ -->
        <view class="buyer-info-box">
          <view class="b-row">
            <text class="b-name">{{item.userName || 'åŒ¿åç”¨æˆ·'}}</text>
            <text class="b-phone">{{item.userPhone}}</text>
          </view>
          <view class="b-addr">{{item.userAddr}}</view>
        </view>

        <!-- 2. ä¸­é—´å•†å“åˆ—è¡¨ (ä¿æŒä¸å˜) -->
        <view class="goods-detail-list">
          <view class="mini-tag">è´­ç‰©æ¸…å•</view>
          <block wx:for="{{item.goodsList}}" wx:for-item="g" wx:key="index">
            <view class="g-item">
              <view class="g-info">
                <text class="g-n">{{g.name}}</text>
                <text class="g-s">{{g.spec}}</text>
              </view>
              <view class="g-count">x{{g.quantity}}</view>
              <view class="g-p">Â¥{{g.total}}</view>
            </view>
          </block>
        </view>

        <!-- 3. åº•éƒ¨ï¼šåˆè®¡ + æ“ä½œæŒ‰é’® -->
        <view class="card-footer-new">
          <!-- åˆè®¡è¡Œ -->
          <view class="total-row">
            <text class="time-text">{{item.createTime}}</text>
            <view class="price-box">
              <text>å®ä»˜</text> 
              <text class="price-num">Â¥{{item.amount}}</text>
            </view>
          </view>

          <!-- 1. å¾…ä»˜æ¬¾ï¼šæ˜¾ç¤ºæ¨¡æ‹Ÿæ”¯ä»˜ -->
          <view wx:if="{{item.realStatus === 'UNPAID'}}" class="action-row-right">
            <view class="btn-mini gray" catchtap="debugSimulatePay" data-id="{{item.id}}">
              âš¡ï¸ æ¨¡æ‹Ÿæ”¯ä»˜
            </view>
          </view>

          <!-- 2. å¾…å‘è´§ï¼šåªæœ‰ç®¡ç†å‘˜èƒ½çœ‹åˆ°å½•å…¥æŒ‰é’® -->
          <!-- é€»è¾‘ï¼šå¿…é¡»æ˜¯ç®¡ç†å‘˜ AND çŠ¶æ€æ˜¯PAID -->
          <view 
            wx:if="{{isAdmin && item.realStatus === 'PAID'}}" 
            class="admin-ship-btn" 
            catchtap="adminShipOrder" 
            data-id="{{item.id}}">
            å½•å…¥å•å·å¹¶å‘è´§
          </view>

          <!-- 3. è¿è¾“ä¸­ï¼šæ‰€æœ‰äººéƒ½èƒ½çœ‹ç‰©æµ -->
          <view 
            wx:if="{{item.realStatus === 'SHIPPED'}}" 
            class="logistics-btn" 
            catchtap="viewLogisticsDetail" 
            data-sn="{{item.trackingId}}">
            æŸ¥çœ‹ç‰©æµ ({{item.trackingId}})
          </view>

        </view>
      </view>
    </swiper-item>
  </swiper>

  <!-- 5. è®¾å¤‡åˆ—è¡¨ - ã€ç®¡ç†å‘˜æ¨¡å¼ä¸‹éšè—ã€‘ -->
  <block wx:if="{{!isAdmin}}">
    <view class="section-label">MY DEVICES / äº§å“è®¾å¤‡</view>
    <view class="device-card" wx:for="{{deviceList}}" wx:key="sn">
      <view class="remove-icon" bindtap="removeDevice" data-index="{{index}}">âœ•</view>
      <view class="device-name">{{item.name}}</view>
      <view class="spec-list">
        <view class="spec-row">
          <text class="label">S/N åºåˆ—å·</text>
          <text class="value mono">{{item.sn}}</text>
        </view>
        <view class="spec-row">
          <text class="label">æ€»å‰©ä½™è´¨ä¿</text>
          <view class="warranty-val">
            <text class="days-num {{item.days < 30 ? 'warning' : ''}}">{{item.days}} Days</text>
            <text class="ext-tag" wx:if="{{item.hasExtra}}">å«å»¶ä¿</text>
          </view>
        </view>
        <view class="spec-row">
          <text class="label">è´¨ä¿åˆ°æœŸæ—¥æœŸ</text>
          <text class="value">{{item.expiryDate}}</text>
        </view>
        <view class="spec-row">
          <text class="label">æ¿€æ´»æ¬¡æ•°</text>
          <text class="value">{{item.activations}} æ¬¡</text>
        </view>
        <view class="spec-row">
          <text class="label">å›ºä»¶ç‰ˆæœ¬</text>
          <text class="value">{{item.firmware}}</text>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨æ·»åŠ è®¾å¤‡å¤§æŒ‰é’® -->
    <view class="device-card add-mode" bindtap="openBindModal">
      <view class="add-content">
        <text class="big-plus">+</text>
        <text class="add-tips">ç»‘å®šæ–°äº§å“</text>
      </view>
    </view>

    <!-- 4. åº•éƒ¨æœåŠ¡æŒ‰é’® -->
    <view class="footer-bar">
      <view class="f-btn">é¢„çº¦ç»´ä¿®æœåŠ¡</view>
      <view class="f-btn dark">è”ç³»åœ¨çº¿å®¢æœ</view>
    </view>
  </block>

  <!-- 5. ç»‘å®šæ¨¡æ€æ¡† -->
  <view class="modal {{showModal ? 'show' : ''}}">
    <view class="modal-content">
      
      <view class="modal-header">
        <text>ç»‘å®šèµ„äº§</text>
        <view class="close-modal" bindtap="closeBindModal">âœ•</view>
      </view>

      <scroll-view scroll-y="true" class="modal-scroll-area">
        
        <!-- Tab åˆ‡æ¢ -->
        <view class="type-tabs">
          <view class="tab-item {{bindType == 'new' ? 'active' : ''}}" bindtap="changeBindType" data-type="new">å…¨æ–°è®¾å¤‡</view>
          <view class="tab-item {{bindType == 'used' ? 'active' : ''}}" bindtap="changeBindType" data-type="used">äºŒæ‰‹/æ—§è®¾å¤‡</view>
        </view>

        <view class="bt-btn {{bluetoothReady ? 'ready' : ''}}" bindtap="startConnect">
          <text>{{bluetoothReady ? 'âœ… è“ç‰™è®¾å¤‡å·²è¿æ¥' : 'ğŸ“¡ ç‚¹å‡»è¿æ¥è“ç‰™è®¾å¤‡'}}</text>
        </view>

        <view class="form-item">
          <text class="form-label">é€‰æ‹©äº§å“å‹å·</text>
          <picker bindchange="onModelChange" range="{{modelOptions}}">
            <view class="picker-val">{{modelOptions[modelIndex] || 'è¯·é€‰æ‹©å‹å·'}}</view>
          </picker>
        </view>

        <!-- åŠ¨æ€ä¸Šä¼ åŒºåŸŸï¼šæ ¹æ® bindType å˜åŒ– -->
        <view class="form-item">
          <!-- æ ‡é¢˜ä¹Ÿä¼šè·Ÿç€å˜ -->
          <text class="form-label">{{bindType == 'new' ? 'ä¸Šä¼ å‡­è¯ (è´­ä¹°æˆªå›¾)' : 'ä¸Šä¼ å‡­è¯ (è´­ä¹°æˆªå›¾ + èŠå¤©è®°å½•)'}}</text>
          
          <view class="upload-group">
            <!-- æ¡†1ï¼šè´­ä¹°æˆªå›¾ (å§‹ç»ˆæ˜¾ç¤º) -->
            <view class="upload-box">
              <text class="plus-icon">+</text>
              <text>è´­ä¹°æˆªå›¾</text>
            </view>

            <!-- æ¡†2ï¼šèŠå¤©è®°å½• (åªæœ‰ 'used' æ‰æ˜¾ç¤º) -->
            <view class="upload-box" wx:if="{{bindType == 'used'}}">
              <text class="plus-icon">+</text>
              <text>èŠå¤©è®°å½•</text>
            </view>
          </view>
        </view>

        <view class="form-item">
          <text class="form-label">è´­ä¹°æ—¥æœŸ</text>
          <picker mode="date" bindchange="onDateChange">
            <view class="picker-val">{{buyDate || 'è¯·é€‰æ‹©æ—¥æœŸ'}}</view>
          </picker>
        </view>
        
        <view style="height: 40rpx;"></view>
      </scroll-view>

      <view class="modal-footer">
        <button class="submit-btn">æäº¤ä¸Šä¼ å®¡æ ¸</button>
      </view>

    </view>
  </view>

</view>
