<!-- 
  æ ¸å¿ƒä¿®å¤ï¼š
  å†…åµŒ WXS æ¸²æŸ“è„šæœ¬ï¼Œå®ç°ç‰©ç†è·Ÿæ‰‹åŠ¨ç”»ã€‚
  æ ¹æ® dragOffset å®æ—¶è®¡ç®— scale å’Œ opacityã€‚
-->
<wxs module="renderer">
// é…ç½®å‚æ•°ï¼šå¡ç‰‡é—´è· (å•ä½pxï¼Œå¯¹åº” 520rpx å¤§çº¦æ˜¯ 260px)
var CARD_SPACING = 260; 

// è®¡ç®—æ¯ä¸ªå¡ç‰‡çš„æœ€ç»ˆæ ·å¼
var getStyle = function(index, currentIndex, listLength, dragOffset, isDragging, hasEntered) {
  if (!hasEntered) {
    return 'transform: translate3d(0, 120vh, 0) scale(0.8); opacity: 0;';
  }

  // 1. è®¡ç®—æ»‘åŠ¨è¿›åº¦ (progress)
  // dragOffsetï¼šæ‰‹æŒ‡ä¸Šæ»‘ä¸ºè´Ÿï¼Œä¸‹æ»‘ä¸ºæ­£ï¼›ä¿æŒä¸æ‰‹æŒ‡åŒå‘
  var progress = 0;
  if (isDragging) {
    progress = dragOffset / CARD_SPACING; 
  }

  // 2. è®¡ç®—å½“å‰å¡ç‰‡çš„ç›¸å¯¹ä½ç½® (relativePos)
  // 0 è¡¨ç¤ºæ­£ä¸­é—´ï¼Œ1 è¡¨ç¤ºä¸‹é¢ä¸€ä¸ªï¼Œ-1 è¡¨ç¤ºä¸Šé¢ä¸€ä¸ª
  // åŠ ä¸Š progress åï¼Œè¿™ä¸ªå€¼ä¼šå˜æˆå°æ•°ï¼Œæ¯”å¦‚ 0.5 (æ­£å¤„äºä¸­é—´å’Œä¸‹é¢ä¹‹é—´)
  var realIndex = index - currentIndex; 
  // ğŸ”„ ç¯å½¢ä¿®æ­£ï¼šé€‰æœ€è¿‘çš„æ–¹å‘ï¼Œé¿å…å¤´å°¾è·³å˜
  if (realIndex > listLength / 2) {
    realIndex -= listLength;
  } else if (realIndex < -listLength / 2) {
    realIndex += listLength;
  }
  var relativePos = realIndex + progress;

  // 3. è®¡ç®—ç‰©ç†å±æ€§
  
  // A. Yè½´ä½ç§»ï¼šç›´æ¥æ ¹æ®ç›¸å¯¹ä½ç½®ä¹˜ä»¥é—´è·
  // è¿™é‡Œçš„ constant 130rpx (65px) æ˜¯ä¸ºäº†å±…ä¸­ä¿®æ­£ï¼Œæ ¹æ®ä½ åŸæ¥çš„ calc(50vh - 130rpx)
  var translateY = 'calc(50vh - 130rpx + ' + (relativePos * 520) + 'rpx)';

  // B. ç¼©æ”¾ (Scale)ï¼š
  // ä¸­å¿ƒæ›´å¤§ (1.1)ï¼Œç¦»ä¸­å¿ƒè¶Šè¿œè¶Šå°
  var absPos = Math.abs(relativePos);
  var scale = 1.1 - (absPos * 0.2); // åŠ å¤§ä¸­å¿ƒå¯¹æ¯”
  if (scale < 0.75) scale = 0.75;    // æœ€å°ç¼©æ”¾ï¼Œé˜²æ­¢è¿‡å°

  // C. é€æ˜åº¦ (Opacity)ï¼š
  // ç¦»ä¸­å¿ƒè¶Šè¿‘è¶Šä¸é€æ˜
  var opacity = 1 - (absPos * 0.6);
  if (opacity < 0) opacity = 0;
  if (relativePos > 2 || relativePos < -2) opacity = 0; // å¤ªè¿œçš„ç›´æ¥éšè—
  
  // D. å±‚çº§ (Z-index)ï¼š
  // è¶Šé è¿‘ä¸­å¿ƒå±‚çº§è¶Šé«˜
  var zIndex = 100 - Math.floor(absPos * 10);

  // E. åŠ¨ç”»è¿‡æ¸¡
  // æ‹–æ‹½æ—¶(isDragging=true) å¿…é¡»è®¾ä¸º 0msï¼Œå¦åˆ™ä¼šè¿Ÿæ»ï¼
  // æ¾æ‰‹å(isDragging=false) è®¾ä¸º 500msï¼Œè®©å®ƒå¼¹å¦‚æ­£ç¡®ä½ç½®
  var transition = isDragging ? 'none' : 'transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.5s';

  return 'transform: translate3d(0, ' + translateY + ', 0) scale(' + scale + '); opacity: ' + opacity + '; z-index: ' + zIndex + '; transition: ' + transition + ';';
}

module.exports = {
  getStyle: getStyle
};
</wxs>

<!-- é¡¶éƒ¨å¯¼èˆª -->
<view class="header">
  <view class="back-icon" catchtap="goBack">
    <text class="back-arrow">â€¹</text>
  </view>
</view>

<view 
  class="container"
  bindtouchstart="onTouchStart"
  bindtouchmove="onTouchMove"
  bindtouchend="onTouchEnd"
>
  <block wx:for="{{list}}" wx:key="id">
    <view 
      class="card {{index === currentIndex ? 'curr' : ''}}"
      catchtap="onCardTap"
      data-id="{{item.id}}"
      data-title="{{item.title}}"
      data-index="{{index}}"
      
      style="{{ renderer.getStyle(index, currentIndex, list.length, dragOffset, isDragging, hasEntered) }}"
    >
      
      <!-- å¡ç‰‡å†…éƒ¨ -->
      <view class="card-inner">
        <!-- å·¦ä¾§æ–‡å­—ä¿¡æ¯ -->
        <view class="card-info">
          <view class="card-title">{{item.title}}</view>
          <view class="card-sub">{{item.en}}</view>
        </view>
        
        <!-- å³ä¾§å›¾æ ‡å®¹å™¨ -->
        <view class="icon-container">
          <image 
            class="svg-icon" 
            src="{{item.iconSvg}}" 
            mode="aspectFit"
            style="width: {{item.iconSize}}; height: {{item.iconSize}};"
          ></image>
        </view>
      </view>

    </view>
  </block>
</view>

<!-- é®ç½©å±‚ (ç‚¹å‡»å…³é—­) -->
<view class="drawer-mask" bindtap="closeDrawer" wx:if="{{isDrawerOpen}}" 
  style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 450; backdrop-filter: blur(4px); animation: fadeIn 0.3s;"></view>

<!-- åº•éƒ¨è§¦å‘æŒ‰é’® (å½“æŠ½å±‰å…³é—­æ—¶æ˜¾ç¤º) -->
<view class="trigger-button {{isTriggerBtnVisible ? 'visible' : ''}} {{isTriggerBtnFaded ? 'faded' : ''}}" catchtap="toggleDrawer" wx:if="{{!isDrawerOpen}}">
  <text class="trigger-text">æŸ¥çœ‹å…¨éƒ¨åŠŸèƒ½</text>
  <image src="{{iconArrowUp}}" class="trigger-icon" mode="aspectFit"></image>
</view>

<!-- åº•éƒ¨æŠ½å±‰åŠŸèƒ½åŒº -->
<view class="bottom-drawer {{isDrawerOpen ? 'open' : ''}}">
  <!-- æŠŠæ‰‹åŒºåŸŸ (ä»…ç”¨äºä¸‹æ‹‰å…³é—­) - åªæœ‰è¿™é‡Œå¯ä»¥æ»‘åŠ¨å…³é—­ -->
  <view class="drawer-handle-area" 
        bindtouchstart="onDrawerTouchStart" 
        bindtouchmove="onDrawerTouchMove"
        bindtouchend="onDrawerTouchEnd"
        catchtap="closeDrawer">
    <view class="drawer-handle-bar"></view>
  </view>
  
  <!-- å†…å®¹åŒºåŸŸ -->
  <view class="drawer-content">
    <view class="function-grid">
      <block wx:for="{{list}}" wx:key="id">
        <view class="function-card" catchtap="onFunctionTap" data-id="{{item.id}}">
          <view class="fc-icon-box">
            <image class="fc-icon" src="{{item.iconSvg}}" mode="aspectFit"></image>
          </view>
          <view class="fc-info">
            <text class="fc-title">{{item.title}}</text>
            <text class="fc-sub">{{item.en}}</text>
          </view>
        </view>
      </block>
    </view>
  </view>
</view>

<!-- ================= è‡ªåŠ¨æ¶ˆå¤±æç¤ºï¼ˆæ— æŒ‰é’®ï¼Œ2ç§’åè‡ªåŠ¨æ¶ˆå¤±ï¼‰ ================= -->
<view class="auto-toast-mask {{autoToastClosing ? 'closing' : ''}}" wx:if="{{autoToast.show}}" catchtouchmove="noop" catchtap="noop">
  <view class="auto-toast-box" catchtouchmove="noop" catchtap="noop">
    <view class="at-title">{{autoToast.title}}</view>
    <view class="at-content">{{autoToast.content}}</view>
  </view>
</view>

<!-- è‡ªå®šä¹‰åŠ è½½åŠ¨ç”» -->
<view class="loading-mask" wx:if="{{showLoadingAnimation}}" catchtouchmove="noop" catchtap="noop">
  <view class="loader" catchtouchmove="noop" catchtap="noop">
    <text class="loader-label">è¯·ç¨å€™...</text>
    <view class="loading-bar"></view>
  </view>
</view>

<!-- å…¨å±€è‡ªå®šä¹‰å¼¹çª—ç»„ä»¶ -->
<custom-toast id="custom-toast" />
