<!-- 
  Ê†∏ÂøÉ‰øÆÂ§çÔºö
  ÂÜÖÂµå WXS Ê∏≤ÊüìËÑöÊú¨ÔºåÂÆûÁé∞Áâ©ÁêÜË∑üÊâãÂä®Áîª„ÄÇ
  Ê†πÊçÆ dragOffset ÂÆûÊó∂ËÆ°ÁÆó scale Âíå opacity„ÄÇ
-->
<wxs module="renderer">
// ÈÖçÁΩÆÂèÇÊï∞ÔºöÂç°ÁâáÈó¥Ë∑ù (Âçï‰ΩçpxÔºåÂØπÂ∫î 520rpx Â§ßÁ∫¶ÊòØ 260px)
var CARD_SPACING = 260; 

// ËÆ°ÁÆóÊØè‰∏™Âç°ÁâáÁöÑÊúÄÁªàÊ†∑Âºè
var getStyle = function(index, currentIndex, listLength, dragOffset, isDragging, hasEntered) {
  if (!hasEntered) {
    return 'transform: translate3d(0, 120vh, 0) scale(0.8); opacity: 0;';
  }

  // 1. ËÆ°ÁÆóÊªëÂä®ËøõÂ∫¶ (progress)
  // dragOffsetÔºöÊâãÊåá‰∏äÊªë‰∏∫Ë¥üÔºå‰∏ãÊªë‰∏∫Ê≠£Ôºõ‰øùÊåÅ‰∏éÊâãÊåáÂêåÂêë
  var progress = 0;
  if (isDragging) {
    progress = dragOffset / CARD_SPACING; 
  }

  // 2. ËÆ°ÁÆóÂΩìÂâçÂç°ÁâáÁöÑÁõ∏ÂØπ‰ΩçÁΩÆ (relativePos)
  // 0 Ë°®Á§∫Ê≠£‰∏≠Èó¥Ôºå1 Ë°®Á§∫‰∏ãÈù¢‰∏Ä‰∏™Ôºå-1 Ë°®Á§∫‰∏äÈù¢‰∏Ä‰∏™
  // Âä†‰∏ä progress ÂêéÔºåËøô‰∏™ÂÄº‰ºöÂèòÊàêÂ∞èÊï∞ÔºåÊØîÂ¶Ç 0.5 (Ê≠£Â§Ñ‰∫é‰∏≠Èó¥Âíå‰∏ãÈù¢‰πãÈó¥)
  var realIndex = index - currentIndex; 
  // üîÑ ÁéØÂΩ¢‰øÆÊ≠£ÔºöÈÄâÊúÄËøëÁöÑÊñπÂêëÔºåÈÅøÂÖçÂ§¥Â∞æË∑≥Âèò
  if (realIndex > listLength / 2) {
    realIndex -= listLength;
  } else if (realIndex < -listLength / 2) {
    realIndex += listLength;
  }
  var relativePos = realIndex + progress;

  // 3. ËÆ°ÁÆóÁâ©ÁêÜÂ±ûÊÄß
  
  // A. YËΩ¥‰ΩçÁßªÔºöÁõ¥Êé•Ê†πÊçÆÁõ∏ÂØπ‰ΩçÁΩÆ‰πò‰ª•Èó¥Ë∑ù
  // ËøôÈáåÁöÑ constant 130rpx (65px) ÊòØ‰∏∫‰∫ÜÂ±Ö‰∏≠‰øÆÊ≠£ÔºåÊ†πÊçÆ‰Ω†ÂéüÊù•ÁöÑ calc(50vh - 130rpx)
  var translateY = 'calc(50vh - 130rpx + ' + (relativePos * 520) + 'rpx)';

  // B. Áº©Êîæ (Scale)Ôºö
  // ‰∏≠ÂøÉÊõ¥Â§ß (1.1)ÔºåÁ¶ª‰∏≠ÂøÉË∂äËøúË∂äÂ∞è
  var absPos = Math.abs(relativePos);
  var scale = 1.1 - (absPos * 0.2); // Âä†Â§ß‰∏≠ÂøÉÂØπÊØî
  if (scale < 0.75) scale = 0.75;    // ÊúÄÂ∞èÁº©ÊîæÔºåÈò≤Ê≠¢ËøáÂ∞è

  // C. ÈÄèÊòéÂ∫¶ (Opacity)Ôºö
  // Á¶ª‰∏≠ÂøÉË∂äËøëË∂ä‰∏çÈÄèÊòé
  var opacity = 1 - (absPos * 0.6);
  if (opacity < 0) opacity = 0;
  if (relativePos > 2 || relativePos < -2) opacity = 0; // Â§™ËøúÁöÑÁõ¥Êé•ÈöêËóè
  
  // D. Â±ÇÁ∫ß (Z-index)Ôºö
  // Ë∂äÈù†Ëøë‰∏≠ÂøÉÂ±ÇÁ∫ßË∂äÈ´ò
  var zIndex = 100 - Math.floor(absPos * 10);

  // E. Âä®ÁîªËøáÊ∏°
  // ÊãñÊãΩÊó∂(isDragging=true) ÂøÖÈ°ªËÆæ‰∏∫ 0msÔºåÂê¶Âàô‰ºöËøüÊªûÔºÅ
  // ÊùæÊâãÂêé(isDragging=false) ËÆæ‰∏∫ 500msÔºåËÆ©ÂÆÉÂºπÂ¶ÇÊ≠£Á°Æ‰ΩçÁΩÆ
  var transition = isDragging ? 'none' : 'transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.5s';

  return 'transform: translate3d(0, ' + translateY + ', 0) scale(' + scale + '); opacity: ' + opacity + '; z-index: ' + zIndex + '; transition: ' + transition + ';';
}

module.exports = {
  getStyle: getStyle
};
</wxs>

<!-- È°∂ÈÉ®ÂØºËà™ -->
<view class="header">
  <view class="back-icon" catchtap="goBack">
    <text style="font-size: 48rpx; font-weight: 300; color: #000; line-height: 1;">‚Äπ</text>
  </view>
</view>

<view 
  class="container"
  bindtouchstart="onTouchStart"
  bindtouchmove="onTouchMove"
  bindtouchend="onTouchEnd"
>
  <block wx:for="{{list}}" wx:key="id">
    <view 
      class="card {{index === currentIndex ? 'curr' : ''}}"
      catchtap="onCardTap"
      data-id="{{item.id}}"
      data-title="{{item.title}}"
      data-index="{{index}}"
      
      style="{{ renderer.getStyle(index, currentIndex, list.length, dragOffset, isDragging, hasEntered) }}"
    >
      
      <!-- Âç°ÁâáÂÜÖÈÉ® -->
      <view class="card-inner">
        <!-- Â∑¶‰æßÊñáÂ≠ó‰ø°ÊÅØ -->
        <view class="card-info">
          <view class="card-title">{{item.title}}</view>
          <view class="card-sub">{{item.en}}</view>
        </view>
        
        <!-- Âè≥‰æßÂõæÊ†áÂÆπÂô® -->
        <view class="icon-container">
          <image 
            class="svg-icon" 
            src="{{item.iconSvg}}" 
            mode="aspectFit"
            style="width: {{item.iconSize}}; height: {{item.iconSize}};"
          ></image>
        </view>
      </view>

    </view>
  </block>
</view>
<!-- ================= Ëá™Âä®Ê∂àÂ§±ÊèêÁ§∫ÔºàÊó†ÊåâÈíÆÔºå2ÁßíÂêéËá™Âä®Ê∂àÂ§±Ôºâ ================= -->
<view class="auto-toast-mask {{autoToastClosing ? 'closing' : ''}}" wx:if="{{autoToast.show}}" catchtouchmove="noop">
  <view class="auto-toast-box">
    <view class="at-title">{{autoToast.title}}</view>
    <view class="at-content">{{autoToast.content}}</view>
  </view>
</view>

<!-- Ëá™ÂÆö‰πâÂä†ËΩΩÂä®Áîª -->
<view class="loading-mask" wx:if="{{showLoadingAnimation}}">
  <view class="loader">
    <text class="loader-label">ËØ∑Á®çÂÄô...</text>
    <view class="loading-bar"></view>
  </view>
</view>

<!-- ÂÖ®Â±ÄËá™ÂÆö‰πâÂºπÁ™óÁªÑ‰ª∂ -->
<custom-toast id="custom-toast" />
