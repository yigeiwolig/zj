<!-- 强制授权弹窗 (蓝牙/定位失败时显示) - 黑白风格 -->
<view class="custom-modal-mask" wx:if="{{showAuthForceModal}}" catchtouchmove="noop">
  <view class="custom-modal-box" catchtouchmove="noop">
    <!-- 图标：使用 Unicode 字符，无需加载图片 -->
    <view class="modal-icon-new">📍</view>
    
    <!-- 标题 -->
    <view class="modal-title-new">需要必要权限</view>
    
    <!-- 内容 -->
    <view class="modal-content-new">
      <block wx:if="{{authMissingType === 'bluetooth'}}">
        <view class="content-main">请开启手机蓝牙功能以连接设备</view>
      </block>
      <block wx:if="{{authMissingType === 'location'}}">
        <view class="content-main">需要获取您的位置信息以提供服务</view>
      </block>
    </view>

    <!-- 按钮 -->
    <block wx:if="{{authMissingType === 'bluetooth'}}">
      <button class="modal-btn-new" bindtap="retryBluetooth">已开启，重试</button>
    </block>
    <block wx:if="{{authMissingType === 'location'}}">
      <button class="modal-btn-new" open-type="openSetting" bindopensetting="onOpenSettingResult">去设置开启</button>
    </block>
  </view>
</view>

<!-- 昵称授权窗口 (改为高级身份验证模式) -->
<view class="auth-mask" wx:if="{{!isAuthorized && isShowNicknameUI}}" catchtouchmove="noop">
  <view class="auth-panel-new" catchtouchmove="noop">
    <view class="auth-icon-lock">✨</view>
    <view class="auth-title-new">开启专属体验</view>
    <view class="auth-subtitle-new">请输入访问口令，解锁更多精彩内容</view>
    
    <view class="auth-input-wrapper">
      <input type="nickname" class="auth-input-new" placeholder="点击下方微信昵称填入" bindinput="onNickNameInput" bindchange="onNickNameChange" value="{{inputNickName}}"/>
    </view>
    
    <view class="auth-btn-new" bindtap="handleLogin">
      立即开启
    </view>
  </view>
</view>

<!-- 主程序 (气泡按钮等) -->
<view class="page index-page {{step > 0 ? 'animating' : ''}}" wx:if="{{isAuthorized}}">
  <!-- 管理员模式：封禁用户列表 -->
  <view class="admin-mode-container" wx:if="{{isAdminMode}}">
    <!-- 顶部标题栏 -->
    <view class="admin-header">
      <text class="admin-title">封禁用户管理</text>
      <view class="admin-header-right">
        <!-- 🔴 切换按钮 -->
        <view class="admin-switch-btn" bindtap="toggleNicknameMode">
          <text>{{isNicknameMode ? '封禁管理' : '昵称录入'}}</text>
        </view>
        <view class="admin-exit-btn-small" bindtap="exitAdminMode">
          <text class="admin-exit-text-small">退出</text>
        </view>
      </view>
    </view>

    <!-- 🔴 昵称录入界面 -->
    <view class="admin-nickname-container" wx:if="{{isNicknameMode}}">
      <view class="nickname-title">昵称录入</view>
      <view class="nickname-desc">输入昵称后，将自动同步到白名单</view>
      
      <view class="nickname-input-wrapper">
        <input 
          class="nickname-input" 
          type="text" 
          placeholder="请输入昵称"
          value="{{nicknameInput}}"
          bindinput="onNicknameInput"
          maxlength="20"
        />
      </view>
      
      <button 
        class="nickname-submit-btn" 
        hover-class="btn-hover" 
        bindtap="submitNickname"
        disabled="{{isSubmittingNickname || !nicknameInput}}"
      >
        {{isSubmittingNickname ? '提交中...' : '提交'}}
      </button>
    </view>

    <!-- 封禁用户列表 -->
    <scroll-view class="admin-user-list" scroll-y wx:if="{{!isNicknameMode}}">
      <!-- 加载中 -->
      <view wx:if="{{isLoadingBannedUsers}}" class="admin-loading">
        <text>加载中...</text>
      </view>

      <!-- 空状态 -->
      <view wx:elif="{{bannedUsers.length === 0}}" class="admin-empty">
        <text>暂无封禁用户</text>
      </view>

      <!-- 用户卡片列表 -->
      <view wx:else class="admin-user-cards">
        <view class="admin-user-card" wx:for="{{bannedUsers}}" wx:key="_id" wx:for-index="idx">
          <!-- 用户基本信息 -->
          <view class="user-card-header">
            <text class="user-nickname">{{item.nickname}}</text>
            <text class="user-ban-reason">{{item.banReasonText}}</text>
          </view>

          <!-- 详细信息 -->
          <view class="user-card-info">
            <view class="info-row">
              <text class="info-label">封禁页面：</text>
              <text class="info-value">{{item.banPageText}}</text>
            </view>
            
            <view class="info-row" wx:if="{{item.province || item.city || item.latitude}}">
              <text class="info-label">地址：</text>
              <text class="info-value">
                <block wx:if="{{item.province || item.city}}">
                  {{item.province}}{{item.city}}{{item.district}}
                </block>
                <block wx:else>
                  <text wx:if="{{item.latitude && item.longitude}}">
                    经纬度: {{item.latitude}}, {{item.longitude}}
                  </text>
                  <text wx:else>未获取到地址</text>
                </block>
              </text>
            </view>
            
            <view class="info-row" wx:if="{{item.address}}">
              <text class="info-label">详细地址：</text>
              <text class="info-value">{{item.address}}</text>
            </view>
            
            <view class="info-row" wx:if="{{item.phoneModel}}">
              <text class="info-label">设备：</text>
              <text class="info-value">{{item.phoneModel}}</text>
            </view>
            
            <view class="info-row">
              <text class="info-label">封禁时间：</text>
              <text class="info-value">{{item.updateTime}}</text>
            </view>
            
            <view class="info-row">
              <text class="info-label">总访问次数：</text>
              <text class="info-value">{{item.totalVisits}}</text>
            </view>
            
            <view class="info-row" wx:if="{{item.failCount > 0}}">
              <text class="info-label">失败次数：</text>
              <text class="info-value">{{item.failCount}}</text>
            </view>
          </view>

          <!-- 操作按钮 -->
          <view class="user-card-actions">
            <!-- 🔴 昵称验证失败时显示"重试"按钮 -->
            <view class="action-btn retry-btn" wx:if="{{item.banReason === 'nickname_verify_fail'}}" catchtap="retryNickname" data-button-id="{{item._id}}" data-index="{{idx}}" data-nickname="{{item.nickname}}">
              <text class="action-btn-text">重试</text>
            </view>
            <view class="action-btn unban-btn" catchtap="unbanUser" data-button-id="{{item._id}}" data-index="{{idx}}" data-ban-reason="{{item.banReason}}" data-openid="{{item._openid}}" data-nickname="{{item.nickname}}">
              <text class="action-btn-text">放行</text>
            </view>
            <view class="action-btn ignore-btn" catchtap="ignoreUser" data-button-id="{{item._id}}" data-index="{{idx}}">
              <text class="action-btn-text">无视</text>
            </view>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- 正常模式：原有内容 -->
  <block wx:if="{{!isAdminMode}}">
    <!-- 顶部标题 -->
    <view class="header-section {{step > 0 ? 'fade-out' : ''}}" catchtap="onAdminTap">
      <view class="title-wrap" bindtap="onAdminTap" catchtap="onAdminTap" data-step="{{step}}">
        <text class="brand" catchtap="onAdminTap">MT-摩改社</text>
      </view>
    </view>

    <!-- 舞台区域 -->
    <view class="hero-section">
      <!-- 中间标题 -->
      <view class="center-title {{step > 0 ? 'fade-out' : ''}}">
        <text class="sub-title">MT-摩改社</text>
      </view>
      
      <!-- 文字 -->
      <view class="text-track" wx:if="{{step >= 3}}">
        <text class="char char-1">M</text>
        <text class="char char-2">T</text>
        <text class="char char-3">引</text>
        <text class="char char-4">领</text>
        <text class="char char-5">创</text>
        <text class="char char-6">新</text>
      </view>
      <!-- 按钮 -->
      <view class="liquid-btn step-{{step}}" bindtap="handleAccess">
        <view class="gear-shape"><view class="teeth"></view><view class="hub"></view></view>
        <view class="highlight-dot"></view>
        <text class="btn-text" wx:if="{{step === 0}}">MT  RIDE</text>
      </view>
    </view>
    

    <view class="curtain-mask {{step >= 5 ? 'active' : ''}}"></view>
  </block>
</view>

<!-- 【新增】强制授权弹窗 - 黑白风格 -->
<view class="custom-modal-mask" wx:if="{{showAuthModal}}">
  <view class="custom-modal-box">
    <!-- 图标：使用 Unicode 字符，无需加载图片 -->
    <view class="modal-icon-new">📍</view>
    
    <!-- 标题 -->
    <view class="modal-title-new">需要位置权限</view>
    
    <!-- 内容 -->
    <view class="modal-content-new">
      <view class="content-main">为了检测当前区域服务可用性及展示附近门店，请允许获取您的位置信息。</view>
    </view>

    <!-- 按钮 -->
    <button class="modal-btn-new" open-type="openSetting" bindopensetting="onOpenSetting">
      去设置开启
    </button>
  </view>
</view>

<!-- 【全局通用】自定义黑白极简弹窗 - 错误类型 -->
<view class="custom-modal-mask" wx:if="{{showCustomErrorModal}}">
  <view class="custom-modal-box">
    
    <!-- 1. 图标：使用 CSS 绘制的圆形图标，无需加载图片 -->
    <view class="modal-icon-new error-icon">
      <view class="error-circle">!</view>
    </view>
    
    <!-- 2. 标题 -->
    <view class="modal-title-new">验证未通过</view>
    
    <!-- 3. 内容 -->
    <view class="modal-content-new">
      <view class="content-main">该昵称暂未获得授权</view>
      <view class="content-sub">建议点击一键填写确保准确</view>
    </view>

    <!-- 4. 按钮：纯黑风格 -->
    <button class="modal-btn-new" bindtap="handleCopyFromModal">
      复制管理员微信号
    </button>
  </view>
</view>

<!-- 【全局通用】自定义黑白极简弹窗 - 成功类型 -->
<view class="custom-modal-mask" wx:if="{{showCustomSuccessModal}}">
  <view class="custom-modal-box success-modal">
    
    <!-- 1. 图标：使用 Unicode 字符，无需加载图片 -->
    <view class="modal-icon-new success-icon">✓</view>
    
    <!-- 2. 标题 -->
    <view class="modal-title-new">{{successModalTitle}}</view>
    
    <!-- 3. 内容（如果有） -->
    <view class="modal-content-new" wx:if="{{successModalContent}}">
      <view class="content-main">{{successModalContent}}</view>
    </view>
  </view>
</view>

<!-- 【新增】自定义二次确认弹窗 - 白底黑字 -->
<view class="custom-modal-mask" wx:if="{{showConfirmModal}}">
  <view class="custom-modal-box confirm-modal">
    <view class="modal-title-new">确认操作</view>
    <view class="modal-content-new">
      <view class="content-main">{{confirmModalContent}}</view>
    </view>
    <view class="modal-btns-row">
      <view class="modal-btn-cancel" bindtap="hideConfirmModal">取消</view>
      <view class="modal-btn-confirm" bindtap="handleConfirmAction">确定</view>
    </view>
  </view>
</view>

<!-- 【新增】自定义"内容已复制"弹窗 - 白色，大一点 -->
<view class="custom-modal-mask" wx:if="{{showCopySuccessModal}}">
  <view class="custom-modal-box copy-success-modal">
    <!-- 图标：使用 Unicode 字符 -->
    <view class="modal-icon-new success-icon">✓</view>
    <!-- 标题 -->
    <view class="modal-title-new">内容已复制</view>
  </view>
</view>

<!-- 自定义加载中动画（使用 my 页面的样式） -->
<view class="loading-mask" wx:if="{{showLoadingAnimation}}">
  <view class="loader">
    <text class="loader-label">{{loadingText}}</text>
    <view class="loading-bar"></view>
  </view>
</view>

<!-- ================= 自定义弹窗（替换 wx.showModal） ================= -->
<view class="custom-dialog-mask {{dialogClosing ? 'closing' : ''}}" wx:if="{{dialog.show}}" bindtap="closeCustomDialog" catchtouchmove="noop">
  <view class="custom-dialog-box" catchtap="noop">
    <view class="cd-title">{{dialog.title}}</view>
    <view class="cd-content">{{dialog.content}}</view>
    <view class="cd-btn-row">
      <view class="cd-btn cancel" wx:if="{{dialog.showCancel}}" bindtap="closeCustomDialog">{{dialog.cancelText || '取消'}}</view>
      <view class="cd-btn confirm" bindtap="onDialogConfirm">{{dialog.confirmText || '确定'}}</view>
    </view>
  </view>
</view>

<!-- 全局自定义弹窗组件 -->
<custom-toast id="custom-toast" />
