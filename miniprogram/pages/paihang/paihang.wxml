<view class="container theme-{{pageTheme}}">
  <view class="spotlight-bg"></view>

  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <view class="header">
    <view class="back-icon" catchtap="goBack">
      <text>â€¹</text>
    </view>
  </view>
  <view class="custom-nav-container" style="padding-top: {{statusBarHeight}}px;">
    <!-- ğŸ”´ å·¦ä¸Šè§’è¿”å›æŒ‰é’® -->
    <view class="back-btn" bindtap="goBack" style="top: {{statusBarHeight + 10}}px; display: none;">
      <text class="back-icon">â€¹</text>
    </view>

    <view class="nav-bar-row" style="height: {{navBarHeight}}px; line-height: {{navBarHeight}}px;">
      <view class="brand-title">
        <text class="brand-sub">{{isAdminMode ? 'ADMIN MODE' : 'LIVE STANDINGS'}}</text>
        <view class="brand-main">
          <!-- åªæœ‰ç™½åå•ç”¨æˆ·èƒ½çœ‹åˆ°çš„åˆ‡æ¢å¼€å…³ -->
          <view 
            wx:if="{{isAuthorized}}" 
            class="admin-toggle-btn {{isAdminMode ? 'on' : ''}}" 
            catchtap="toggleAdminMode">
            {{isAdminMode ? 'EXIT' : 'EDIT'}}
          </view>
          MOTO<text class="text-accent">GP</text>
          <text wx:if="{{isAdminMode}}" class="admin-tag">å·²è§£é”</text>
        </view>
      </view>
    </view>

    <!-- åªæœ‰æ¦œå•é¡µæ˜¾ç¤ºé¡¶éƒ¨å¼€å…³ -->
    <block wx:if="{{currentTab === 'rank'}}">
      <view class="filter-row">
        <view class="switch-capsule">
          <view class="switch-item {{rankType === 'gas' ? 'active' : ''}}" bindtap="switchRankType" data-type="gas" hover-class="btn-hover">æ²¹æ‘©</view>
          <view class="switch-item {{rankType === 'ev' ? 'active' : ''}}" bindtap="switchRankType" data-type="ev" hover-class="btn-hover">ç”µæ‘©</view>
        </view>
      </view>
      <view class="sort-row">
        <view class="sort-item {{sortType === 'comp' ? 'active' : ''}}" bindtap="switchSort" data-type="comp" hover-class="btn-hover">ç»¼åˆ</view>
        <view class="sort-item {{sortType === 'angle' ? 'active' : ''}}" bindtap="switchSort" data-type="angle" hover-class="btn-hover">è§’åº¦</view>
        <view class="sort-item {{sortType === 'dist' ? 'active' : ''}}" bindtap="switchSort" data-type="dist" hover-class="btn-hover">é‡Œç¨‹</view>
      </view>
    </block>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <view class="content-area top-spacing">

    <!-- PAGE 1: æ¦œå• -->
    <scroll-view scroll-y class="scroll-view" wx:if="{{currentTab === 'rank'}}">
      
      <!-- æ™®é€šè§†å›¾ -->
      <block wx:if="{{!isAdminMode}}">
        <view class="podium-area" style="padding-top: 60rpx;" wx:if="{{top3.length > 0}}">
          
          <!-- NO.2 -->
          <view class="podium-item side" wx:if="{{top3[1]}}">
            <image src="{{icons.crown_silver}}" class="crown-img side-crown"></image>
            <text class="rank-num text-silver">02</text>
            <view class="podium-card silver-border">
              <image src="{{top3[1].avatar || 'https://api.dicebear.com/9.x/adventurer/svg?seed=default'}}" binderror="onImageError" data-index="1" mode="aspectFill" class="podium-img"></image>
              <view class="podium-info">
                <text class="p-name">{{top3[1].name}}</text>
                <text class="p-score text-silver">{{top3[1].angle}}Â°</text>
                <text class="p-dist text-silver">{{top3[1].dist}} km</text>
              </view>
            </view>
            <view class="podium-base base-silver"></view>
          </view>

          <!-- NO.1 -->
          <view class="podium-item center" wx:if="{{top3[0]}}">
            <image src="{{icons.crown_gold}}" class="crown-img center-crown"></image>
            <text class="rank-num text-gold">01</text>
            <view class="podium-card gold-border">
              <image src="{{top3[0].avatar || 'https://api.dicebear.com/9.x/adventurer/svg?seed=default'}}" binderror="onImageError" data-index="0" mode="aspectFill" class="podium-img"></image>
              <view class="podium-info center-info">
                <text class="p-name big">{{top3[0].name}}</text>
                <text class="p-score big text-gold">{{top3[0].angle}}<text class="unit">Â°</text></text>
                <text class="p-dist text-gold">{{top3[0].dist}} km</text>
                <text class="p-bike">{{top3[0].bike}}</text>
              </view>
            </view>
            <view class="podium-base base-gold"></view>
          </view>

          <!-- NO.3 -->
          <view class="podium-item side" wx:if="{{top3[2]}}">
            <image src="{{icons.crown_bronze}}" class="crown-img side-crown"></image>
            <text class="rank-num text-bronze">03</text>
            <view class="podium-card bronze-border">
              <image src="{{top3[2].avatar || 'https://api.dicebear.com/9.x/adventurer/svg?seed=default'}}" binderror="onImageError" data-index="2" mode="aspectFill" class="podium-img"></image>
              <view class="podium-info">
                <text class="p-name">{{top3[2].name}}</text>
                <text class="p-score text-bronze">{{top3[2].angle}}Â°</text>
                <text class="p-dist text-bronze">{{top3[2].dist}} km</text>
              </view>
            </view>
            <view class="podium-base base-bronze"></view>
          </view>
        </view>

        <view class="list-area">
          <view class="list-header">
            <text class="lh-pos">æ’å</text>
            <text class="lh-rider">è½¦æ‰‹</text>
            <text class="lh-data">è§’åº¦ / é‡Œç¨‹</text>
          </view>
          <block wx:for="{{userRankList}}" wx:key="id">
            <view class="list-item">
              <text class="li-rank">{{item.rank}}</text>
              <image src="{{item.avatar}}" class="li-avatar"></image>
              <view class="li-info">
                <text class="li-name">{{item.name}}</text>
                <text class="li-bike">{{item.bike}}</text>
              </view>
              <view class="li-data">
                <text class="li-angle">{{item.angle}}Â°</text>
                <text class="li-dist">{{item.dist}}km</text>
              </view>
            </view>
          </block>
        </view>
      </block>

      <!-- ç®¡ç†å‘˜è§†å›¾ -->
      <block wx:else>
        <view class="list-area" style="padding-top: 20rpx;">
          <view class="admin-bar">
            <view class="admin-title">ç®¡ç†åˆ—è¡¨ ({{rankType==='gas'?'æ²¹æ‘©':'ç”µæ‘©'}})</view>
            <view class="add-btn" bindtap="openAddModal" hover-class="btn-hover">+ æ–°å¢</view>
          </view>
          <view class="list-header"><text class="lh-pos">æ’å</text><text class="lh-rider">ä¿¡æ¯</text><text class="lh-data">æ“ä½œ</text></view>
          <block wx:for="{{rankList}}" wx:key="id">
            <view class="list-item admin-item">
              <text class="li-rank {{item.rank<=3?'highlight':''}}">{{item.rank}}</text>
              <image src="{{item.avatar}}" class="li-avatar"></image>
              <view class="li-info">
                <text class="li-name">{{item.name}} <text class="score-tag">ç»¼:{{item.score}}</text></text>
                <text class="li-bike">{{item.bike}} | {{item.angle}}Â°</text>
              </view>
              <view class="action-btns">
                <view class="btn-edit" bindtap="openEditModal" data-item="{{item}}" hover-class="btn-hover">ç¼–è¾‘</view>
                <view class="btn-del" bindtap="deleteRecord" data-id="{{item.id}}" hover-class="btn-hover">åˆ é™¤</view>
              </view>
            </view>
          </block>
        </view>
      </block>
      <view style="height: 180rpx;"></view>
    </scroll-view>

    <!-- PAGE 2: æˆ‘çš„è½¦åº“ -->
    <scroll-view scroll-y class="scroll-view" wx:if="{{currentTab === 'mine'}}">
      <view class="mine-header">
        <view class="page-title">MY <text class="text-sub">GARAGE</text></view>
        <view class="identity-switch {{myInfo.type}}" bindtap="toggleUserType" hover-class="btn-hover">
          <view class="dot"></view>
          <text>{{myInfo.type === 'gas' ? 'æ²¹æ‘©è½¦ä¸»' : 'ç”µæ‘©è½¦ä¸»'}}</text>
        </view>
      </view>

      <view class="profile-card-v2">
        <view class="avatar-box" bindtap="changeMyAvatar" hover-class="btn-hover">
          <image src="{{myInfo.avatar}}" mode="aspectFill" class="my-avatar"></image>
          <view class="edit-icon">ğŸ“·</view>
        </view>
        <view class="info-inputs">
          <input class="name-input" value="{{myInfo.name}}" data-field="name" bindinput="handleMyInfoInput" />
          <view class="device-row">
            <text class="label">ç»‘å®šè®¾å¤‡:</text>
            <text class="value">{{myInfo.deviceId}}</text>
            <view class="status-dot online"></view>
          </view>
        </view>
      </view>

      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-val">{{myInfo.avgAngle}}Â°</text>
          <text class="stat-label">å¹³å‡è§’åº¦</text>
        </view>
        <view class="stat-item highlight">
          <text class="stat-val">{{myInfo.maxAngle}}Â°</text>
          <text class="stat-label">æœ€å¤§è§’åº¦</text>
        </view>
        <view class="stat-item">
          <text class="stat-val">{{myInfo.totalDist}}</text>
          <text class="stat-label">æ€»å…¬é‡Œ (KM)</text>
        </view>
      </view>

      <view class="bike-setting">
        <text class="label">å½“å‰åº§é©¾</text>
        <input class="bike-input" value="{{myInfo.bike}}" data-field="bike" bindinput="handleMyInfoInput" />
        <view class="edit-hint">âœ</view>
      </view>

      <view class="history-section-v2">
        <text class="section-title">ä¸Šä¼ è®°å½• ({{myInfo.history.length}})</text>
        <view class="history-list-v2">
          <block wx:for="{{myInfo.history}}" wx:key="id">
            <view class="history-card" hover-class="btn-hover">
              <view class="h-left">
                <text class="h-angle">{{item.angle}}<text class="unit">Â°</text></text>
                <text class="h-date">{{item.date}}</text>
              </view>
              <view class="h-center">
                <text class="h-bike">{{item.bike}}</text>
                <view class="h-line"></view>
                <text class="h-dist">{{item.dist}} KM</text>
              </view>
              <view class="h-right">
                <image wx:if="{{item.img}}" src="{{item.img}}" mode="aspectFill" class="h-thumb"></image>
                <view wx:else class="h-icon">ğŸï¸</view>
              </view>
            </view>
          </block>
          <view wx:if="{{myInfo.history.length === 0}}" class="empty-tip">æš‚æ— è®°å½•ï¼Œå¿«å»ä¸Šä¼ å§ï¼</view>
        </view>
      </view>
      <view style="height: 180rpx;"></view>
    </scroll-view>
  </view>

  <!-- åº•éƒ¨ Tab Bar -->
  <view class="tab-bar glass-panel">
    <view class="tab-item {{currentTab === 'rank' ? 'active' : ''}}" bindtap="switchTab" data-tab="rank" hover-class="btn-hover">
      <image src="{{currentTab === 'rank' ? icons.rank_on : icons.rank_off}}" class="tab-icon-img"></image>
      <text class="tab-text">RANK</text>
    </view>
    <view class="upload-btn-wrapper" bindtap="onUpload" hover-class="btn-hover">
      <view class="upload-btn"><text class="plus-icon">+</text></view>
    </view>
    <view class="tab-item {{currentTab === 'mine' ? 'active' : ''}}" bindtap="switchTab" data-tab="mine" hover-class="btn-hover">
      <image src="{{currentTab === 'mine' ? icons.garage_on : icons.garage_off}}" class="tab-icon-img"></image>
      <text class="tab-text">GARAGE</text>
    </view>
  </view>

  <!-- ç”¨æˆ·ä¸Šä¼ å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showUserUpload}}">
    <view class="admin-modal user-upload-modal">
      <view class="modal-title">ä¸Šä¼ æˆç»©</view>
      <view class="modal-close" bindtap="closeUserUpload" hover-class="btn-hover">Ã—</view>

      <scroll-view scroll-y style="max-height: 70vh;">
        <view class="media-row">
          <view class="upload-box" bindtap="chooseDataImg" hover-class="btn-hover">
            <image wx:if="{{userForm.dataImg}}" src="{{userForm.dataImg}}" mode="aspectFill" class="uploaded-img"></image>
            <view wx:else class="upload-placeholder"><view class="plus-symbol">+</view><text>æ•°æ®ç…§ç‰‡</text></view>
          </view>
          <view class="upload-box" bindtap="chooseVideo" hover-class="btn-hover">
            <video wx:if="{{userForm.video}}" src="{{userForm.video}}" class="uploaded-img" :controls="false" :show-center-play-btn="false"></video>
            <view wx:else class="upload-placeholder"><view class="plus-symbol">+</view><text>æ£€æµ‹è§†é¢‘</text></view>
          </view>
        </view>

        <view class="input-group-user">
          <input class="modal-input" placeholder="è¾“å…¥æ˜µç§°" value="{{userForm.nickname}}" data-field="nickname" bindinput="handleUserFormInput" />
          <input class="modal-input" placeholder="è¾“å…¥è½¦å‹ (å¦‚: Ducati V4)" value="{{userForm.bikeModel}}" data-field="bikeModel" bindinput="handleUserFormInput" />
        </view>

        <view class="bluetooth-section">
          <button class="bt-read-btn {{isReading ? 'reading' : ''}} {{isBluetoothConnected ? 'connected' : ''}}" bindtap="readBluetooth" hover-class="btn-hover">
            <view class="bt-icon-wrap"><image src="{{icons.bluetooth}}" class="bt-svg"></image></view>
            <view class="bt-text-wrap">
              <text class="bt-main-text">{{isBluetoothConnected ? 'è®¾å¤‡å·²è¿æ¥' : 'è¿æ¥è“ç‰™è®¾å¤‡'}}</text>
              <text class="bt-sub-text">{{isReading ? 'æ­£åœ¨è¯»å–æ•°æ®...' : (isBluetoothConnected ? 'ç‚¹å‡»é‡æ–°è¯»å–' : 'ç‚¹å‡»æœç´¢é™„è¿‘çš„è®¾å¤‡')}}</text>
            </view>
            <view class="status-light {{isBluetoothConnected ? 'on' : ''}}"></view>
          </button>

          <view class="data-display-screen">
            <view class="data-row">
              <view class="data-cell"><text class="label">è·ç¦»</text><text class="value">{{userForm.dist}} <text class="unit">KM</text></text></view>
              <view class="data-cell"><text class="label">æœ€å¤§è§’åº¦</text><text class="value">{{userForm.maxAngle}} <text class="unit">Â°</text></text></view>
            </view>
            <view class="data-row border-top">
              <view class="data-cell"><text class="label">å¹³å‡è§’åº¦</text><text class="value">{{userForm.avgAngle}} <text class="unit">Â°</text></text></view>
              <view class="data-cell"><text class="label">è®¾å¤‡ID</text><text class="value sm">{{userForm.deviceId}}</text></view>
            </view>
          </view>
        </view>
      </scroll-view>

      <button class="modal-btn save-btn big-submit" bindtap="saveRecord" hover-class="btn-hover">
        <view class="save-btn-text">æäº¤æˆç»©å®¡æ ¸</view>
      </button>
    </view>
  </view>

  <!-- ç®¡ç†å‘˜ç¼–è¾‘å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showEditModal}}">
    <view class="admin-modal edit-modal">
      <view class="modal-title">{{isEdit ? 'ç¼–è¾‘è®°å½•' : 'æ·»åŠ æ–°è®°å½•'}}</view>
      <view class="modal-close" bindtap="closeEditModal" hover-class="btn-hover">Ã—</view>
      <scroll-view scroll-y style="max-height: 60vh;">
        <view class="admin-avatar-box" bindtap="chooseAvatar" hover-class="btn-hover">
          <image wx:if="{{form.avatar}}" src="{{form.avatar}}" mode="aspectFill" class="uploaded-img"></image>
          <view wx:else class="upload-placeholder-admin"><view class="plus-symbol-admin">+</view><text>å¤´åƒ</text></view>
        </view>
        <view class="input-group">
          <view class="label">åŠ¨åŠ›ç±»å‹</view>
          <view class="radio-row">
            <view class="radio-btn {{form.type=='gas'?'active':''}}" data-val="gas" bindtap="setFormType" hover-class="btn-hover">æ²¹æ‘©</view>
            <view class="radio-btn {{form.type=='ev'?'active':''}}" data-val="ev" bindtap="setFormType" hover-class="btn-hover">ç”µæ‘©</view>
          </view>
        </view>
        <view class="label">åŸºæœ¬ä¿¡æ¯</view>
        <input class="modal-input" placeholder="æ˜µç§°" value="{{form.name}}" data-field="name" bindinput="handleFormInput" />
        <input class="modal-input" placeholder="è½¦å‹" value="{{form.bike}}" data-field="bike" bindinput="handleFormInput" />
        <view class="row-inputs">
          <input class="modal-input half" type="digit" placeholder="è§’åº¦" value="{{form.angle}}" data-field="angle" bindinput="handleFormInput" />
          <input class="modal-input half" type="digit" placeholder="é‡Œç¨‹" value="{{form.dist}}" data-field="dist" bindinput="handleFormInput" />
        </view>
        <view class="label">ç»¼åˆåˆ†</view>
        <input class="modal-input" type="digit" placeholder="ç•™ç©ºè‡ªåŠ¨è®¡ç®—" value="{{form.score}}" data-field="score" bindinput="handleFormInput" />
      </scroll-view>
      <button class="modal-btn save-btn" bindtap="saveRecord" hover-class="btn-hover">ä¿å­˜å‘å¸ƒ</button>
    </view>
  </view>

  <!-- ================= æ›´å¥½çœ‹çš„è‡ªå®šä¹‰å¼¹çª—ï¼ˆå¤ç”¨ my é¡µé£æ ¼ï¼‰ ================= -->
  <view class="custom-dialog-mask" wx:if="{{showDevDialog}}" bindtap="closeDevDialog">
    <view class="custom-dialog-box" catchtap="noop">
      <view class="cd-title">æç¤º</view>
      <view class="cd-content">äº§å“æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…</view>
      <view class="cd-btn-row">
        <view class="cd-btn confirm" bindtap="closeDevDialog">æˆ‘çŸ¥é“äº†</view>
      </view>
    </view>
  </view>
</view>























