<view class="app-container">
  <!-- é¡¶éƒ¨å¯¼èˆª - åˆ†äº«ç ç”¨æˆ·éšè—è¿”å›é”® -->
  <view class="header" wx:if="{{!isVideoFullScreen && !isShareCodeUser}}">
    <view class="back-icon" catchtap="handleBack">
      <text class="back-arrow">â€¹</text>
    </view>
  </view>
  <!-- é¡¶éƒ¨æ ‡é¢˜ä¿æŒå›ºå®š -->
  <view class="fixed-nav" wx:if="{{!isVideoFullScreen}}">
    <view class="back-btn" bindtap="handleBack" style="display: none;">
      <text class="back-icon">â€¹</text>
    </view>
    <view class="brand">
      <view class="brand-title-row">
      <text>{{pageTitle}}</text>
      </view>
      <!-- åªæœ‰ç™½åå•ç”¨æˆ·èƒ½çœ‹åˆ°çš„åˆ‡æ¢å¼€å…³ -->
      <view 
        wx:if="{{isAuthorized}}" 
        class="admin-toggle-btn {{isAdmin ? 'on' : ''}}" 
        catchtap="toggleAdminMode">
        {{isAdmin ? 'EXIT' : 'EDIT'}}
      </view>
    </view>
  </view>

  <!-- æ ¸å¿ƒï¼šèˆå°å®¹å™¨ï¼Œé€šè¿‡ translate æ§åˆ¶ä½ç§» -->
  <view 
    class="stage-wrapper" 
    style="transform: translateY(-{{stepIndex * winHeight}}px); height: {{winHeight}}px;"
    bindtouchstart="touchStart"
    bindtouchend="touchEnd">
    
    <!-- STEP 01: äº§å“é€‰æ‹© (100vh) -->
    <view class="step-view">
      <view class="view-content">
        <!-- ğŸ”´ ç§»é™¤æ ‡é¢˜ "é€‰æ‹©äº§å“å‹å·" -->
        <view class="card-stack">
          <view wx:for="{{products}}" wx:key="index" 
                class="p-card {{pIndex === index ? 'active' : ''}}" 
                bindtap="selectProduct" data-index="{{index}}">
            <view class="p-info">
              <text class="p-name">{{item.name}}</text>
            </view>
            <text class="mt-logo">MT</text>
            <view class="admin-del" wx:if="{{isAdmin}}" catchtap="deleteItem" data-type="products" data-index="{{index}}">Ã—</view>
            <view class="admin-number" wx:if="{{isAdmin}}" catchtap="setNumber" data-type="products" data-index="{{index}}">
              <text class="number-text">{{item.number || (index + 1)}}</text>
            </view>
          </view>
          <!-- ç®¡ç†å‘˜æ·»åŠ å— -->
          <view class="add-card-btn" wx:if="{{isAdmin}}" bindtap="addItem" data-type="products">+ æ·»åŠ å‹å·</view>
        </view>
      </view>
    </view>

    <!-- STEP 02: è½¦å‹é€‰æ‹© (100vh) -->
    <view class="step-view">
      <view class="view-content">
        <!-- ğŸ”´ ç§»é™¤æ ‡é¢˜ "ç¡®è®¤å®‰è£…è½¦å‹" -->
        <view class="type-stack">
          <view 
            wx:for="{{types}}" wx:key="index"
            class="t-card {{tIndex === index ? 'active' : ''}}"
            bindtap="selectType" data-index="{{index}}">
            
            <!-- åªæœ‰æ ‡é¢˜ï¼Œä¸æ”¾ä»»ä½•å‰¯æ ‡é¢˜æˆ–ç¼–å· -->
            <text class="t-name">{{item.name || item}}</text>

            <!-- çº¯ç²¹çš„å“ç‰Œæ°´å° -->
            <text class="mt-logo">MT</text>
            <view class="admin-del" wx:if="{{isAdmin}}" catchtap="deleteItem" data-type="types" data-index="{{index}}">Ã—</view>
            <view class="admin-number" wx:if="{{isAdmin}}" catchtap="setNumber" data-type="types" data-index="{{index}}">
              <text class="number-text">{{item.number || (index + 1)}}</text>
            </view>
          </view>
          <view class="add-card-btn" wx:if="{{isAdmin}}" bindtap="addItem" data-type="types">+ æ·»åŠ è½¦å‹åˆ†ç±»</view>
        </view>
      </view>
    </view>

    <!-- STEP 03: æ•™ç¨‹è¯¦æƒ… (100vhï¼Œå†…éƒ¨å¯å±€éƒ¨æ»šåŠ¨) -->
    <view class="step-view" id="step3">
      <view class="view-content" style="padding-bottom: 0;">
        <view class="mode-switch">
          <view class="m-btn {{mode === 'v' ? 'active' : ''}}" bindtap="switchMode" data-mode="v">åˆ†æ®µè§†é¢‘</view>
          <view class="m-btn {{mode === 'g' ? 'active' : ''}}" bindtap="switchMode" data-mode="g">å›¾æ–‡è¯¦æƒ…</view>
        </view>
        <!-- ç®¡ç†å‘˜æ¨¡å¼ï¼šæ˜¾ç¤ºå…¨éƒ¨ -->
        <view class="show-all-switch" wx:if="{{isAdmin}}" bindtap="toggleShowAll">
          <text class="show-all-text">{{showAll ? 'âœ“ æ˜¾ç¤ºå…¨éƒ¨' : 'æ˜¾ç¤ºå…¨éƒ¨'}}</text>
        </view>
        
        <!-- ç¬¬ä¸‰çº§é¡µé¢å†…éƒ¨æ»šåŠ¨ï¼Œé˜²æ­¢æ•™ç¨‹å¤ªé•¿ -->
        <scroll-view 
  id="tutorialScroll" 
  scroll-y 
  class="tutorial-scroll" 
  bindscroll="onScroll" 
  scroll-top="{{scrollTopValue}}"
  enhanced="{{true}}"
  fast-deceleration="{{true}}"
  scroll-anchoring="{{true}}"
  scroll-with-animation="{{false}}">
          <!-- è§†é¢‘æ¨¡å¼ -->
          <view class="tutorial-body" wx:if="{{mode === 'v'}}">
            <view 
              class="v-card {{isAdmin && isDragging && dragIndex === index && dragType === 'chapters' ? 'dragging' : ''}}"
              catchtap="doNothing"
              catchtouchstart="videoTouchStart"
              catchtouchend="videoTouchEnd"
              wx:for="{{filteredChapters}}" 
              wx:key="index"
              style="{{isAdmin && isDragging && dragIndex === index && dragType === 'chapters' ? 'transform: translateY(' + dragOffsetY + 'px) scale(1.02);' : ''}}"
              bindtouchstart="{{isAdmin ? 'onDragStart' : ''}}"
              catchtouchmove="{{isAdmin ? 'onDragMove' : ''}}"
              bindtouchend="{{isAdmin ? 'onDragEnd' : ''}}"
              data-index="{{index}}"
              data-type="chapters"
              id="video-card-{{index}}">
              <view class="v-player-wrapper" wx:if="{{item.url}}">
                <video 
                  class="v-player-real" 
                  src="{{item.url}}" 
                  direction="0" 
                  show-fullscreen-btn="{{false}}"
                  enable-play-gesture="{{true}}"
                  vslide-gesture="{{true}}"
                  vslide-gesture-in-fullscreen="{{true}}"
                  binderror="onVideoError"
                  bindplay="onVideoPlay"
                  data-index="{{index}}"
                  data-fileid="{{item.fileID}}"
                  object-fit="contain"
                  id="video-{{index}}"></video>
                <!-- ğŸ”´ è‡ªå®šä¹‰å…¨å±æŒ‰é’®ï¼Œè¦†ç›–åœ¨è§†é¢‘ä¸Š -->
                <view class="custom-fullscreen-btn" catchtap="openFullScreenVideo" data-index="{{index}}">
                  <text class="fullscreen-icon">â›¶</text>
                </view>
              </view>
              <view class="v-player" wx:else>
                <text style="color:#666">è§†é¢‘å¾…ä¸Šä¼ </text>
              </view>
              <view class="v-info">
                <text class="v-title">{{item.title || 'å®‰è£…é˜¶æ®µè¯´æ˜åŠæ³¨æ„äº‹é¡¹'}}</text>
                <view class="admin-actions" wx:if="{{isAdmin}}">
                  <view class="admin-edit-btn" bindtap="editItem" data-type="chapters" data-index="{{index}}">ç¼–è¾‘</view>
                  <view class="admin-del-btn" bindtap="deleteItem" data-type="chapters" data-index="{{index}}">åˆ é™¤</view>
                  <view class="admin-match-code">
                    <text class="match-code-text">{{item.matchCode || 'æœªè®¾ç½®'}}</text>
                  </view>
                </view>
              </view>
            </view>
            
            <!-- è§†é¢‘æ¨¡å¼ä¸‹æ·»åŠ æŒ‰é’® -->
            <view class="add-card-btn" wx:if="{{isAdmin && mode === 'v'}}" bindtap="uploadMedia" data-type="video">+ æ·»åŠ è§†é¢‘ç« èŠ‚</view>
          </view>
          <!-- å›¾æ–‡æ¨¡å¼ -->
          <view class="tutorial-body" wx:else>
            <view 
              class="g-article {{isAdmin && isDragging && dragIndex === index && dragType === 'graphics' ? 'dragging' : ''}}"
              wx:for="{{filteredGraphics}}" 
              wx:key="index"
              style="{{isAdmin && isDragging && dragIndex === index && dragType === 'graphics' ? 'transform: translateY(' + dragOffsetY + 'px) scale(1.02);' : ''}}"
              bindtouchstart="{{isAdmin ? 'onDragStart' : 'onGraphicTap'}}"
              catchtouchmove="{{isAdmin ? 'onDragMove' : ''}}"
              bindtouchend="{{isAdmin ? 'onDragEnd' : ''}}"
              data-index="{{index}}"
              data-type="graphics">
              <image class="g-media-real" src="{{item.img}}" mode="aspectFill" wx:if="{{item.img}}"></image>
              <view class="g-media" wx:else></view>
              <view class="g-info">
                <text class="g-title">{{item.title || 'å®‰è£…æµç¨‹å›¾è§£ 0' + (index+1)}}</text>
                <text class="g-desc" wx:if="{{item.desc && item.desc !== 'ç‚¹å‡»ç¼–è¾‘è¯¦ç»†æè¿°'}}">{{item.desc}}</text>
                <view class="admin-actions" wx:if="{{isAdmin}}">
                  <view class="admin-edit-btn" bindtap="editItem" data-type="graphics" data-index="{{index}}">ç¼–è¾‘</view>
                  <view class="admin-del-btn" bindtap="deleteItem" data-type="graphics" data-index="{{index}}">åˆ é™¤</view>
                  <view class="admin-match-code">
                    <text class="match-code-text">{{item.matchCode || 'æœªè®¾ç½®'}}</text>
                  </view>
                </view>
              </view>
            </view>
            
            <!-- å›¾æ–‡æ¨¡å¼ä¸‹æ·»åŠ æŒ‰é’® -->
            <view class="add-card-btn" wx:if="{{isAdmin && mode === 'g'}}" bindtap="uploadMedia" data-type="image">+ æ·»åŠ å›¾æ–‡æ­¥éª¤</view>
          </view>
          <view style="height: 100rpx;"></view>
        </scroll-view>
      </view>
    </view>

  </view>


  <!-- åŒ¹é…ç é€‰æ‹©å¼¹çª— -->
  <view class="match-code-modal {{matchCodePickerClosing ? 'closing' : ''}}" wx:if="{{showMatchCodePicker}}" catchtouchmove="noop">
    <view class="match-code-overlay" catchtap="hideMatchCodePicker"></view>
    <view class="match-code-content">
      <view class="match-code-header">
        <text class="match-code-title">é€‰æ‹©åŒ¹é…ç </text>
        <text class="match-code-close" catchtap="hideMatchCodePicker">Ã—</text>
      </view>
      <view class="match-code-body">
        <view class="picker-group">
          <text class="picker-label">äº§å“å·ç ï¼š</text>
          <picker mode="selector" range="{{availableProducts}}" range-key="name" value="{{matchCodeProductIndex}}" bindchange="onProductNumChange">
            <view class="picker-display">{{currentProductName}} ({{matchCodeProductNum}})</view>
          </picker>
        </view>
        <view class="picker-group">
          <text class="picker-label">è½¦å‹å·ç ï¼š</text>
          <picker mode="selector" range="{{availableTypes}}" range-key="name" value="{{matchCodeTypeIndex}}" bindchange="onTypeNumChange">
            <view class="picker-display">{{currentTypeName}} ({{matchCodeTypeNum}})</view>
          </picker>
        </view>
        <view class="match-code-preview">
          <text>åŒ¹é…ç ï¼š{{matchCodeProductNum}}+{{matchCodeTypeNum}}</text>
        </view>
      </view>
      <view class="match-code-footer">
        <view class="match-code-btn cancel" catchtap="hideMatchCodePicker">å–æ¶ˆ</view>
        <view class="match-code-btn confirm" catchtap="confirmMatchCode">ç¡®è®¤</view>
      </view>
    </view>
  </view>

  <!-- ç¼–è¾‘å¼¹çª— -->
  <view class="edit-modal {{editModalClosing ? 'closing' : ''}}" wx:if="{{showEditModal}}" catchtouchmove="noop">
    <view class="edit-overlay" catchtap="hideEditModal"></view>
    <view class="edit-content">
      <view class="edit-header">
        <text class="edit-title">ç¼–è¾‘å†…å®¹</text>
        <text class="edit-close" catchtap="hideEditModal">Ã—</text>
      </view>
      <view class="edit-body">
        <view class="edit-item">
          <text class="edit-label">æ ‡é¢˜ï¼š</text>
          <text class="edit-value">{{editItemData.title || ''}}</text>
        </view>
        <view class="edit-item">
          <text class="edit-label">åŒ¹é…ç ï¼š</text>
          <text class="edit-value">{{editItemData.matchCode || 'æœªè®¾ç½®'}}</text>
        </view>
      </view>
      <view class="edit-footer">
        <view class="edit-btn" bindtap="saveEdit">ç¼–è¾‘æ ‡é¢˜</view>
        <view class="edit-btn" bindtap="editMatchCode">ç¼–è¾‘åŒ¹é…ç </view>
        <view class="edit-btn cancel" catchtap="hideEditModal">å–æ¶ˆ</view>
      </view>
    </view>
  </view>
</view>

<!-- ğŸ”´ å…¨å±è§†é¢‘é®ç½©å±‚ï¼šè¦†ç›–åœ¨æ•´ä¸ªé¡µé¢ä¸Šï¼Œä¸æ”¹å˜ stepIndex -->
<view class="fullscreen-video-mask {{isVideoFullScreen ? 'active' : ''}} {{fullScreenVideoMaskClosing ? 'closing' : ''}}" wx:if="{{isVideoFullScreen}}" catchtouchmove="noop">
  <view class="fullscreen-video-container {{fullScreenVideoTransform}}" style="{{fullScreenVideoInitialStyle}}" catchtap="toggleFullScreenVideoPlay">
    <view class="fullscreen-close-btn" catchtap="closeFullScreenVideo">âœ•</view>
    <video 
      class="fullscreen-video-player" 
      src="{{fullScreenVideoUrl}}" 
      wx:if="{{fullScreenVideoUrl}}"
      direction="0" 
      show-fullscreen-btn="{{false}}"
      show-center-play-btn="{{false}}" 
      enable-play-gesture="{{false}}"
      vslide-gesture="{{true}}"
      vslide-gesture-in-fullscreen="{{true}}"
      object-fit="contain"
      paused="{{fullScreenVideoPaused}}"
      id="fullscreen-video-player"></video>
    <!-- ğŸ”´ æš‚åœæ—¶æ˜¾ç¤ºæ’­æ”¾æŒ‰é’® -->
    <view class="fullscreen-play-overlay {{fullScreenVideoPaused ? 'show' : ''}}" catchtap="toggleFullScreenVideoPlay">
      <view class="play-button-icon">â–¶</view>
    </view>
  </view>
</view>

<!-- è‡ªå®šä¹‰åŠ è½½åŠ¨ç”» -->
<view class="loading-mask" wx:if="{{showLoadingAnimation}}">
  <view class="loader">
    <text class="loader-label">è¯·ç¨å€™...</text>
    <view class="loading-bar"></view>
  </view>
</view>

<!-- å…¨å±€è‡ªå®šä¹‰å¼¹çª—ç»„ä»¶ -->
<custom-toast id="custom-toast" />

<!-- è‡ªå®šä¹‰åˆ†äº«ç å‰©ä½™æ¬¡æ•°å¼¹çª— -->
<view class="custom-modal-mask {{showShareCodeModal ? 'active' : ''}}" wx:if="{{showShareCodeModal}}" catchtouchmove="noop">
  <view class="custom-modal-box share-code-modal" catchtouchmove="noop">
    
    <block wx:if="{{shareCodeExhausted}}">
      <view class="modal-icon-warn">âš ï¸</view>
      <view class="modal-title-large">æ¬¡æ•°å·²ç”¨å®Œ</view>
      <view class="modal-desc">æ‚¨å·²æ— æ³•ç»§ç»­æŸ¥çœ‹å®‰è£…æ•™ç¨‹</view>
      <view class="modal-sub-desc">å¦‚éœ€å¸®åŠ©ï¼Œè¯·è”ç³»ç®¡ç†å‘˜</view>
    </block>
    
    <block wx:else>
      <view class="modal-header-label">å‰©ä½™æŸ¥çœ‹æ¬¡æ•°</view>
      <view class="modal-big-number">{{shareCodeRemaining}}</view>
      <view class="modal-footer-label">æ€»è®¡ {{shareCodeTotal}} æ¬¡æœºä¼š</view>
    </block>

    <view class="modal-btn-new {{shareCodeExhausted ? 'btn-red' : 'btn-black'}}" bindtap="closeShareCodeModal">
      æˆ‘çŸ¥é“äº†
    </view>
  </view>
</view>
