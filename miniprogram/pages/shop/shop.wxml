<!-- pages/shop/shop.wxml -->
<view class="container">

<!-- ================= 1. é¡¶éƒ¨å¯¼èˆª ================= -->
<!-- é¡¶éƒ¨è¿”å›ï¼Œåªåœ¨ä¸»åˆ—è¡¨æ˜¾ç¤ºï¼Œæ·±è‰²èƒŒæ™¯ç”¨ç™½è‰²ç®­å¤´ -->
<view class="header" wx:if="{{!showOrderModal && !showDetail}}">
  <view class="back-icon" catchtap="goBack">
    <text class="back-arrow">â€¹</text>
  </view>
</view>
<view class="nav-header">
  <!-- å·¦ä¾§ï¼šè¿”å›æŒ‰é’® -->
  <view class="nav-left">
  </view>
  
  <!-- ä¸­é—´åŒºåŸŸï¼šæ ‡é¢˜å’Œç®¡ç†å‘˜åˆ‡æ¢æŒ‰é’® -->
  <view class="brand-title" bindtap="handleTitleClick">
    <text>{{shopTitle || 'MT é…ä»¶ä¸­å¿ƒ'}}</text>
    <!-- åªæœ‰ç™½åå•ç”¨æˆ·èƒ½çœ‹åˆ°çš„åˆ‡æ¢å¼€å…³ -->
    <view 
      wx:if="{{isAuthorized}}" 
      class="admin-toggle-btn {{isAdmin ? 'on' : ''}}" 
      catchtap="toggleAdminMode">
      {{isAdmin ? 'EXIT' : 'EDIT'}}
    </view>
  </view>
  
  <view class="nav-right"></view>
</view>

<!-- ================= 2. ä¸»é¡µé¢ ================= -->
<scroll-view scroll-y class="main-scroll">
  
  <!-- é¡¶éƒ¨è½®æ’­ (Hero) -->
  <view class="hero-swiper-box">
    <swiper class="hero-swiper" indicator-dots="{{true}}" circular="{{true}}" autoplay="{{!isAdmin}}">
      <block wx:for="{{topMediaList}}" wx:key="url">
        <swiper-item>
          <view wx:if="{{item.type === 'video'}}" class="hero-video-wrapper">
            <video 
              src="{{item.url}}" 
              class="hero-media" 
              id="hero-video-{{index}}"
              muted 
              loop 
              show-play-btn="{{false}}" 
              show-center-play-btn="{{false}}"
              controls="{{false}}"
              bindplay="onVideoPlay"
              bindpause="onVideoPause"
              binderror="onVideoError"
              data-index="{{index}}"
              data-location="hero"
            ></video>
            <view class="video-play-overlay" bindtap="playVideo" data-index="{{index}}" data-url="{{item.url}}" data-location="hero">
              <view class="play-icon">
                <view class="play-triangle"></view>
              </view>
            </view>
          </view>
          <image wx:else src="{{item.url}}" class="hero-media" mode="aspectFill" />
          
          <view wx:if="{{isAdmin}}" class="admin-del-media" catchtap="adminDelTopMedia" data-index="{{index}}">âœ•</view>
        </swiper-item>
      </block>
    </swiper>
    
    <!-- Admin: å·¦å³åˆ†å¼€çš„ä¸Šä¼ æŒ‰é’® -->
    <view class="admin-upload-row" wx:if="{{isAdmin}}">
       <view class="up-btn" bindtap="adminAddImage">ğŸ“· ä¸Šä¼ å›¾ç‰‡</view>
       <view class="up-btn" bindtap="adminAddVideo">ğŸ¥ ä¸Šä¼ è§†é¢‘</view>
    </view>
  </view>

  <!-- äº§å“åˆ—è¡¨ (å•åˆ—å¤§å¡ç‰‡) -->
  <view class="product-list">
    <block wx:for="{{seriesList}}" wx:key="id">
      <view class="prod-card" bindtap="handleProductClick" data-index="{{index}}">
        <view class="product-cover-wrapper">
          <image class="p-img" src="{{item.cover}}" mode="aspectFill" />
          <!-- è·³è½¬å·ç æ ‡è¯†ï¼ˆç®¡ç†å‘˜æ¨¡å¼ä¸‹å¯ç¼–è¾‘ï¼‰ -->
          <view wx:if="{{isAdmin}}" class="jump-number-badge" catchtap="adminEditJumpNumber" data-index="{{index}}">
            <text wx:if="{{item.jumpNumber}}">#{{item.jumpNumber}}</text>
            <text wx:else>#</text>
          </view>
        </view>
        <view class="admin-float" wx:if="{{isAdmin}}" catchtap="adminUploadCover" data-index="{{index}}">ğŸ“·</view>
        
        <!-- çº¢è‰²åˆ é™¤æŒ‰é’® -->
        <view class="admin-del-card-btn" wx:if="{{isAdmin}}" catchtap="adminDeleteSeries" data-index="{{index}}">âœ•</view>
        
        <view class="p-info">
           <view class="p-row">
             <text class="p-title {{isAdmin?'editable':''}}" catchtap="{{isAdmin?'adminEditSeriesName':''}}" data-index="{{index}}">{{item.name}}</text>
             <view class="p-price-wrapper {{isAdmin ? 'editable' : ''}}" catchtap="{{isAdmin ? 'adminEditSeriesPrice' : ''}}" data-index="{{index}}">
               <text class="p-price">{{item.priceDisplay || 'Â¥' + item.models[0].price + ' èµ·'}}</text>
             </view>
           </view>
        </view>
      </view>
    </block>
    <!-- Admin æ·»åŠ äº§å“ -->
    <view class="add-series-btn" wx:if="{{isAdmin}}" bindtap="adminAddSeries">+ æ·»åŠ æ–°äº§å“ç³»åˆ—</view>
  </view>

  <view style="height: 100rpx;"></view>
</scroll-view>

<!-- ================= 3. äº§å“è¯¦æƒ…å¼¹çª— (Detail) ================= -->
<view class="full-modal {{showDetail ? 'active' : ''}}">
  <!-- å¼¹çª—å¤´ -->
  <view class="modal-nav">
    <view class="nav-close" catchtap="closeDetail">âœ•</view>
    <!-- ç®¡ç†å‘˜æ¨¡å¼ä¸‹ï¼šæ ‡é¢˜å¯ç‚¹å‡»ç¼–è¾‘ -->
    <view 
      class="modal-title {{isAdmin ? 'editable' : ''}}" 
      catchtap="{{isAdmin ? 'adminEditSeriesNameInDetail' : ''}}">
      {{currentSeries.name}}
    </view>
    <view style="width:60rpx"></view>
  </view>

  <!-- å¼¹çª—å†…å®¹åŒº -->
  <scroll-view scroll-y class="modal-scroll" bindscroll="onDetailScroll">
    <view class="scroll-inner">
      
      <!-- (A) è¯¦æƒ…é•¿å›¾/è§†é¢‘ -->
      <view class="detail-images">
         <block wx:for="{{currentSeries.detailImages}}" wx:key="url">
           <view class="dimg-box">
              <view wx:if="{{item.type === 'video'}}" class="detail-video-wrapper">
                <video 
                  src="{{item.url}}" 
                  class="dimg" 
                  style="height:422rpx; width:100%;" 
                  id="detail-video-{{index}}"
                  muted 
                  loop 
                  show-play-btn="{{false}}" 
                  show-center-play-btn="{{false}}"
                  controls="{{false}}"
                  bindplay="onVideoPlay"
                  bindpause="onVideoPause"
                  binderror="onVideoError"
                  data-index="{{index}}"
                  data-location="detail"
                ></video>
                <view class="video-play-overlay" bindtap="playVideo" data-index="{{index}}" data-url="{{item.url}}" data-location="detail">
                  <view class="play-icon">
                    <view class="play-triangle"></view>
                  </view>
                </view>
              </view>
              <image wx:else src="{{item.url}}" mode="aspectFill" class="dimg" />
              
              <view wx:if="{{isAdmin}}" class="admin-del-abs" catchtap="adminDelDetailImg" data-index="{{index}}">âœ•</view>
           </view>
         </block>
         <view class="add-txt-btn" wx:if="{{isAdmin}}" bindtap="adminAddDetailMedia">+ æ·»åŠ è¯¦æƒ…å›¾ç‰‡/è§†é¢‘</view>
      </view>

      <!-- 2. é€‰è´­é…ç½®åŒº -->
      <view class="config-sec">
        
        <!-- æ ‡é¢˜è¡Œ -->
        <view class="sec-header-row">
            <view class="sec-title {{isAdmin?'editable':''}}" catchtap="{{isAdmin?'adminEditLabel':''}}" data-key="configTitle">
              {{currentSeries.labels.configTitle || 'é€‰è´­é…ç½®'}}
            </view>
            <!-- å¯¹æ¯”æŒ‰é’® -->
            <view class="btn-compare" 
                  wx:if="{{currentSeries.models.length > 1}}" 
                  bindtap="toggleModelCompareMode">
              {{isModelCompareMode ? 'å–æ¶ˆé€‰æ‹©' : 'å‚æ•°å¯¹æ¯”'}}
            </view>
        </view>

        <!-- å¯¹æ¯”ç¡®è®¤æ¡ -->
        <view wx:if="{{isModelCompareMode}}" style="text-align:center; margin-bottom:20rpx;">
          <view class="btn-black" style="display:inline-block; font-size:24rpx; padding:10rpx 40rpx;" bindtap="startCompare">
            å¼€å§‹å¯¹æ¯” (å·²é€‰{{compareSelectedModels.length}})
          </view>
        </view>

        <!-- A. é€‰æ‹©å‹å· -->
        <view class="cfg-group">
          <view class="cfg-label {{isAdmin?'editable':''}}" catchtap="{{isAdmin?'adminEditLabel':''}}" data-key="modelTitle">
            {{currentSeries.labels.modelTitle || 'é€‰æ‹©å‹å·'}}
          </view>
          
          <block wx:for="{{currentSeries.models}}" wx:key="name">
            <view 
              class="model-card-normal {{ (!isModelCompareMode && selectedModelIdx === index) || (isModelCompareMode && item.isCompareChecked) ? 'selected' : ''}}" 
              bindtap="selectModel" 
              data-index="{{index}}">
              
              <view wx:if="{{isModelCompareMode}}" class="circle {{item.isCompareChecked ? 'checked' : ''}}" style="margin-right:20rpx;"></view>

              <view style="flex:1">
                  <text class="m-name {{isAdmin?'editable':''}}" catchtap="{{isAdmin?'adminEditModelName':''}}" data-midx="{{index}}">{{item.name}}</text>
                  <text class="m-desc {{isAdmin?'editable':''}}" catchtap="{{isAdmin?'adminEditModelDesc':''}}" data-midx="{{index}}">{{item.desc || (isAdmin ? 'ç‚¹å‡»æ·»åŠ æè¿°' : '')}}</text>
              </view>
              
              <!-- ğŸ”´ ä¼˜åŒ–ï¼šæŠŠä»·æ ¼åŒ…è£…åœ¨ view ä¸­ï¼Œæ ¹æ®ç®¡ç†å‘˜æ¨¡å¼è®¾ç½®ä¸åŒçš„ class -->
              <!-- ğŸ”´ ä¿®å¤ï¼šéç®¡ç†å‘˜æ¨¡å¼ä¸‹ä½¿ç”¨ bindtap æˆ–ä¸ç»‘å®šï¼Œé¿å…é˜»æ­¢äº‹ä»¶å†’æ³¡ -->
              <view class="m-price-wrapper {{isAdmin ? 'm-price-wrapper-admin' : 'm-price-wrapper-normal'}}" catchtap="{{isAdmin ? 'adminEditModelPrice' : ''}}" data-midx="{{index}}">
                <text class="m-price {{isAdmin?'editable':''}}">Â¥{{item.price}}</text>
              </view>
              
              <view wx:if="{{isAdmin}}" class="admin-del-mini" catchtap="adminDelModel" data-midx="{{index}}">âœ•</view>
            </view>
          </block>
          <view wx:if="{{isAdmin}}" class="add-txt-btn" bindtap="adminAddModel">+ æ·»åŠ å‹å·</view>
        </view>

        <!-- B. é…ç½®æ–¹æ¡ˆ -->
        <view class="cfg-group">
          <view class="cfg-label {{isAdmin?'editable':''}}" catchtap="{{isAdmin?'adminEditLabel':''}}" data-key="optionTitle">
            {{currentSeries.labels.optionTitle || 'é…ç½®æ–¹æ¡ˆ'}}
          </view>
          <view class="opt-grid {{isAdmin ? 'admin-mode' : ''}}">
             <block wx:for="{{currentSeries.options}}" wx:key="name">
                <view class="opt-card {{selectedOptionIdx === index ? 'selected' : ''}} {{isAdmin ? 'admin-mode' : ''}}" bindtap="selectOption" data-index="{{index}}">
                   <!-- æ™®é€šæ¨¡å¼ï¼šæ˜¾ç¤ºå›¾ç‰‡ -->
                   <image wx:if="{{item.img && !isAdmin}}" src="{{item.img}}" class="opt-img" mode="aspectFill" />
                   
                   <!-- ç®¡ç†å‘˜æ¨¡å¼ï¼šå·¦è¾¹æ–‡å­—åŒºåŸŸ -->
                   <view class="opt-info">
                      <text class="opt-name {{isAdmin?'editable':''}}" catchtap="{{isAdmin?'adminEditOptName':''}}" data-oidx="{{index}}">{{item.name}}</text>
                      <text class="opt-sub {{isAdmin?'editable':''}}" catchtap="{{isAdmin?'adminEditOptPrice':''}}" data-oidx="{{index}}">{{item.price > 0 ? '+Â¥'+item.price : 'æ ‡é…'}}</text>
                   </view>
                   
                   <!-- ç®¡ç†å‘˜æ¨¡å¼ï¼šå³è¾¹ä¸Šä¼ ç…§ç‰‡æŒ‰é’® -->
                   <view wx:if="{{isAdmin}}" class="admin-add-icon" catchtap="adminUploadOptionImg" data-oidx="{{index}}">
                     <image wx:if="{{item.img}}" src="{{item.img}}" style="width: 100%; height: 100%; border-radius: 14rpx; object-fit: cover;" mode="aspectFill" />
                     <text wx:else style="font-size: 50rpx;">ğŸ“·</text>
                   </view>
                   
                   <!-- åˆ é™¤æŒ‰é’® -->
                   <view wx:if="{{isAdmin}}" class="admin-del-corner" catchtap="adminDelOption" data-oidx="{{index}}">âœ•</view>
                </view>
             </block>
             <view class="opt-card add-btn {{isAdmin ? 'admin-mode' : ''}}" wx:if="{{isAdmin}}" bindtap="adminAddOption">+</view>
          </view>
        </view>

        <!-- C. é…ä»¶åŠ è´­ -->
        <view class="cfg-group" wx:if="{{accessoryList.length > 0 || isAdmin}}">
          <view class="cfg-label {{isAdmin?'editable':''}}" catchtap="{{isAdmin?'adminEditLabel':''}}" data-key="accTitle">
            {{currentSeries.labels.accTitle || 'é…ä»¶åŠ è´­'}}
          </view>
          <view class="acc-list-v">
            <block wx:for="{{accessoryList}}" wx:key="id">
               <view class="acc-row-card {{item.selected ? 'selected' : ''}}" 
                     bindtap="openAccessoryDetail" data-index="{{index}}">
            
            <image class="acc-thumb" src="{{item.img}}" mode="aspectFill" />
            <view wx:if="{{isAdmin}}" class="admin-float-thumb" catchtap="adminUploadAccThumb" data-index="{{index}}">ğŸ“·</view>

            <view class="acc-info">
                <text class="acc-n">{{item.name}}</text>
                <text class="acc-p">Â¥{{item.price}}</text>
            </view>

            <view class="acc-add-btn {{item.selected ? 'checked' : ''}}" 
                  catchtap="toggleAccessorySelection" 
                  data-index="{{index}}">
               {{item.selected ? 'å·²é€‰' : 'æ·»åŠ '}}
            </view>
            
            <view wx:if="{{isAdmin}}" class="admin-del-corner-top" catchtap="adminDelAcc" data-index="{{index}}">âœ•</view>
          </view>
            </block>
      <view wx:if="{{isAdmin}}" class="add-txt-btn" bindtap="adminAddAcc">+ æ·»åŠ é…ä»¶</view>
    </view>
  </view>

      </view>
      <view style="height:200rpx;"></view> 
    </view>
  </scroll-view>

  <!-- 2. åº•éƒ¨ç»“ç®—æ  -->
  <view class="modal-footer {{showFooterBar ? 'visible' : ''}}">
    <view class="footer-btn-group">
      <view class="btn-cart" id="cart-target" bindtap="addToCart">åŠ å…¥è´­ç‰©è½¦</view>
      <view class="btn-buy" bindtap="openCartOrder">ç«‹å³è´­ä¹°</view>
    </view>
  </view>
</view>

<!-- ================= 4. å¯¹æ¯”è¡¨æ ¼å¼¹çª— (æœ€ç»ˆä¿®æ­£ç‰ˆ) ================= -->
<!-- é®ç½©å±‚ -->
<view class="dark-mask" wx:if="{{showSpecsModal}}" bindtap="closeSpecsModal" catchtouchmove="noop" style="z-index: 998;"></view>

<!-- å¼¹çª—ä¸»ä½“ -->
<view class="overlay {{showSpecsModal ? 'active' : ''}}" catchtap="stopPropagation" catchtouchmove="noop">
  
  <!-- 1. æ ‡é¢˜æ  (ç™½è‰²èƒŒæ™¯) -->
  <view class="overlay-head">
    <text>å¯¹æ¯”è¯¦æƒ…</text>
    <view catchtap="closeSpecsModal" class="close">âœ•</view>
  </view>
  
  <!-- 2. ç°è‰²èƒ¶å›Šè¡¨å¤´ (å›ºå®šä¸åŠ¨ï¼Œä½äºæ ‡é¢˜æ ä¸‹æ–¹) -->
  <view class="specs-header-container">
    <view class="capsule-header">
      <view class="sp-cell label">å‚æ•°é¡¹</view>
      <block wx:for="{{compareData.headers}}" wx:key="*this">
        <view class="sp-cell">{{item}}</view>
      </block>
      <view wx:if="{{isAdmin}}" class="sp-cell admin-w"></view>
    </view>
  </view>
  
  <!-- 3. æ»šåŠ¨å†…å®¹åŒº -->
  <scroll-view scroll-y class="specs-scroll-body" enable-back-to-top="{{true}}">
    <view class="specs-table-content">
       
       <block wx:for="{{compareData.rows}}" wx:key="label" wx:for-index="rowIdx">
         <view class="sp-row">
            <view class="sp-cell label {{isAdmin?'editable':''}}" catchtap="{{isAdmin?'adminEditSpecCell':''}}" data-row="{{rowIdx}}" data-key="label">{{item.label}}</view>
            <block wx:for="{{item.vals}}" wx:for-item="val" wx:key="*this" wx:for-index="valIdx">
               <view class="sp-cell {{isAdmin?'editable':''}}" catchtap="{{isAdmin?'adminEditSpecCell':''}}" data-row="{{rowIdx}}" data-key="v{{valIdx+1}}">{{val}}</view>
            </block>
            <view wx:if="{{isAdmin}}" class="sp-cell admin-w" catchtap="adminDelSpecRow" data-index="{{rowIdx}}">âœ•</view>
         </view>
       </block>
       
       <view wx:if="{{isAdmin}}" class="add-txt-btn" bindtap="adminAddSpecRow">+ æ·»åŠ å‚æ•°è¡Œ</view>
       
       <!-- åº•éƒ¨è§†é¢‘æŒ‰é’® -->
       <view class="compare-btn-area" 
             wx:if="{{isAdmin || (currentSeries.compareVideo && currentSeries.showCompareVideo)}}">
         <view class="btn-watch-compare" bindtap="watchCompareVideo">
           <text class="icon-play" style="margin-right: 10rpx;">â–¶</text> æŸ¥çœ‹å¯¹æ¯”æ¼”ç¤ºè§†é¢‘
         </view>

         <view class="admin-video-controls" wx:if="{{isAdmin}}">
           <view class="admin-v-btn upload" bindtap="adminUploadCompareVideo">
             {{currentSeries.compareVideo ? 'æ›´æ¢è§†é¢‘' : 'ä¸Šä¼ è§†é¢‘'}}
           </view>
           <view class="admin-v-btn toggle {{currentSeries.showCompareVideo ? 'on' : 'off'}}" 
                 bindtap="adminToggleVideoVis">
             {{currentSeries.showCompareVideo ? 'æ˜¾ç¤ºä¸­' : 'å·²éšè—'}}
           </view>
         </view>

       </view>

    </view>
  </scroll-view>
</view>

<!-- ================= 5. é…ä»¶è¯¦æƒ…å¼¹çª— ================= -->
<view class="full-modal {{showAccDetail ? 'active' : ''}}" style="z-index: 300;">
  <view class="modal-nav">
     <view class="nav-close" bindtap="closeAccessoryDetail">âœ•</view>
     <view class="modal-title">é…ä»¶è¯¦æƒ…</view>
     <view style="width:60rpx"></view>
  </view>
  <scroll-view scroll-y class="modal-scroll">
     <view class="acc-detail-hero">
        <image wx:if="{{accessoryList[currentAccIdx].detailImages.length>0}}" 
               src="{{accessoryList[currentAccIdx].detailImages[0]}}" mode="aspectFill" class="dimg"/>
        <view wx:else style="padding:100rpx; text-align:center; color:#ccc;">ç‚¹å‡»ä¸‹æ–¹æ·»åŠ è¯¦æƒ…å›¾</view>
        
        <view wx:if="{{isAdmin}}" class="add-txt-btn" bindtap="adminAddAccDetailImg">+ æ·»åŠ /æ›´æ¢å›¾ç‰‡</view>
     </view>
     
     <view class="acc-detail-info">
        <view class="acc-d-name {{isAdmin?'editable':''}}" catchtap="{{isAdmin?'adminEditAccName':''}}">{{accessoryList[currentAccIdx].name}}</view>
        <view class="acc-d-price {{isAdmin?'editable':''}}" catchtap="{{isAdmin?'adminEditAccPrice':''}}">Â¥{{accessoryList[currentAccIdx].price}}</view>
        <view class="acc-d-desc {{isAdmin?'editable':''}}" catchtap="{{isAdmin?'adminEditAccDesc':''}}">{{accessoryList[currentAccIdx].desc || 'æš‚æ— æè¿°'}}</view>
     </view>
  </scroll-view>
  
  <view class="modal-footer">
     <view></view>
     <view class="btn-black full" bindtap="addAccToCartFromDetail">åŠ å…¥è´­ç‰©è¢‹</view>
  </view>
</view>

<!-- ================= 6. åŠ å…¥è´­ç‰©è½¦æˆåŠŸå¼¹çª—ï¼ˆå¼¹å‡º+æ”¶ç¼©é€€å‡ºåŠ¨ç”»ï¼‰ ================= -->
<view class="success-mask {{cartSuccessClosing ? 'closing' : ''}}" wx:if="{{showCartSuccess}}" catchtouchmove="noop" catchtap="noop">
  <view class="success-box" catchtouchmove="noop" catchtap="noop">
    <view class="s-icon">âœ”</view>
    <view class="s-title">å·²åŠ å…¥è´­ç‰©è½¦</view>
    <view class="s-desc">å•†å“å·²ä¿å­˜ï¼Œæ‚¨å¯ä»¥ç»§ç»­é€‰è´­æˆ–å»ç»“ç®—</view>
    
    <view class="s-btn-row">
      <view class="s-btn outline" bindtap="onContinueShopping">ç»§ç»­é€‰è´­</view>
      <view class="s-btn fill" bindtap="onGoToCheckout">ç«‹å³ç»“ç®—</view>
    </view>
  </view>
</view>

<!-- ================= 7. è®¢å•ç¡®è®¤/ç»“ç®—å¼¹çª— ================= -->
<view class="dark-mask" wx:if="{{showOrderModal}}" bindtap="closeOrderModal"></view>

<view class="overlay full-screen-overlay {{showOrderModal ? 'active' : ''}}" style="z-index: 600;">
  <!-- é¡¶éƒ¨ -->
  <view class="checkout-header">
    <view class="nav-close" bindtap="closeOrderModal">âœ•</view>
    <view class="co-title">ç¡®è®¤è®¢å•</view>
    <view style="width:40rpx"></view>
  </view>

  <scroll-view scroll-y class="checkout-scroll">
    <view class="checkout-body">
      
      <!-- å•†å“æ¸…å• -->
      <view class="group-card">
        <view class="cart-header-row">
          <view class="cart-title">å•†å“æ¸…å•</view>
          <view class="clear-btn-stylish" bindtap="clearCart">
            <text>ğŸ—‘ æ¸…ç©º</text>
          </view>
        </view>

        <block wx:for="{{cart}}" wx:key="id">
          <view class="cart-row">
            <view class="cr-info">
              <view class="cr-name">{{item.name}}</view>
              <view class="cr-spec">{{item.spec}}</view>
            </view>
            
            <view class="cr-action">
              <view class="cr-price">Â¥{{item.total}}</view>
              <view class="mini-stepper">
                <view class="ms-btn" catchtap="handleCartQty" data-index="{{index}}" data-type="minus">-</view>
                <view class="ms-num">{{item.quantity}}</view>
                <view class="ms-btn" catchtap="handleCartQty" data-index="{{index}}" data-type="plus">+</view>
              </view>
            </view>
          </view>
        </block>
        
        <view wx:if="{{cart.length === 0}}" class="empty-cart">è´­ç‰©è½¦æš‚æ— å•†å“</view>
        
      </view>

      <!-- é…é€æ–¹å¼ -->
      <view class="group-header-row">
        <view class="group-title-text">é…é€æ–¹å¼</view>
      </view>
      <view class="shipping-box">
        <view class="ship-item {{shippingMethod=='zto'?'active':''}}" bindtap="changeShipping" data-method="zto">
          <view class="ship-name">ä¸­é€šå¿«é€’</view>
          <view class="ship-price">åŒ…é‚®</view>
        </view>
        <!-- é¡ºä¸°é€‰é¡¹ -->
        <view class="ship-item {{shippingMethod=='sf'?'active':''}}" bindtap="changeShipping" data-method="sf">
          <view class="ship-name">é¡ºä¸°é€Ÿè¿</view>
          <view class="ship-price">
             <!-- å¦‚æœæ²¡å¡«åœ°å€æˆ–è§£æä¸åˆ°çœä»½ï¼Œæ˜¾ç¤ºå¾…è®¡ç®—ï¼›å¦åˆ™æ˜¾ç¤ºé‡‘é¢ -->
             {{!detailAddress || shippingFee == 0 ? 'å¾…è®¡ç®—' : 'Â¥'+shippingFee}}
             <text style="font-size:20rpx; color:#999; display:block;">(çœå†…13/çœå¤–22)</text>
          </view>
        </view>
      </view>

      <!-- æ€»ä»·æ˜¾ç¤ºåŒº -->
      <view class="final-total-row">
        <text class="ft-label">å…± {{cart.length}} ä»¶ï¼Œæ€»è®¡</text>
        <text class="ft-price">Â¥{{finalTotalPrice}}</text>
      </view>

      <!-- æ”¶è´§ä¿¡æ¯ -->
      <view class="group-header-row">
        <view class="group-title-text">æ”¶è´§ä¿¡æ¯</view>
        <view class="paste-btn-header" bindtap="openSmartPasteModal">æ™ºèƒ½ç²˜è´´</view>
      </view>

      <view class="group-card form-group">

        <!-- å§“å -->
        <view class="form-item">
          <view class="form-label">æ”¶è´§äºº</view>
          <input class="form-input" placeholder="è¯·å¡«å†™å§“å" placeholder-class="ph-style" bindinput="onInput" data-key="name" value="{{orderInfo.name}}"/>
        </view>

        <!-- æ‰‹æœºå· -->
        <view class="form-item">
          <view class="form-label">æ‰‹æœºå·</view>
          <input class="form-input" type="number" maxlength="11" placeholder="è¯·å¡«å†™11ä½æ‰‹æœºå·" placeholder-class="ph-style" bindinput="onInput" data-key="phone" value="{{orderInfo.phone}}"/>
        </view>


        <!-- [ä¿®æ”¹] è¯¦ç»†åœ°å€ -->
        <view class="form-item">
          <view class="form-label">è¯¦ç»†åœ°å€</view>
          <input class="form-input" placeholder="å¦‚ï¼šå¹¿ä¸œçœ ä½›å±±å¸‚ å—æµ·åŒº æŸæŸè¡—é“101å·" placeholder-class="ph-style" bindinput="onInput" data-key="detailAddress" value="{{detailAddress}}"/>
        </view>

      </view>

      <!-- å…è´£åè®®ï¼ˆä¿æŒåœ¨æœ€ä¸‹é¢ï¼Œä½ç½®ç¨å¾®é«˜ä¸€ç‚¹ï¼‰ -->
      <view class="disclaimer-section">
        <view class="disclaimer-checkbox">
          <checkbox-group bindchange="onDisclaimerChange">
            <label class="disclaimer-label">
              <checkbox value="agree" checked="{{agreedToDisclaimer}}"/>
              <view class="disclaimer-text-wrapper">
                <text class="disclaimer-text">æˆ‘å·²é˜…è¯»å¹¶åŒæ„</text>
                <text class="disclaimer-link" catchtap="showDisclaimerModal">ã€Šå…è´£åè®®ã€‹</text>
              </view>
            </label>
          </checkbox-group>
        </view>
      </view>

    </view>
  </scroll-view>

  <!-- åº•éƒ¨å•æŒ‰é’® (ç«‹å³æ”¯ä»˜) -->
  <view class="checkout-footer-single">
    <view class="btn-black full {{!agreedToDisclaimer ? 'grayed' : ''}}" catchtap="submitOrder" data-agreed="{{agreedToDisclaimer}}">
      <text class="btn-main">ç«‹å³æ”¯ä»˜ Â¥{{finalTotalPrice}}</text>
    </view>
  </view>
</view>

<!-- ================= 8. è‡ªå®šä¹‰ç¼–è¾‘å¼¹çª— ================= -->
<view class="custom-modal-mask {{customModalClosing ? 'closing' : ''}}" wx:if="{{showCustomEditModal}}" catchtouchmove="noop" catchtap="noop">
  <view class="custom-modal-box" catchtouchmove="noop" catchtap="noop">
    <view class="custom-modal-title">{{customEditTitle}}</view>
    <input class="custom-modal-input" value="{{customEditVal}}" bindinput="onCustomEditInput" focus="{{showCustomEditModal}}" cursor-spacing="100"/>
    <view class="custom-modal-btn-row">
      <view class="custom-btn c-btn-cancel" bindtap="closeCustomEditModal">å–æ¶ˆ</view>
      <view class="custom-btn c-btn-confirm" bindtap="confirmCustomEdit">ç¡®å®š</view>
    </view>
  </view>
</view>

<!-- ================= è‡ªå®šä¹‰å¼¹çª—ï¼ˆæ›¿æ¢ wx.showModalï¼Œå¸¦æ”¶ç¼©é€€å‡ºåŠ¨ç”»ï¼‰ ================= -->
<view class="custom-dialog-mask {{dialogClosing ? 'closing' : ''}}" wx:if="{{dialog.show}}" catchtouchmove="noop" catchtap="noop">
  <view class="custom-dialog-box" catchtouchmove="noop" catchtap="noop">
    <view class="cd-title">{{dialog.title}}</view>
    <rich-text class="cd-content" nodes="{{dialog.content}}"></rich-text>
    <view class="cd-btn-row">
      <view class="cd-btn cancel" wx:if="{{dialog.showCancel}}" bindtap="closeCustomDialog">{{dialog.cancelText}}</view>
      <view class="cd-btn confirm" bindtap="onDialogConfirm">{{dialog.confirmText}}</view>
    </view>
  </view>
</view>

<!-- ================= è‡ªåŠ¨æ¶ˆå¤±æç¤ºï¼ˆæ— æŒ‰é’®ï¼Œ2ç§’åè‡ªåŠ¨æ¶ˆå¤±ï¼Œå¸¦æ”¶ç¼©é€€å‡ºåŠ¨ç”»ï¼‰ ================= -->
<view class="auto-toast-mask {{autoToastClosing ? 'closing' : ''}}" wx:if="{{autoToast.show}}" catchtouchmove="noop" catchtap="noop">
  <view class="auto-toast-box" catchtouchmove="noop" catchtap="noop">
    <view class="at-title">{{autoToast.title}}</view>
    <view class="at-content">{{autoToast.content}}</view>
  </view>
</view>

<!-- ================= 9. å±å¹•ä¸­é—´æç¤ºæ°”æ³¡ ================= -->
<view class="center-toast-mask {{centerToastClosing ? 'closing' : ''}}" wx:if="{{centerToast.show}}" catchtouchmove="noop" catchtap="noop">
  <view class="center-toast-box" catchtouchmove="noop" catchtap="noop">
    <view class="ct-icon">!</view> 
    <view class="ct-text">{{centerToast.text}}</view>
  </view>
</view>

<!-- ================= 10. æ™ºèƒ½ç²˜è´´è¾“å…¥å¼¹çª— ================= -->
<view class="smart-paste-mask {{smartPasteClosing ? 'closing' : ''}}" wx:if="{{showSmartPasteModal}}" style="z-index: 99999;" catchtouchmove="noop" catchtap="noop">
  <view class="smart-paste-box" catchtouchmove="noop" catchtap="noop">
    <view class="sp-title">æ™ºèƒ½ç²˜è´´</view>
    <view class="sp-desc">è¯·å°†å§“åã€ç”µè¯ã€åœ°å€ç²˜è´´åˆ°ä¸‹æ–¹æ¡†ä¸­</view>
    <textarea 
      class="sp-textarea" 
      placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰ 13800138000 å¹¿ä¸œçœæ·±åœ³å¸‚å—å±±åŒº..." 
      value="{{smartPasteVal}}" 
      bindinput="onSmartPasteInput"
      adjust-position="{{true}}"
      fixed="{{true}}"
    ></textarea>
    <view class="sp-btn-row">
      <view class="sp-btn cancel" bindtap="closeSmartPasteModal">å–æ¶ˆ</view>
      <view class="sp-btn confirm" bindtap="confirmSmartPaste">æ™ºèƒ½åˆ†æ</view>
    </view>
  </view>
</view>

<!-- ================= è‡ªå®šä¹‰æ“ä½œèœå•ï¼ˆæ›¿ä»£ wx.showActionSheetï¼‰ ================= -->
<view class="action-sheet-mask {{actionSheetClosing ? 'closing' : ''}}" wx:if="{{actionSheet.show}}" bindtap="closeActionSheet" catchtouchmove="noop" catchtap="noop">
  <view class="action-sheet-box" catchtap="noop" catchtouchmove="noop">
    <view 
      class="action-sheet-item" 
      wx:for="{{actionSheet.itemList}}" 
      wx:key="index"
      data-index="{{index}}"
      bindtap="onActionSheetItemTap"
    >
      {{item}}
    </view>
    <view class="action-sheet-cancel" bindtap="closeActionSheet">å–æ¶ˆ</view>
  </view>
</view>

<!-- ================= 11. è‡ªå®šä¹‰å…¨å±è§†é¢‘æ’­æ”¾å™¨ ================= -->
<view class="video-modal-mask" wx:if="{{showVideoPlayer}}" style="z-index: 99999;" bindtap="toggleVideoPlayPause" catchtouchmove="noop">
  <view class="video-close-btn" catchtap="closeVideoPlayer">âœ•</view>
  <video 
    src="{{currentVideoUrl}}" 
    id="fullscreen-video"
    autoplay="{{true}}" 
    class="fullscreen-video" 
    show-fullscreen-btn="{{false}}" 
    show-center-play-btn="{{false}}"
    object-fit="contain"
    bindplay="onVideoPlay"
    bindpause="onVideoPause"
    bindcanplay="onVideoCanPlay"
    bindtimeupdate="onVideoTimeUpdate"
    bindtap="toggleVideoPlayPause"
  ></video>
  <view class="video-pause-overlay {{!isVideoPlaying ? 'show' : ''}}" catchtap="toggleVideoPlayPause">
    <view class="play-icon">
      <view class="play-triangle"></view>
    </view>
  </view>
</view>

<!-- ================= è‡ªå®šä¹‰åŠ è½½åŠ¨ç”»ï¼ˆç™½è‰²èƒŒæ™¯è¿›åº¦æ¡ï¼‰ ================= -->
<view class="loading-mask" wx:if="{{showLoadingAnimation}}" catchtouchmove="noop" catchtap="noop">
  <view class="loader" catchtouchmove="noop" catchtap="noop">
    <text class="loader-label">{{loadingText}}</text>
    <view class="loading-bar"></view>
  </view>
</view>

</view>
<!-- å…¨å±€è‡ªå®šä¹‰å¼¹çª—ç»„ä»¶ -->
<custom-toast id="custom-toast" />
