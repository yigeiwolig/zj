<wxs module="tools">
  module.exports.includes = function(arr, target) {
    return arr && arr.indexOf(target) > -1;
  }
</wxs>

<view class="container" bindtap="onBgTap">
  
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <view class="header">
    <view class="back-icon" catchtap="goBack">
      <text style="font-size: 48rpx; font-weight: 300; color: #000; line-height: 1;">â€¹</text>
    </view>
  </view>
  
  <!-- ç®¡ç†å‘˜åˆ‡æ¢æŒ‰é’® -->
  <view 
    wx:if="{{isAuthorized}}" 
    class="admin-toggle-btn {{isAdmin ? 'on' : ''}}" 
    catchtap="toggleAdminMode">
    {{isAdmin ? 'EXIT' : 'EDIT'}}
  </view>

  <!-- 1. è½®ç›˜åˆ—è¡¨å±‚ -->
  <view class="wheel-stage {{isDetailOpen ? 'hidden' : ''}}" 
    bindtouchstart="onTouchStart" bindtouchmove="onTouchMove" bindtouchend="onTouchEnd">
    <block wx:for="{{shops}}" wx:key="id">
      <view class="card {{currentIndex === index ? 'active' : ''}} {{item.isOpen ? 'open' : 'closed'}}"
        style="{{cardStyles[index]}}" id="card-{{index}}"
        catchtap="onCardTap" data-index="{{index}}" mark:type="card">
        <view class="c-left">
          <view class="c-name">{{item.name}}</view>
          <view class="c-services-row">
            <block wx:for="{{allServices}}" wx:for-item="srv" wx:key="name">
              <view class="cs-icon has" wx:if="{{item.serviceSet[srv.name]}}">{{srv.icon}}</view>
            </block>
          </view>
        </view>
        <view class="c-right">
          <text class="c-dist">{{item.dist}}</text><text class="c-unit">KM</text>
        </view>
      </view>
    </block>
  </view>

  <!-- æ–°å¢ï¼šç®¡ç†å‘˜æ·»åŠ æŒ‰é’® (ä»…ç®¡ç†å‘˜ä¸”è¯¦æƒ…æœªæ‰“å¼€æ—¶æ˜¾ç¤º) -->
  <view class="fab-add" wx:if="{{isAdmin && !isDetailOpen}}" catchtap="onAddShop">+</view>

  <!-- 2. æ›¿èº«å±‚ -->
  <view class="phantom {{isExpanded ? 'expanded' : ''}}" style="{{phantomStyle}}" wx:if="{{showPhantom}}">
    
    <!-- åˆ—è¡¨æ€å†…å®¹ -->
    <view class="p-list-content">
      <view class="c-left">
        <view class="c-name" style="color:#000;">{{activeItem.name}}</view>
        <view class="c-services-row">
           <block wx:for="{{allServices}}" wx:for-item="srv" wx:key="name">
              <view class="cs-icon has" wx:if="{{activeItem.serviceSet[srv.name]}}">{{srv.icon}}</view>
            </block>
        </view>
      </view>
      <view class="c-right">
        <text class="c-dist" style="color:#000;">{{activeItem.dist}}</text><text class="c-unit" style="color:#000;">KM</text>
      </view>
    </view>

    <!-- å›¾ç‰‡åŒºåŸŸ (ç®¡ç†å‘˜æ¨¡å¼ä¸‹ç‚¹å‡»å¯æ¢å›¾ï¼Œç¼–è¾‘æ¨¡å¼ä¸‹ä¹Ÿå¯æ¢å›¾) -->
    <view class="p-image-box" catchtap="{{(isAdmin || isEditing) ? 'chooseImage' : ''}}">
      <!-- ç¼–è¾‘æ¨¡å¼ï¼šä¼˜å…ˆæ˜¾ç¤º editData.imgï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤º activeItem.img -->
      <image 
        wx:if="{{isEditing && (editData.img || activeItem.img)}}" 
        src="{{editData.img || activeItem.img}}" 
        mode="aspectFill" 
        class="p-img"
      ></image>
      <!-- ç¼–è¾‘æ¨¡å¼ä½†æ²¡æœ‰å›¾ç‰‡ï¼šæ˜¾ç¤ºå ä½å›¾ -->
      <view wx:elif="{{isEditing}}" class="p-img img-placeholder">
        <text class="placeholder-text">ç‚¹å‡»æ·»åŠ å›¾ç‰‡</text>
      </view>
      <!-- æµè§ˆæ¨¡å¼ï¼šæ˜¾ç¤º activeItem.img -->
      <image 
        wx:else 
        src="{{activeItem.img || ''}}" 
        mode="aspectFill" 
        class="p-img"
      ></image>
      <!-- ç®¡ç†å‘˜æ¨¡å¼æˆ–ç¼–è¾‘æ¨¡å¼ä¸‹çš„æ¢å›¾æç¤º -->
      <view class="img-edit-hint" wx:if="{{isAdmin || isEditing}}">ç‚¹å‡»æ›´æ¢å›¾ç‰‡</view>
    </view>
    
    <!-- æŒ‰é’®ç»„ï¼ˆå³ä¸Šè§’ï¼‰ -->
    <view class="p-btn-group">
      <!-- æµè§ˆæ¨¡å¼ï¼šç®¡ç†å‘˜æ˜¾ç¤ºç¼–è¾‘æŒ‰é’®ï¼Œæ™®é€šç”¨æˆ·æ˜¾ç¤ºå…³é—­æŒ‰é’® -->
      <view class="circle-btn edit-btn" wx:if="{{isAdmin && !isEditing && !isAdding}}" catchtap="toggleEdit">âœ</view>
      <!-- æ·»åŠ æ–°å¡ç‰‡æ—¶ï¼šæ˜¾ç¤ºå–æ¶ˆæŒ‰é’® -->
      <view class="circle-btn cancel-btn" wx:if="{{isAdding}}" catchtap="cancelAddShop">âœ•</view>
      <!-- ç¼–è¾‘å·²æœ‰å¡ç‰‡æ—¶ï¼šæ˜¾ç¤ºä¿å­˜æŒ‰é’® -->
      <view class="circle-btn save-btn-small" wx:if="{{isEditing && !isAdding}}" catchtap="saveEdit">âœ“</view>
      <!-- æµè§ˆæ¨¡å¼ï¼ˆéç®¡ç†å‘˜ï¼‰ï¼šæ˜¾ç¤ºå…³é—­æŒ‰é’® -->
      <view class="circle-btn" wx:if="{{!isEditing && !isAdmin && !isAdding}}" catchtap="closeDetail">âœ•</view>
    </view>
    
    <!-- è¯¦æƒ…é¡µé¢å·¦ä¸Šè§’å®ŒæˆæŒ‰é’®ï¼ˆä»…ç®¡ç†å‘˜æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰ -->
    <view class="complete-btn" wx:if="{{isAdmin && !isEditing && !isAdding}}" catchtap="closeDetail">
      <text>å®Œæˆ</text>
    </view>
    
    <!-- è¯¦æƒ…å†…å®¹æ»šåŠ¨åŒº -->
    <view class="p-content">
      
      <!-- A. æµè§ˆæ¨¡å¼ -->
      <view class="view-mode" wx:if="{{!isEditing}}">
        <view class="title-row">
          <view class="d-title">{{activeItem.name}}</view>
          <view class="d-dist-badge">{{activeItem.dist}} KM</view>
        </view>

        <view class="d-sub-row">
          <view class="status-pill" style="background:{{activeItem.isOpen ? '#00C853' : '#FF3B30'}}20; color:{{activeItem.isOpen ? '#00C853' : '#FF3B30'}}">
            <view class="status-dot" style="background:{{activeItem.isOpen ? '#00C853' : '#FF3B30'}}"></view>{{activeItem.isOpen ? 'è¥ä¸šä¸­' : 'æœªè¥ä¸š'}}
          </view>
          <view class="sub-text">{{activeItem.sub}}</view>
        </view>

        <!-- æœåŠ¡æ ‡ç­¾ -->
        <view class="tag-cloud">
          <block wx:for="{{activeItem.services}}" wx:key="*this">
             <view class="srv-tag">
               <text class="srv-tag-icon" wx:if="{{item === 'è½¦è¾†å¿«ä¿®'}}">ğŸ”§</text>
               <text class="srv-tag-icon" wx:elif="{{item === 'è½¦è¾†ä¿å…»'}}">âš™ï¸</text>
               <text class="srv-tag-icon" wx:elif="{{item === 'è½¦è¾†é”€å”®'}}">ğŸï¸</text>
               <text class="srv-tag-icon" wx:elif="{{item === 'æœºè½¦å’–å•¡'}}">â˜•</text>
               <text class="srv-tag-icon" wx:elif="{{item === 'è½¦è¾†ç²¾ä¿®'}}">ğŸ› ï¸</text>
               <text class="srv-tag-icon" wx:elif="{{item === 'æ´—è½¦æœåŠ¡'}}">ğŸš¿</text>
               <text class="srv-tag-icon" wx:elif="{{item === 'æœºæ²¹æ›´æ¢'}}">ğŸ›¢ï¸</text>
               <text class="srv-tag-icon" wx:else>â€¢</text>
               {{item}}
             </view>
          </block>
          <view wx:if="{{!activeItem.services.length}}" style="color:#ccc; font-size:24rpx;">æš‚æ— æœåŠ¡æ ‡ç­¾</view>
        </view>

        <!-- ä¿¡æ¯å— -->
        <view class="info-block">
          <view class="ib-row" bindtap="openLocation">
            <view class="ib-icon">ğŸ“</view>
            <view class="ib-content">
              <text class="ib-label">ADDRESS</text>
              <view class="ib-val">{{activeItem.address}}</view>
            </view>
          </view>
          <view class="ib-row">
            <view class="ib-icon">â°</view>
            <view class="ib-content">
              <text class="ib-label">HOURS</text>
              <view class="ib-val">{{activeItem.time}}</view>
            </view>
          </view>
          <view class="ib-row" bindtap="makeCall">
            <view class="ib-icon">ğŸ“</view>
            <view class="ib-content">
              <text class="ib-label">PHONE</text>
              <view class="ib-val">{{activeItem.phone}}</view>
            </view>
          </view>
        </view>

        <view class="d-footer">
          <view class="btn-nav" bindtap="openLocation"><span>â¤</span> å¯¼èˆªå‰å¾€</view>
          <view class="btn-call" bindtap="makeCall">ğŸ“</view>
        </view>
        
        <!-- ç®¡ç†å‘˜åˆ é™¤æŒ‰é’® -->
        <view class="del-btn" wx:if="{{isAdmin}}" bindtap="deleteShop">åˆ é™¤æ­¤å¡ç‰‡</view>
      </view>

      <!-- B. ç¼–è¾‘æ¨¡å¼ -->
      <view class="edit-form" wx:else>
        <view class="edit-title">ç¼–è¾‘ä¿¡æ¯</view>
        
        <!-- ä¸Šä¼ ç…§ç‰‡æŒ‰é’®ï¼ˆåªåœ¨æ–°å»ºå¡ç‰‡æ—¶æ˜¾ç¤ºï¼‰ -->
        <view class="upload-img-btn edit-upload-btn" wx:if="{{isAdding}}" catchtap="chooseImage">
          <text>ğŸ“·</text>
          <text>ä¸Šä¼ ç…§ç‰‡</text>
        </view>
        
        <view class="inp-group">
           <view class="inp-label">åº—é“ºåç§°</view>
           <input class="inp-field" value="{{editData.name}}" data-field="name" bindinput="onEditInput"/>
        </view>
        
        <!-- åœ°å€é€‰æ‹©å™¨ (ä¿®æ”¹ä¸ºå±…ä¸­å¸ƒå±€) -->
        <view class="inp-group" bindtap="chooseLocation">
           <view class="inp-label">åº—é“ºåœ°å€</view>
           <!-- æ³¨æ„è¿™é‡Œå»æ‰äº† justify-content: space-between çš„æ ·å¼ï¼Œæ”¹ä¸º CSS æ§åˆ¶å±…ä¸­ -->
           <view class="inp-field pick-field {{editData.address?'':'placeholder'}}">
             <text>ğŸ“</text> <!-- å›¾æ ‡æ”¾å‰é¢æˆ–ä¸­é—´ -->
             <text>{{editData.address || 'ç‚¹å‡»é€‰æ‹©åœ°å›¾ä½ç½®'}}</text>
           </view>
        </view>

        <view class="inp-group">
           <view class="inp-label">å‰¯æ ‡é¢˜</view>
           <input class="inp-field" value="{{editData.sub}}" data-field="sub" bindinput="onEditInput"/>
        </view>
        
        <view class="inp-group">
           <view class="inp-label">è¥ä¸šæ—¶é—´</view>
           <view class="time-picker-row">
             <!-- å¼€å§‹æ—¶é—´ picker -->
             <picker mode="time" value="{{editData.startTime}}" bindchange="onStartTimeChange">
               <!-- è¿™é‡Œçš„æ˜¾ç¤ºå¿…é¡»ç»‘å®š editData.startTime -->
               <view class="time-box">{{editData.startTime || '09:00'}}</view>
             </picker>
             
             <text class="time-split">-</text>
             
             <!-- ç»“æŸæ—¶é—´ picker -->
             <picker mode="time" value="{{editData.endTime}}" bindchange="onEndTimeChange">
               <!-- è¿™é‡Œçš„æ˜¾ç¤ºå¿…é¡»ç»‘å®š editData.endTime -->
               <view class="time-box">{{editData.endTime || '18:00'}}</view>
             </picker>
           </view>
        </view>
        
        <view class="inp-group">
           <view class="inp-label">è”ç³»ç”µè¯</view>
           <input class="inp-field" value="{{editData.phone}}" data-field="phone" bindinput="onEditInput"/>
        </view>

        <!-- åŸæ¥çš„è¾“å…¥æ¡†åˆ æ‰ï¼Œæ¢æˆè¿™ä¸ªç‚¹é€‰åŒºåŸŸ -->
        <view class="inp-group">
           <view class="inp-label">æœåŠ¡å†…å®¹ (ç‚¹å‡»é€‰æ‹©)</view>
           <view class="select-tag-grid">
             <block wx:for="{{allServices}}" wx:key="name">
               <!-- åˆ¤æ–­å½“å‰æœåŠ¡æ˜¯å¦åœ¨ç¼–è¾‘æ•°æ®çš„é€‰ä¸­åˆ—è¡¨ä¸­ -->
               <view 
                 class="select-tag {{tools.includes(editData.selectedServices, item.name) ? 'active' : ''}}" 
                 catchtap="toggleService" 
                 data-name="{{item.name}}">
                 <text>{{item.icon}}</text> {{item.name}}
               </view>
             </block>
           </view>
        </view>
        
        <!-- æ·»åŠ æ–°å¡ç‰‡æ—¶æ˜¾ç¤º"æ–°å»º"ï¼Œç¼–è¾‘å·²æœ‰å¡ç‰‡æ—¶æ˜¾ç¤º"ä¿å­˜æ›´æ”¹" -->
        <view class="btn-nav save-btn" bindtap="saveEdit">
          {{isAdding ? 'æ–°å»º' : 'ä¿å­˜æ›´æ”¹'}}
        </view>
      </view>

    </view> <!-- ç»“æŸ view -->
  </view>

</view> <!-- å®¹å™¨ç»“æŸ -->

<!-- ================= è‡ªåŠ¨æ¶ˆå¤±æç¤ºï¼ˆæ— æŒ‰é’®ï¼Œ2ç§’åè‡ªåŠ¨æ¶ˆå¤±ï¼‰ ================= -->
<view class="auto-toast-mask" wx:if="{{autoToast.show}}" catchtouchmove="noop">
  <view class="auto-toast-box">
    <view class="at-title">{{autoToast.title}}</view>
    <view class="at-content">{{autoToast.content}}</view>
  </view>
</view>

<!-- ================= è‡ªå®šä¹‰å¯¹è¯æ¡† ================= -->
<view class="custom-dialog-mask" wx:if="{{dialog.show}}" bindtap="closeCustomDialog" catchtouchmove="noop">
  <view class="custom-dialog-box" catchtap="">
    <view class="cd-title">{{dialog.title}}</view>
    <view class="cd-content">{{dialog.content}}</view>
    <view class="cd-btn-row">
      <view class="cd-btn cancel" wx:if="{{dialog.showCancel}}" bindtap="closeCustomDialog">{{dialog.cancelText}}</view>
      <view class="cd-btn confirm" bindtap="onDialogConfirm">{{dialog.confirmText}}</view>
    </view>
  </view>
</view>

<!-- å…¨å±€è‡ªå®šä¹‰å¼¹çª—ç»„ä»¶ -->
<custom-toast id="custom-toast" />
