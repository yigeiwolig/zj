<!-- 顶部导航 -->
<view class="header">
  <view class="back-icon" catchtap="goBack">
    <text style="font-size: 48rpx; font-weight: 300; color: #fff; line-height: 1;">‹</text>
  </view>
</view>

<canvas type="2d" id="particleCanvas" class="particle-canvas"></canvas>

<view class="dynamic-island {{islandState}}">
  <view class="island-content">
    <text class="island-icon {{connectSuccess ? 'text-black' : 'text-red'}}">{{connectSuccess ? '✓' : '⚠'}}</text>
    <text class="{{connectSuccess ? 'text-black' : 'text-red'}}">{{islandText}}</text>
  </view>
</view>

<view class="loader-wrapper {{loaderFading ? 'fade-out' : ''}}" bindtap="handleConnect" wx:if="{{!showStage}}">
  <view class="container-loader">
    <view class="aro" style="--s: 0"></view><view class="aro" style="--s: 1"></view><view class="aro" style="--s: 2"></view><view class="aro" style="--s: 3"></view><view class="aro" style="--s: 4"></view><view class="aro" style="--s: 5"></view><view class="aro" style="--s: 6"></view><view class="aro" style="--s: 7"></view><view class="aro" style="--s: 8"></view><view class="aro" style="--s: 9"></view><view class="aro" style="--s: 10"></view><view class="aro" style="--s: 11"></view><view class="aro" style="--s: 12"></view><view class="aro" style="--s: 13"></view><view class="aro" style="--s: 14"></view>
  </view>
</view>

<view class="stage-layer {{showStage ? 'active' : ''}}">
  
  <view class="selector-center {{isInjecting ? 'fade-out' : ''}}" wx:if="{{!exploded}}">
    <view class="carousel">
      <view class="arrow left" bindtap="prevDevice">‹</view>
      <view class="device-selector-content">
        <image src="{{currentSvg}}" class="device-icon-preview force-white" mode="aspectFit" bindtap="startInject"></image>
        <view class="device-name" bindtap="startInject">{{devices[currentDevIdx]}}</view>
      </view>
      <view class="arrow right" bindtap="nextDevice">›</view>
    </view>
  </view>

  <view class="reveal-box {{isInjecting ? 'shaking' : ''}}" wx:if="{{isInjecting && !exploded}}">
    <view class="reveal-mask" style="height: {{revealProgress}}%">
      <image src="{{currentSvg}}" class="device-svg force-white" mode="aspectFit"></image>
    </view>
  </view>

  <!-- 成功界面 -->
  <view class="mt-end {{showEnd ? 'active' : ''}}">MT</view>
  <view class="success-text {{showEnd ? 'active' : ''}}">升级成功</view>
  <view class="finish-btn-wrapper {{showFinishBtn ? 'active' : ''}}" bindtap="restart">
    <view class="finish-btn"><text>完成退出</text></view>
  </view>

  <!-- 失败界面 -->
  <view class="fail-wrapper {{showFail ? 'active' : ''}}">
    <view class="fail-title">升级失败</view>
    <view class="fail-desc">蓝牙已断开，请保持连接</view>
    <view class="finish-btn" bindtap="restart"><text>重新尝试</text></view>
  </view>

</view>
<!-- 全局自定义弹窗组件 -->
<custom-toast id="custom-toast" />
