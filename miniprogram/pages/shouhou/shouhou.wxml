<view class="container">

  <!-- ================== 首页 (iOS 风格) ================== -->
  <view class="home-view {{inDetail ? 'shrink' : ''}}">
    <!-- 顶部导航 -->
    <view class="nav-header">
      <!-- 左上角返回键 -->
      <view class="nav-back-btn" bindtap="goBack">
        <text class="back-icon">‹</text>
      </view>
      <!-- 中间标题区域 -->
      <view class="header-title-row">
        <view class="large-title" bindtap="triggerAdmin">
          MT
          <text wx:if="{{isAdmin}}" class="admin-badge">ADMIN</text>
        </view>
        <view class="subtitle">请选择你的设备</view>
      </view>
      <!-- 右侧占位 -->
      <view class="nav-right-placeholder"></view>
    </view>
    
    <!-- 管理员功能区域（独立区域） -->
    <view wx:if="{{isAdmin}}" class="admin-actions-container">
      <!-- 退出管理员按钮 -->
      <view class="exit-admin-btn" bindtap="exitAdmin">
        <text class="exit-icon">退出管理员</text>
      </view>
      <!-- 同步配件按钮 -->
      <view class="sync-parts-btn" bindtap="syncAllPartsToCloud">
        <text class="sync-icon">🔄</text>
        <text class="sync-text">同步配件数据</text>
      </view>
    </view>

    <!-- F1 系列 -->
    <view class="section-title">F1 SERIES</view>
    <view class="card-grid">
      <!-- F1 PRO (白) -->
      <view class="i-card style-white" bindtap="enterModel" data-name="F1 PRO" data-series="F1">
        <view class="card-top"><text class="badge">标准版</text></view>
        <view class="card-btm">
          <view class="p-name">F1 PRO</view>
          <view class="p-desc">标准版</view>
        </view>
        <view class="circle-decor"></view>
      </view>
      <!-- F1 MAX (黑) -->
      <view class="i-card style-black" bindtap="enterModel" data-name="F1 MAX" data-series="F1">
        <view class="card-top"><text class="badge">高级版</text></view>
        <view class="card-btm">
          <view class="p-name">F1 MAX</view>
          <view class="p-desc">高级版</view>
        </view>
        <view class="circle-decor"></view>
      </view>
    </view>

    <!-- F2 系列 -->
    <view class="section-title">F2 SERIES</view>
    <view class="card-grid">
      <view class="i-card style-white" bindtap="enterModel" data-name="F2 PRO" data-series="F2">
        <view class="card-top"><text class="badge">普通版</text></view>
        <view class="card-btm">
          <view class="p-name">F2 PRO</view>
          <view class="p-desc">普通版</view>
        </view>
        <view class="circle-decor"></view>
      </view>
      <view class="i-card style-black" bindtap="enterModel" data-name="F2 MAX" data-series="F2">
        <view class="card-top"><text class="badge">进阶版</text></view>
        <view class="card-btm">
          <view class="p-name">F2 MAX</view>
          <view class="p-desc">进阶版</view>
        </view>
        <view class="circle-decor"></view>
      </view>
    </view>

    <!-- F2 Long 系列 -->
    <view class="section-title">F2 LONG SERIES</view>
    <view class="card-grid" style="padding-bottom: 50px;">
      <view class="i-card style-white" bindtap="enterModel" data-name="F2 PRO Long" data-series="F2">
        <view class="card-top"><text class="badge">加长版</text></view>
        <view class="card-btm">
          <view class="p-name">F2 PRO Long</view>
          <view class="p-desc">加长普通</view>
        </view>
        <view class="circle-decor"></view>
      </view>
      <view class="i-card style-black" bindtap="enterModel" data-name="F2 MAX Long" data-series="F2">
        <view class="card-top"><text class="badge">性能版</text></view>
        <view class="card-btm">
          <view class="p-name">F2 MAX Long</view>
          <view class="p-desc">加长高级</view>
        </view>
        <view class="circle-decor"></view>
      </view>
    </view>
  </view>

  <!-- ================== 二级页面 (侧滑详情) ================== -->
  <view class="detail-view {{inDetail ? 'slide-in' : ''}}" style="padding-top: {{statusBarHeight}}px;">
    <!-- 导航栏 -->
    <view class="detail-nav">
      <view class="nav-back-btn" bindtap="exitModel">
        <text class="back-icon">‹</text>
      </view>
      <view class="nav-title">{{currentModelName}}</view>
      <view style="width: 40px;"></view>
    </view>

    <view class="content-scroll">
      <!-- 顶部 Tab -->
      <view class="tab-group">
        <view class="tab-item {{activeTab==='order'?'active':''}}" bindtap="switchTab" data-mode="order">维修工单</view>
        <view class="tab-item {{activeTab==='tutorial'?'active':''}}" bindtap="switchTab" data-mode="tutorial">维修教程</view>
      </view>

      <!-- TAB 1: 维修工单 -->
      <view wx:if="{{activeTab === 'order'}}">
        
        <!-- 服务类型切换 -->
        <view class="svc-switch">
          <view class="svc-item {{serviceType==='parts'?'selected':''}}" bindtap="toggleService" data-type="parts">购买配件</view>
          <view class="svc-item {{serviceType==='repair'?'selected':''}}" bindtap="toggleService" data-type="repair">故障报修</view>
        </view>

        <!-- A. 配件选择区 (Tag网格样式) -->
        <view wx:if="{{serviceType === 'parts'}}">
          <view class="section-label">配件清单</view>
          <view class="parts-container">
            <block wx:for="{{currentPartsList}}" wx:key="index">
              <view class="part-tag {{item.selected ? 'active' : ''}}" bindtap="togglePart" data-index="{{index}}">
                {{item.name}}
                <!-- 管理员删除按钮 -->
                <view wx:if="{{isAdmin}}" class="del-btn" catchtap="deletePart" data-index="{{index}}">✕</view>
              </view>
            </block>
            <!-- 管理员添加按钮 -->
            <view wx:if="{{isAdmin}}" class="add-btn-dashed" bindtap="openModal" data-mode="part">+ 添加配件</view>
          </view>
        </view>

        <!-- B. 故障报修区 -->
        <view wx:if="{{serviceType === 'repair'}}">
          <view class="section-label">故障描述</view>
          <textarea 
            class="input-area" 
            placeholder="请详细描述故障现象..." 
            style="height: 100px;"
            value="{{repairDescription}}"
            bindinput="handleRepairInput"
          ></textarea>
          
          <view class="upload-box" bindtap="chooseVideo">
            <view style="font-size:24px;">📹</view>
            <view class="upload-text">{{videoFileName || '点击上传故障视频'}}</view>
          </view>
        </view>

        <!-- C. 联系信息 (公共，带折叠动画) -->
        <view class="contact-section">
          <!-- 标题栏：点击触发折叠/展开 -->
          <view class="contact-header" bindtap="toggleContact">
            <view class="header-left">
              <text class="section-label">联系信息</text>
              <!-- 旋转箭头 -->
              <view class="arrow {{isContactExpanded ? 'up' : ''}}"></view>
            </view>
            <!-- 智能粘贴按钮 (阻止冒泡，避免触发折叠) -->
            <view class="smart-paste" catchtap="smartPaste">智能粘贴识别</view>
          </view>

          <!-- 内容区域：带有展开动画 -->
          <view class="contact-body {{isContactExpanded ? 'expanded' : ''}}">
            <view class="input-wrapper">
              <input 
                class="input-field" 
                placeholder="姓名" 
                value="{{contactName}}" 
                data-field="contactName"
                bindinput="handleContactInput"
                placeholder-class="ph-style" 
              />
              <input 
                class="input-field" 
                type="number" 
                placeholder="手机号码" 
                value="{{contactPhone}}" 
                data-field="contactPhone"
                bindinput="handleContactInput"
                placeholder-class="ph-style" 
              />
              <input 
                class="input-field" 
                placeholder="详细收货地址" 
                value="{{contactAddr}}" 
                data-field="contactAddr"
                bindinput="handleContactInput"
                placeholder-class="ph-style" 
              />
              <input 
                class="input-field" 
                placeholder="微信昵称" 
                value="{{contactWechat}}" 
                data-field="contactWechat"
                bindinput="handleContactInput"
                placeholder-class="ph-style" 
              />
            </view>
          </view>
        </view>

        <view style="height: 100px;"></view> <!-- 底部垫高 -->
      </view>

      <!-- TAB 2: 维修教程 -->
      <view wx:if="{{activeTab === 'tutorial'}}">
        
        <!-- 锁屏界面：整块可点，点击后强制聚焦隐藏输入框 -->
        <view wx:if="{{isLocked}}" class="lock-screen" bindtap="focusInput">
          <view style="font-size:40px; margin-bottom:20px;">🔒</view>
          <view style="font-weight:700; font-size:18px;">访客验证</view>
          <view style="color:#999; font-size:14px; margin-top:10px;">请输入对应型号密码</view>
          
          <view class="dots-row">
            <block wx:for="{{[0,1,2,3,4,5]}}" wx:key="*this">
              <view class="dot {{passInput.length > item ? 'filled' : ''}}"></view>
            </block>
          </view>

          <view wx:if="{{passError}}" style="color:red; font-size:14px; margin-top:20px;">密码错误</view>

          <!-- 覆盖在锁屏区域的隐形输入框（通过 focusPass 控制聚焦） -->
          <input class="hidden-input"
                 type="number"
                 maxlength="6"
                 bindinput="onPassInput"
                 value="{{passInput}}"
                 focus="{{focusPass}}" />
        </view>

        <!-- 视频列表 (修复播放功能) -->
        <view wx:else>

          <!-- 管理员入口按钮 -->
          <view wx:if="{{isAdmin}}" class="admin-add-area" bindtap="openModal" data-mode="video">
            <view class="plus-icon">+</view>
            <text>上传新教程视频</text>
          </view>

          <view class="section-label">{{currentModelName}} 维修教程库</view>
          
          <view class="video-list-container">
            <block wx:for="{{currentVideoList}}" wx:key="index">
              <view 
                class="video-card {{isAdmin && isDragging && dragIndex === index ? 'dragging' : ''}}"
                style="{{isAdmin && isDragging && dragIndex === index ? 'transform: translateY(' + dragOffsetY + 'px) scale(1.02);' : ''}}"
                bindtouchstart="{{isAdmin ? 'onDragStart' : ''}}"
                catchtouchmove="{{isAdmin ? 'onDragMove' : ''}}"
                bindtouchend="{{isAdmin ? 'onDragEnd' : ''}}"
                bindlongpress="{{isAdmin ? 'onLongPress' : ''}}"
                data-index="{{index}}"
              >

                <!-- 情况A：正在播放 (显示 Video 组件) -->
                <view wx:if="{{playingIndex === index}}" class="video-player-box">
                  <video 
                    src="{{item.src}}" 
                    autoplay="false" 
                    controls="true"
                    show-center-play-btn="true" 
                    object-fit="contain"
                    class="real-video"
                  ></video>
                </view>

                <!-- 情况B：未播放 (显示封面) -->
                <view wx:else class="video-cover" bindtap="playVideo" data-index="{{index}}">
                  <!-- 优先显示上传的封面(thumb)，没有则显示模拟色块 -->
                  <image wx:if="{{item.thumb}}" src="{{item.thumb}}" mode="aspectFill" class="cover-img"></image>
                  <view wx:else class="video-placeholder" style="background: {{item.coverColor || '#1c1c1e'}};">
                    <view class="play-btn-overlay">▶</view>
                  </view>
                  <!-- 如果有thumb，也显示播放按钮 -->
                  <view wx:if="{{item.thumb}}" class="play-btn-center">▶</view>
                </view>
                
                <!-- 下方：文字信息区 -->
                <view class="video-info">
                  <view class="video-title">{{item.title}}</view>
                  <view class="video-meta">
                    <!-- 隐藏"刚刚更新"这类更新时间，只展示正常时长 -->
                    <block wx:if="{{item.time && item.time !== '刚刚更新'}}">
                      <text class="time-badge">{{item.time}}</text>
                    </block>
                    <text class="status-text">点击播放</text>
                    <!-- 管理员模式下的视频管理操作 -->
                    <view wx:if="{{isAdmin}}" class="video-admin-ops">
                      <text class="video-del" data-index="{{index}}" bindtap="deleteVideo">删除</text>
                    </view>
                  </view>
                </view>
              </view>
            </block>
          </view>
        </view>
      </view>

    </view>

    <!-- 底部提交栏 (仅工单模式显示) -->
    <view class="bottom-dock" wx:if="{{activeTab === 'order'}}">
      <view style="font-size:13px; color:#666;">
        已选 <text style="color:#000; font-weight:bold; font-size:16px;">{{selectedCount}}</text> 件
      </view>
      <button class="submit-btn" bindtap="submitOrder">提交工单</button>
    </view>
  </view>

  <!-- 管理员密码弹窗 -->
  <view class="modal-mask" wx:if="{{showAdminModal}}">
    <view class="admin-password-modal">
      <view class="modal-header">
        <text class="modal-title">管理员验证</text>
        <view class="close-btn" bindtap="cancelAdminPassword">✕</view>
      </view>
      <view class="password-input-wrapper">
        <input 
          class="password-input" 
          type="number" 
          placeholder="请输入管理员密码" 
          value="{{adminPasswordInput}}"
          bindinput="onAdminPasswordInput"
          maxlength="10"
          focus="{{showAdminModal}}"
        />
      </view>
      <view class="modal-buttons">
        <button class="modal-btn cancel-btn" bindtap="cancelAdminPassword">取消</button>
        <button class="modal-btn confirm-btn" bindtap="confirmAdminPassword">确认</button>
      </view>
    </view>
  </view>

  <!-- 管理员弹窗 (增加预览) -->
  <view class="modal-mask" wx:if="{{showModal}}">
    <view class="modal-box">
      <view class="modal-header">
        <text class="modal-title">{{modalMode === 'part' ? '添加新配件' : '发布新教程'}}</text>
      </view>
      
      <!-- 输入名称 -->
      <view class="input-label">名称/标题</view>
      <input class="modal-input" placeholder="{{modalMode === 'part' ? '输入配件名称' : '例如：更换主板教程'}}" model:value="{{modalInputVal}}" />
      
      <!-- 视频上传预览区 -->
      <block wx:if="{{modalMode === 'video'}}">
        <view class="input-label">视频文件</view>
        
        <!-- 如果已选，显示预览（有封面就用封面，没有就用占位提示） -->
        <view wx:if="{{tempVideoThumb || tempVideoPath}}" class="upload-preview" bindtap="adminChooseVideo">
          <block wx:if="{{tempVideoThumb}}">
            <image src="{{tempVideoThumb}}" mode="aspectFill" class="preview-img"></image>
          </block>
          <block wx:else>
            <view class="preview-placeholder">已选择视频</view>
          </block>
          <view class="re-upload-tip">点击更换</view>
        </view>

        <!-- 如果未选，显示按钮 -->
        <view wx:else class="file-upload-btn" bindtap="adminChooseVideo">
          <text>＋ 点击选择视频文件</text>
        </view>
      </block>

      <view class="modal-btns">
        <view class="modal-btn cancel" bindtap="closeModal">取消</view>
        <view class="modal-btn confirm" bindtap="confirmModal">确认发布</view>
      </view>
    </view>
  </view>

  <!-- 隐藏的视频组件，用于提取第一帧 -->
  <video 
    wx:if="{{tempVideoPath && !tempVideoThumb && extractingThumb}}"
    id="thumbVideo"
    src="{{tempVideoPath}}"
    style="position: fixed; top: -9999px; left: -9999px; width: 400px; height: 300px; opacity: 0;"
    bindloadedmetadata="onVideoMetadataLoaded"
    bindtimeupdate="onVideoTimeUpdate"
  ></video>

</view>
