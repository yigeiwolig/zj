# payCallback 云函数 HTTP 触发配置说明

## 一、配置 HTTP 触发（重要）

`payCallback` 云函数需要配置 **HTTP 触发**，才能接收微信支付的回调通知。

### 方法1：在云开发控制台配置（推荐）

1. **登录微信云开发控制台**
   - 打开 [https://console.cloud.tencent.com/](https://console.cloud.tencent.com/)
   - 或者在小程序开发者工具中：**云开发** → **云函数** → **payCallback**

2. **开启 HTTP 触发**
   - 找到 `payCallback` 云函数
   - 点击函数名称进入详情页
   - 点击 **"HTTP 触发"** 或 **"触发器"** 标签
   - 点击 **"添加触发器"** 或 **"开启 HTTP 触发"**
   - 选择 **"HTTP 触发"** 类型

3. **获取 HTTP 触发地址**
   - 开启后，系统会生成一个 HTTP 地址
   - 格式通常为：`https://你的环境ID.ap-shanghai.app.tcloudbase.com/payCallback`
   - 或者：`https://你的环境ID.run.weapp.work/payCallback`
   - 复制这个地址

4. **更新 createOrder 中的回调地址**
   - 打开 `cloudfunctions/createOrder/index.js`
   - 找到 `notify_url` 配置（第 119 行）
   - 将地址更新为你刚复制的 HTTP 触发地址

### 方法2：使用云开发 CLI 配置

如果你使用云开发 CLI，可以在 `config.json` 中添加 HTTP 触发配置：

```json
{
  "permissions": {
    "openapi": []
  },
  "triggers": [
    {
      "name": "payCallback",
      "type": "timer",
      "config": "0 */1 * * * * *"
    }
  ]
}
```

**注意**：对于 HTTP 触发，建议使用控制台配置，因为需要自动生成 HTTPS 地址。

## 二、验证 HTTP 触发地址

配置完成后，可以通过以下方式验证：

### 1. 使用 curl 测试

```bash
curl -X POST https://你的环境ID.ap-shanghai.app.tcloudbase.com/payCallback \
  -H "Content-Type: application/json" \
  -d '{"test": "hello"}'
```

### 2. 查看云函数日志

- 在云开发控制台 → **云函数** → **payCallback** → **日志**
- 查看是否有请求记录

### 3. 检查 createOrder 中的配置

确保 `createOrder/index.js` 中的 `notify_url` 与 HTTP 触发地址一致：

```javascript
notify_url: `https://你的环境ID.ap-shanghai.app.tcloudbase.com/payCallback`,
```

## 三、注意事项

1. **HTTPS 要求**
   - 微信支付回调地址必须是 HTTPS
   - 云开发的 HTTP 触发地址默认是 HTTPS

2. **地址格式**
   - 确保地址末尾没有斜杠 `/`
   - 例如：`https://xxx.com/payCallback` ✅
   - 而不是：`https://xxx.com/payCallback/` ❌

3. **白名单设置（如需要）**
   - 微信支付回调的 IP 地址可能需要添加到白名单
   - 微信支付回调 IP 地址段：`203.205.219.*` 和 `203.205.220.*`

4. **部署云函数**
   - 配置 HTTP 触发后，需要重新部署 `payCallback` 云函数
   - 在微信开发者工具中：右键 `cloudfunctions/payCallback` → **上传并部署：云端安装依赖**

## 四、当前配置

根据 `createOrder/index.js`，当前的回调地址是：
```
https://cloudbase-4gn1heip7c38ec6c.ap-shanghai.app.tcloudbase.com/payCallback
```

请确保：
1. ✅ 这个地址与云开发控制台中的 HTTP 触发地址一致
2. ✅ `payCallback` 云函数已经开启 HTTP 触发
3. ✅ 云函数已经重新部署

## 五、故障排查

如果支付回调没有被触发，检查以下内容：

1. **检查 HTTP 触发是否已开启**
   - 登录云开发控制台
   - 查看 `payCallback` 云函数的触发器列表
   - 确认有 HTTP 触发配置

2. **检查回调地址是否正确**
   - 对比 `createOrder` 中的 `notify_url` 和云开发控制台中的 HTTP 触发地址
   - 确保完全一致（包括协议、域名、路径）

3. **查看云函数日志**
   - 查看 `payCallback` 云函数的调用日志
   - 看是否有微信支付的回调请求

4. **检查微信支付商户平台配置**
   - 登录微信支付商户平台
   - 查看支付回调地址配置（如果有）

5. **测试 HTTP 触发**
   - 使用 curl 或 Postman 测试 HTTP 触发地址
   - 确认可以正常访问
