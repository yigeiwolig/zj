# 安装教程分享码功能需求文档

## 一、功能概述
为已确认收货并获得安装教程查看权限的用户，提供生成分享码功能，允许其他用户通过分享码临时查看安装教程。

---

## 二、功能入口

### 2.1 显示条件
- ✅ 用户已确认收货（订单状态为 `SIGNED` 或 `COMPLETED`）
- ✅ 用户已获得安装教程查看权限（通过订单确认收货获得）

### 2.2 UI位置
- **页面**：`miniprogram/pages/my/my.wxml`
- **位置**：订单卡片中，"确认件齐"按钮的**左侧**
- **按钮名称**：`安装教程查看码`
- **显示逻辑**：与"确认件齐"按钮同一行显示，当订单状态为已签收时显示

---

## 三、生成分享码功能

### 3.1 生成规则
1. **点击按钮**：用户点击"安装教程查看码"按钮
2. **生成随机码**：生成一个唯一的随机分享码（建议格式：8-12位字母数字组合）
3. **保存到数据库**：
   - **集合名称**：`chakan`
   - **数据结构**：
     ```javascript
     {
       code: "生成的分享码",           // 唯一标识
       creatorOpenid: "创建者openid",  // 生成者的openid
       creatorOrderId: "订单号",       // 关联的订单号
       createdAt: Date,                // 创建时间
       expiresAt: Date,                // 过期时间（创建时间+10天）
       totalViews: 3,                  // 总查看次数（固定3次）
       usedViews: 0,                   // 已使用次数
       status: "active"                // 状态：active/inactive/expired
     }
     ```
4. **限制规则**：
   - ⚠️ **每个用户只能生成一次分享码**
   - 如果用户已生成过分享码，再次点击时提示："您已生成过分享码，无法重复生成"
   - 检查逻辑：查询 `chakan` 集合中是否存在 `creatorOpenid` 等于当前用户 openid 的记录

### 3.2 生成后的交互
- 显示分享码给用户
- 提供复制功能
- 提示："分享码已生成，可分享给他人使用，共3次查看机会"

---

## 四、通过分享码进入的用户体验

### 4.1 进入方式
- 通过小程序码或链接携带参数进入，例如：`/pages/index/index?shareCode=ABC123XYZ`

### 4.2 权限请求
- **位置权限**：
  - ✅ 进入时自动请求位置权限
  - ⚠️ **不拦截**：即使用户拒绝位置权限，也不阻止访问
  - 仅用于记录，不影响功能使用

### 4.3 查看次数管理和有效期
- **初始次数**：3次
- **有效期**：⏰ **10天后自动失效**
  - 创建分享码时，设置 `expiresAt = createdAt + 10天`
  - 每次验证分享码时，检查当前时间是否超过 `expiresAt`
  - 如果已过期，提示："分享码已过期，无法使用"
  - 禁止访问
- **每次查看提醒**：
  - 进入安装教程页面时，显示Toast提示：
    - "剩余查看次数：X/3"（X为剩余次数）
  - 每次查看后，`usedViews` +1
- **次数用尽**：
  - 当 `usedViews >= totalViews` 时，提示："分享码查看次数已用完"
  - 禁止再次查看

### 4.4 页面访问限制（核心功能）

#### 4.4.1 返回键隐藏
- ⚠️ **通过分享码进入的用户，左上角返回键完全隐藏**
- 实现方式：在安装教程页面（`azjc`）的 `onLoad` 中检查分享码状态
- 如果检测到是分享码用户，隐藏返回键（设置 `display: none` 或通过条件渲染）

#### 4.4.2 主页按钮行为
- **点击主页按钮**：直接跳转到安装教程页面（`/pages/azjc/azjc`）
- **不显示其他页面入口**

#### 4.4.3 页面访问控制
- ✅ **允许访问**：
  - 安装教程页面（`/pages/azjc/azjc`）
  - 必要的系统页面（如授权页面）
  
- ❌ **禁止访问**：
  - 产品选购（`/pages/shop/shop`）
  - 产品上新（`/pages/pagenew/pagenew`）
  - 案例展示（`/pages/case/case`）
  - 排行榜单（`/pages/paihang/paihang`）
  - 控制中心（`/pages/scan/scan`）
  - OTA升级（`/pages/ota/ota`）
  - 维修中心（`/pages/shouhou/shouhou`）
  - 我的信息（`/pages/my/my`）
  - 其他所有功能页面

#### 4.4.4 拦截实现方式
- 在 `app.js` 的 `onLaunch` 和 `onShow` 中检查是否存在 `shareCode` 参数
- 在需要拦截的页面的 `onLoad` 中检查分享码状态
- 如果检测到是通过分享码进入的用户，且尝试访问非安装教程页面：
  - 自动跳转回安装教程页面
  - 显示提示："通过分享码进入的用户只能查看安装教程"

---

## 五、数据库设计

### 5.1 `chakan` 集合结构
```javascript
{
  _id: "自动生成",
  code: "ABC123XYZ",                    // 分享码（唯一索引）
  creatorOpenid: "o6zAJs2KPwFW0_...",   // 创建者openid
  creatorOrderId: "MT1768858656660621", // 关联订单号
  createdAt: Date,                       // 创建时间
  expiresAt: Date,                       // 过期时间（createdAt + 10天）
  totalViews: 3,                         // 总查看次数
  usedViews: 0,                          // 已使用次数
  status: "active",                     // 状态：active/inactive/expired
  viewers: [                            // 查看记录（可选）
    {
      openid: "查看者openid",
      viewTime: Date,
      viewCount: 1
    }
  ]
}
```

### 5.2 索引建议
- `code`: 唯一索引
- `creatorOpenid`: 普通索引（用于检查是否已生成）

---

## 六、技术实现要点

### 6.1 分享码生成
- 使用云函数生成，确保唯一性
- 或使用 `Math.random().toString(36).substring(2, 10).toUpperCase()` 生成8位码

### 6.2 分享码验证
- 在 `app.js` 中检查 URL 参数 `shareCode`
- 查询 `chakan` 集合验证分享码有效性
- 将分享码信息存储到 `globalData` 或本地存储

### 6.3 页面拦截
- 在需要拦截的页面的 `onLoad` 中检查：
  ```javascript
  if (app.globalData.isShareCodeUser) {
    // 如果不是安装教程页面，跳转回去
    if (this.route !== 'pages/azjc/azjc') {
      wx.redirectTo({ url: '/pages/azjc/azjc' });
      return;
    }
  }
  ```

### 6.4 查看次数更新和有效期检查
- 每次进入安装教程页面时：
  1. 检查分享码是否过期（当前时间 > expiresAt）
  2. 如果过期，提示并禁止访问
  3. 检查分享码状态和剩余次数
  4. 更新 `usedViews`
  5. 显示剩余次数提示
  6. 如果次数用尽，禁止访问

### 6.5 返回键隐藏实现
- 在安装教程页面（`/pages/azjc/azjc.wxml`）中：
  ```xml
  <view class="header" wx:if="{{!isShareCodeUser}}">
    <view class="back-icon" catchtap="handleBack">
      <text class="back-arrow">‹</text>
    </view>
  </view>
  ```
- 在 `azjc.js` 的 `onLoad` 中设置：
  ```javascript
  const app = getApp();
  this.setData({
    isShareCodeUser: app.globalData.isShareCodeUser || false
  });
  ```

---

## 七、用户体验流程

### 7.1 生成分享码流程
```
用户确认收货 
  ↓
看到"安装教程查看码"按钮
  ↓
点击按钮
  ↓
检查是否已生成过（查询chakan集合）
  ↓
如果未生成：生成随机码 → 保存到chakan → 显示分享码
如果已生成：提示"已生成过，无法重复生成"
```

### 7.2 使用分享码流程
```
用户通过分享码进入小程序
  ↓
app.js检测到shareCode参数
  ↓
验证分享码有效性（查询chakan集合）
  ↓
检查是否过期（当前时间 > expiresAt）
  ↓
如果过期：提示"分享码已过期" → 禁止访问
如果未过期：继续流程
  ↓
请求位置权限（不拦截）
  ↓
设置全局标识：isShareCodeUser = true
  ↓
跳转到主页（index页面）
  ↓
主页按钮点击 → 直接进入安装教程页面
  ↓
进入安装教程页面
  ↓
隐藏返回键（isShareCodeUser = true）
  ↓
检查剩余次数 → 显示提示 → 更新usedViews
  ↓
如果尝试访问其他页面 → 自动跳回安装教程页面
```

---

## 八、注意事项

1. **安全性**：
   - 分享码应该足够随机，避免被猜测
   - 建议使用云函数生成，确保唯一性

2. **性能**：
   - 分享码验证可以缓存到本地，减少数据库查询

3. **用户体验**：
   - 每次查看都要明确提示剩余次数
   - 次数用尽时给出友好提示

4. **数据清理**：
   - 可以考虑定期清理过期的分享码记录

---

## 九、待确认问题

1. ✅ **分享码有效期**：已确认，10天后失效
2. 分享码是否可以手动失效？（生成者可以主动关闭）
3. 查看记录是否需要详细记录每个查看者的信息？
4. ✅ **返回键隐藏**：已确认，分享码用户左上角返回键完全隐藏

---

## 十、开发优先级

1. **P0（核心功能）**：
   - 生成分享码功能
   - 分享码验证和进入流程
   - 页面访问拦截

2. **P1（重要功能）**：
   - 查看次数管理和提示
   - 位置权限请求（不拦截）

3. **P2（优化功能）**：
   - 分享码管理（失效、查看记录等）
   - 数据清理机制

---

**文档版本**：v1.1  
**创建时间**：2026-01-20  
**最后更新**：2026-01-20  
**更新内容**：
- ✅ 添加分享码10天有效期限制
- ✅ 添加分享码用户返回键隐藏功能
