# 后台配置文档

## 概述

当浙江用户访问小程序时，系统会自动拒绝访问，并将用户信息（IP地址、昵称、位置等）发送到后台。后台需要提供API接口接收这些数据，并提供审核功能。

## 一、后台API接口配置

### 1. 接收被拒绝用户数据的接口

**接口地址：** `POST /api/blocked-users`

**请求头：**
```
Content-Type: application/json
```

**请求体示例：**
```json
{
  "openid": "oXXXXXXXXXXXXX",
  "nickName": "用户昵称",
  "avatarUrl": "https://...",
  "ipAddress": "123.456.789.0",
  "location": {
    "latitude": 30.123456,
    "longitude": 120.123456,
    "accuracy": 30
  },
  "city": "杭州市",
  "province": "浙江省",
  "judgementAt": 1704067200000,
  "requestTime": "2024-01-01T12:00:00.000Z",
  "status": "blocked",
  "needReview": true
}
```

**响应示例：**
```json
{
  "success": true,
  "message": "接收成功",
  "id": "记录ID"
}
```

### 2. 查询被拒绝用户列表接口

**接口地址：** `GET /api/blocked-users`

**查询参数：**
- `page`: 页码（默认1）
- `pageSize`: 每页数量（默认20）
- `status`: 状态筛选（blocked/pending/approved/rejected）
- `city`: 城市筛选
- `startTime`: 开始时间（时间戳）
- `endTime`: 结束时间（时间戳）

**响应示例：**
```json
{
  "success": true,
  "data": {
    "list": [
      {
        "id": "1",
        "openid": "oXXXXXXXXXXXXX",
        "nickName": "用户昵称",
        "ipAddress": "123.456.789.0",
        "city": "杭州市",
        "province": "浙江省",
        "location": {
          "latitude": 30.123456,
          "longitude": 120.123456
        },
        "status": "blocked",
        "needReview": true,
        "requestTime": "2024-01-01T12:00:00.000Z",
        "reviewTime": null,
        "reviewer": null
      }
    ],
    "total": 100,
    "page": 1,
    "pageSize": 20
  }
}
```

### 3. 审核用户访问权限接口

**接口地址：** `PUT /api/blocked-users/:id/review`

**请求体：**
```json
{
  "action": "approve",  // approve: 批准访问, reject: 拒绝访问
  "reviewer": "管理员名称",
  "remark": "审核备注"
}
```

**响应示例：**
```json
{
  "success": true,
  "message": "审核成功",
  "data": {
    "id": "1",
    "status": "approved",
    "reviewTime": "2024-01-01T13:00:00.000Z",
    "reviewer": "管理员名称"
  }
}
```

### 4. 获取单个用户详情接口

**接口地址：** `GET /api/blocked-users/:id`

**响应示例：**
```json
{
  "success": true,
  "data": {
    "id": "1",
    "openid": "oXXXXXXXXXXXXX",
    "nickName": "用户昵称",
    "avatarUrl": "https://...",
    "ipAddress": "123.456.789.0",
    "location": {
      "latitude": 30.123456,
      "longitude": 120.123456,
      "accuracy": 30
    },
    "city": "杭州市",
    "province": "浙江省",
    "status": "blocked",
    "needReview": true,
    "requestTime": "2024-01-01T12:00:00.000Z",
    "reviewTime": null,
    "reviewer": null,
    "remark": null,
    "mapUrl": "https://apis.map.qq.com/..."
  }
}
```

## 二、数据库设计

### 被拒绝用户表 (blocked_users)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | String | 主键ID |
| openid | String | 用户openid |
| nickName | String | 用户昵称 |
| avatarUrl | String | 头像URL |
| ipAddress | String | IP地址 |
| latitude | Double | 纬度 |
| longitude | Double | 经度 |
| accuracy | Double | 定位精度 |
| city | String | 城市 |
| province | String | 省份 |
| status | String | 状态：blocked(已拒绝), pending(待审核), approved(已批准), rejected(已拒绝) |
| needReview | Boolean | 是否需要审核 |
| requestTime | DateTime | 请求时间 |
| reviewTime | DateTime | 审核时间 |
| reviewer | String | 审核人 |
| remark | String | 审核备注 |
| mapUrl | String | 地图链接 |

## 三、后台管理界面功能

### 1. 用户列表页面
- 显示所有被拒绝的用户
- 支持按城市、状态、时间筛选
- 显示用户基本信息（昵称、IP、位置、时间）
- 支持查看详情
- 支持批量审核

### 2. 用户详情页面
- 显示完整用户信息
- 显示地图位置（使用腾讯地图）
- 显示审核历史
- 支持审核操作（批准/拒绝）
- 支持添加备注

### 3. 审核功能
- 待审核列表
- 一键批准/拒绝
- 批量审核
- 审核记录

## 四、云函数配置

### 1. 修改 sendBlockedUser 云函数

在 `cloudfunctions/sendBlockedUser/index.js` 中，修改以下配置：

```javascript
// 替换为你的后台API地址
const BACKEND_API_URL = 'https://your-backend-api.com/api/blocked-users';
```

### 2. 部署云函数

```bash
# 进入云函数目录
cd cloudfunctions/sendBlockedUser

# 安装依赖
npm install

# 在微信开发者工具中右键云函数目录，选择"上传并部署：云端安装依赖"
```

## 五、安全配置

### 1. API密钥验证

建议在请求头中添加API密钥：

```javascript
headers: {
  'Content-Type': 'application/json',
  'X-API-Key': 'your-secret-api-key'
}
```

### 2. IP白名单（可选）

如果后台部署在固定IP，可以设置IP白名单。

### 3. HTTPS

确保所有API接口使用HTTPS协议。

## 六、测试接口

### 使用 curl 测试

```bash
curl -X POST https://your-backend-api.com/api/blocked-users \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-secret-api-key" \
  -d '{
    "openid": "test_openid",
    "nickName": "测试用户",
    "ipAddress": "123.456.789.0",
    "city": "杭州市",
    "province": "浙江省",
    "location": {
      "latitude": 30.123456,
      "longitude": 120.123456,
      "accuracy": 30
    },
    "status": "blocked",
    "needReview": true
  }'
```

## 七、小程序端配置

### 1. 修改云函数中的后台地址

编辑 `cloudfunctions/sendBlockedUser/index.js`，将 `BACKEND_API_URL` 改为你的后台地址。

### 2. 配置云数据库（可选）

如果需要使用云数据库作为备份，需要在云开发控制台创建 `blocked_users` 集合。

## 八、审核流程

1. **用户访问** → 检测到浙江用户 → 拒绝访问 → 发送数据到后台
2. **后台接收** → 保存到数据库 → 标记为 `needReview: true`
3. **管理员查看** → 在后台管理界面查看待审核列表
4. **审核操作** → 批准或拒绝 → 更新状态
5. **通知用户**（可选）→ 如果批准，可以发送通知让用户重新访问

## 九、注意事项

1. **隐私保护**：确保用户数据安全，遵守相关隐私法规
2. **数据备份**：定期备份数据库
3. **日志记录**：记录所有API调用日志
4. **监控告警**：设置异常监控和告警
5. **性能优化**：如果数据量大，考虑分页和索引优化

## 十、后续扩展

1. **自动审核规则**：可以设置自动审核规则（如特定IP段自动批准）
2. **通知功能**：审核通过后通知用户
3. **统计分析**：统计被拒绝用户的地域分布、时间分布等
4. **白名单功能**：支持添加白名单用户，直接允许访问


