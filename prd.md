## 项目：浙江用户指挥与产品推送小程序

### 1. 背景与目标
- 为运营团队提供一个腾讯小程序，用于动态监控“我一信”用户是否位于浙江重点区县，并在满足条件时触发指挥通知。
- 当用户不在浙江范围内时，提供第二级页面展示产品更新、可视化素材等内容，实现定向营销。

### 2. 核心用户旅程
1. 用户打开小程序 → 允许获取地理位置与昵称。
2. 后端校验位置是否属于浙江指定区县：
   - 是：推送“中关”指挥通知，记录用户信息，并在地图上标出精准经纬度。
   - 否：跳转到产品更新页面，展示最新上新、图文、视频等内容。
3. 管理端可动态上传产品素材与文案，立即在二级页面生效。

### 3. 后端需求
- **身份与权限**：具备腾讯小程序 AppID、服务端密钥，用户同意位置授权后可调用 `wx.getUserProfile` / `wx.getLocation` 等接口。
- **位置判定**：根据经纬度调用腾讯位置服务（逆地理编码）确认是否落在浙江及目标区县列表。
- **通知机制**：对命中浙江的用户，自动推送至“中关”指挥渠道（可选：订阅消息、企业微信 Webhook、短信等，实现方式待定）。
- **数据存储**：保存用户 openid、昵称、经纬度、定位时间与判定结果，便于追溯。
- **地图展示**：为指挥端提供带标记的腾讯地图页面或链接，显示用户精确位置。

### 4. 前端需求
- **首页（浙江判定页）**：
  - 请求定位与昵称授权。
  - 调用后端接口获得判定结果与地图链接。
  - 浙江用户：展示指挥信息、地图标记、相关操作按钮。
- **二级页面（产品推送页）**：
  - 非浙江用户或指挥关闭时跳转。
  - 支持图文/视频内容展示、轮播、按钮跳转。
  - 内容来源于后台配置或小程序管理端上传。

### 5. 前端页面设计（优先落地）
1. **页面结构**
   - `index`（浙江判定页）：顶部为品牌 Banner + 项目介绍；中部为授权组件（昵称/定位授权按钮），授权后展示定位结果和“进入指挥”按钮；底部显示地图卡片及联系方式。
   - `command`（浙江用户指挥页）：显示用户昵称、当前位置、经纬度、上报时间；提供“查看地图”“推送指挥”“刷新定位”操作区；支持展示最近几位浙江用户列表以便运营追踪。
   - `products`（非浙江产品页）：以卡片或瀑布流展示产品上新，可包含轮播图、图文详情、CTA 按钮（预约/咨询/跳转 H5）。支持运营上传封面、标题、标签、描述、跳转链接。
   - `admin-lite`（可选轻后台）：若无需完整 CMS，可在小程序内嵌运营入口，提供简单的内容上传、发布状态开关。
2. **组件与状态**
   - 授权组件：封装昵称/位置授权逻辑，处理授权失败提示与重试。
   - 定位结果组件：展示定位状态（进行中/成功/失败）、行政区划、距离上次刷新时间。
   - 地图卡片：嵌入腾讯地图小程序插件，默认展示用户点位，可扩展显示多点。
   - 产品卡片：支持图像、标题、副标题、标签、CTA 按钮，适应单列或双列布局。
   - 上传组件（若启用 admin-lite）：支持图片上传、富文本或 Markdown 简单编辑。
3. **交互与跳转逻辑**
   - 首次进入时仅展示授权卡片，授权成功后调用接口判断是否为浙江用户，再决定跳转或留在当前页。
   - 对浙江用户：在 `command` 页展示地图卡片 + 操作按钮；非浙江用户：`products` 页默认展示最新产品并允许刷新内容。
   - 页面右上角提供“返回首页”“联系客服”快速入口。
4. **状态管理与缓存**
   - 使用小程序全局状态或轻量状态管理库（如 mobx-miniprogram）缓存用户信息与判定结果，避免多次请求。
   - 将产品列表缓存到本地 Storage，设置 5-10 分钟缓存期，提升非浙江用户体验。
5. **视觉与适配**
   - 设计上采用简洁行政指挥风格，浙江判定页以深色/强调色凸显告警感，产品页采用浅色背景突出内容。
   - 适配 iPhone 全面屏、安全区，使用 `safe-area-inset` 处理底部按钮。

### 5. 运维与安全
- 全程 HTTPS，使用腾讯云或企业自有服务器部署后端。
- 对定位与个人信息进行最小化存储，严格遵守用户隐私合规要求。
- 需有日志与告警，确保通知链路可追踪。

### 6. 腾讯云部署方案（建议）
- **架构概览**：小程序 → API 网关（可选）→ Tencent Cloud Lighthouse/云托管 → 云函数（订阅消息推送）→ 腾讯位置服务 + 数据库（TDSQL-C Serverless 或 MySQL）。
- **计算层**：
  - 轻量应用服务器（Lighthouse）1 核 2G（上海/广州区）约 ¥288/年起，足以支撑低并发场景，可弹性升级。
  - 若想免运维，可选腾讯云云托管或云函数 SCF，仅按调用计费，日常访问量低时成本可控制在几十元/月以内。
- **数据库与存储**：
  - TDSQL-C Serverless 或 CynosDB Serverless，按量付费，记录用户定位日志。
  - COS（对象存储）存放二级页面图文素材或运营上传的多媒体。
- **地图与位置**：
  - 腾讯位置服务（逆地理编码、行政区划）免费额度每日 10 万次，超出后按万次 ¥45 计费。
- **通知链路**：
  - 依据“中关”指挥需要，选用企业微信机器人、订阅消息或短信；以企业微信机器人为例，调用 Webhook 免费，仅需申请机器人并配置密钥。
- **基础运维**：
  - 配置 Cloud Monitor 监控实例 CPU/内存、接口成功率。
  - 日志建议落在 CLS（日志服务），便于审计与追溯。

### 6. 未决问题
1. “中关”指挥通知采用何种具体通道？（需选型并确认所需凭证）
2. 是否需要对浙江内特定区县设置优先级或不同通知模板？
3. 产品更新内容是否需要版本管理、审核流或 CMS？
4. 是否需要多语言支持或仅面向中文用户？
5. 目标上线时间与人力配置？

> 待上述未决条目确认后，可进一步细化开发计划与交付里程碑。

