# 快速开始指南

## 一、小程序端配置

### 1. 部署云函数

#### 部署 getClientIP 云函数
1. 在微信开发者工具中，右键点击 `cloudfunctions/getClientIP` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成

#### 部署 sendBlockedUser 云函数
1. 在微信开发者工具中，右键点击 `cloudfunctions/sendBlockedUser` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成

### 2. 配置云函数环境变量（可选）

如果需要配置后台API地址和密钥：

1. 打开微信开发者工具 → 云开发 → 云函数
2. 找到 `sendBlockedUser` 云函数
3. 点击"配置" → "环境变量"
4. 添加以下环境变量：
   - `BACKEND_API_URL`: 你的后台API地址
   - `BACKEND_API_KEY`: 你的API密钥（可选）

或者直接修改 `cloudfunctions/sendBlockedUser/index.js` 中的配置。

### 3. 配置云数据库（可选）

如果需要使用云数据库作为备份：

1. 打开微信开发者工具 → 云开发 → 数据库
2. 创建集合 `blocked_users`
3. 设置权限为"仅创建者可读写"或根据需求设置

## 二、后台API配置

### 1. 创建后台API接口

根据 `后台配置文档.md` 中的接口规范，创建以下接口：

- `POST /api/blocked-users` - 接收被拒绝用户数据
- `GET /api/blocked-users` - 查询用户列表
- `GET /api/blocked-users/:id` - 获取用户详情
- `PUT /api/blocked-users/:id/review` - 审核用户

### 2. 配置API密钥（可选但推荐）

在后台验证请求头中的 `X-API-Key`，确保只有授权的请求才能访问。

### 3. 配置CORS（如果需要）

如果后台和前端不在同一域名，需要配置CORS允许云函数访问。

### 4. 测试接口

使用 Postman 或 curl 测试接口是否正常工作：

```bash
curl -X POST https://your-backend-api.com/api/blocked-users \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-secret-api-key" \
  -d '{
    "openid": "test",
    "nickName": "测试用户",
    "ipAddress": "123.456.789.0",
    "city": "杭州市",
    "province": "浙江省"
  }'
```

## 三、修改云函数中的后台地址

编辑 `cloudfunctions/sendBlockedUser/index.js`，找到以下代码：

```javascript
const BACKEND_API_URL = process.env.BACKEND_API_URL || 'https://your-backend-api.com/api/blocked-users';
```

将 `https://your-backend-api.com/api/blocked-users` 替换为你的实际后台API地址。

## 四、测试流程

### 1. 测试浙江用户拒绝

1. 使用模拟器或真机，定位设置为浙江省内城市
2. 打开小程序
3. 允许定位授权
4. 应该看到"访问受限"的提示
5. 检查后台是否收到数据

### 2. 测试非浙江用户

1. 定位设置为非浙江省城市（如深圳）
2. 打开小程序
3. 应该正常进入，不会显示拒绝提示

### 3. 检查云数据库（如果配置了）

1. 打开云开发控制台 → 数据库
2. 查看 `blocked_users` 集合
3. 确认数据已保存

## 五、后台管理界面开发建议

### 1. 技术栈建议

- **前端**：Vue.js / React + Element UI / Ant Design
- **后端**：Node.js / Python / Java
- **数据库**：MySQL / PostgreSQL / MongoDB

### 2. 核心功能

1. **用户列表页面**
   - 显示所有被拒绝的用户
   - 支持筛选和搜索
   - 显示待审核数量

2. **用户详情页面**
   - 显示完整信息
   - 地图显示位置
   - 审核操作按钮

3. **审核功能**
   - 一键批准/拒绝
   - 批量审核
   - 审核记录

### 3. 示例代码结构

```
backend/
├── routes/
│   └── blockedUsers.js    # 路由定义
├── controllers/
│   └── blockedUsersController.js  # 控制器
├── models/
│   └── BlockedUser.js     # 数据模型
├── middleware/
│   └── auth.js            # 认证中间件
└── app.js                 # 入口文件
```

## 六、常见问题

### Q1: 云函数调用失败怎么办？

A: 检查以下几点：
1. 云函数是否已正确部署
2. 后台API地址是否正确
3. 后台API是否可访问（检查网络和防火墙）
4. 查看云函数日志排查错误

### Q2: 如何获取真实IP地址？

A: 云函数会自动从上下文获取IP，如果获取不到，可以：
1. 检查云函数日志
2. 使用第三方IP查询服务
3. 在后台记录请求来源IP

### Q3: 如何测试定位功能？

A: 可以使用以下方法：
1. 真机测试：在真实设备上测试
2. 模拟器：修改模拟器的定位设置
3. 开发工具：在微信开发者工具中设置模拟定位

### Q4: 用户拒绝授权定位怎么办？

A: 当前逻辑是：如果用户拒绝定位授权，允许访问。如果需要强制授权，可以：
1. 显示提示要求授权
2. 引导用户到设置中开启定位
3. 使用其他方式判断（如IP地址）

## 七、下一步

1. ✅ 部署云函数
2. ✅ 配置后台API
3. ✅ 测试功能
4. ⏳ 开发后台管理界面
5. ⏳ 配置监控和告警
6. ⏳ 优化用户体验

## 八、技术支持

如有问题，请查看：
- `后台配置文档.md` - 详细的API文档
- 云函数日志 - 排查错误
- 微信开发者工具控制台 - 查看前端日志


